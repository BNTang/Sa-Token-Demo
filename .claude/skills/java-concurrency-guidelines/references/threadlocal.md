# ThreadLocal è§„èŒƒ

> Java å¹¶å‘ç¼–ç¨‹è§„èŒƒ - ThreadLocal çš„åŸç†ã€å¼±å¼•ç”¨æœºåˆ¶ä¸æœ€ä½³å®è·µ

---

## 1. æ ¸å¿ƒè¯­ä¹‰

### 1.1 å››å±‚èƒ½åŠ›æ¨¡å‹

| å±‚çº§ | å†…å®¹ |
|------|------|
| **è¯­ä¹‰å±‚** | ä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›å˜é‡çš„ç‹¬ç«‹å‰¯æœ¬ï¼Œå®ç°çº¿ç¨‹éš”ç¦» |
| **è¡Œä¸ºå±‚** | æ¯ä¸ª Thread å†…éƒ¨æŒæœ‰ ThreadLocalMapï¼ŒKey æ˜¯ ThreadLocal å¯¹è±¡ |
| **å½±å“å±‚** | ç©ºé—´æ¢æ—¶é—´ï¼Œé¿å…é”ç«äº‰ï¼›ä½†éœ€æ‰‹åŠ¨æ¸…ç†ï¼Œå¦åˆ™å†…å­˜æ³„æ¼ |
| **å†³ç­–å±‚** | é€‚ç”¨äºçº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’ï¼ˆç”¨æˆ·ä¿¡æ¯ã€äº‹åŠ¡ã€è¿æ¥ï¼‰ï¼›å¿…é¡»åœ¨ finally ä¸­ remove |

### 1.2 æ˜¯ä»€ä¹ˆ / ä¸æ˜¯ä»€ä¹ˆ

| æ˜¯ä»€ä¹ˆ | ä¸æ˜¯ä»€ä¹ˆ |
|--------|---------|
| çº¿ç¨‹éš”ç¦»çš„å˜é‡å®¹å™¨ | çº¿ç¨‹é—´å…±äº«æ•°æ®çš„æœºåˆ¶ |
| ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ | æ— æˆæœ¬çš„é­”æ³• |
| ä¸Šä¸‹æ–‡ä¼ é€’å·¥å…· | synchronized çš„æ›¿ä»£å“ |

### 1.3 ä¸€å¥è¯å®šä¹‰

> ThreadLocal = æ¯ä¸ªçº¿ç¨‹ä¸€ä»½å‰¯æœ¬ï¼Œäº’ä¸å¹²æ‰°

---

## 2. ç³»ç»Ÿè¡Œä¸º

### 2.1 å­˜å‚¨ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Thread                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ThreadLocalMap                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚          Entry[] table                 â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Key (å¼±å¼•ç”¨) â”‚     Value        â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ThreadLocal â”‚  å®é™…å­˜å‚¨çš„å€¼    â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ–¹æ³•æ‰§è¡Œæµç¨‹

```java
// get() æµç¨‹
Thread t = Thread.currentThread();
ThreadLocalMap map = t.threadLocals;
Entry e = map.getEntry(this);  // this = ThreadLocal å®ä¾‹
return e.value;

// set(T value) æµç¨‹
Thread t = Thread.currentThread();
ThreadLocalMap map = t.threadLocals;
map.set(this, value);  // this = ThreadLocal å®ä¾‹

// remove() æµç¨‹
Thread t = Thread.currentThread();
ThreadLocalMap map = t.threadLocals;
map.remove(this);
```

### 2.3 å“ˆå¸Œå†²çªè§£å†³

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| æ–¹å¼ | å¼€æ”¾åœ°å€æ³•ï¼ˆçº¿æ€§æ¢æµ‹ï¼‰ |
| é­”æ•° | 0x61c88647ï¼ˆé»„é‡‘åˆ†å‰²æ•°ï¼‰ |
| æ•ˆæœ | å‡åŒ€åˆ†å¸ƒï¼Œå‡å°‘å†²çª |

---

## 3. å¼±å¼•ç”¨æœºåˆ¶

### 3.1 ä¸ºä»€ä¹ˆ Key æ˜¯å¼±å¼•ç”¨ï¼Ÿ

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    Object value;  // æ³¨æ„ï¼švalue æ˜¯å¼ºå¼•ç”¨ï¼
    
    Entry(ThreadLocal<?> k, Object v) {
        super(k);  // key æ˜¯å¼±å¼•ç”¨
        value = v;
    }
}
```

| é—®é¢˜ | å¦‚æœ Key æ˜¯å¼ºå¼•ç”¨ | ä½¿ç”¨å¼±å¼•ç”¨ |
|------|------------------|-----------|
| ThreadLocal å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ | å³ä½¿å¤–éƒ¨ä¸å†å¼•ç”¨ï¼ŒEntry ä»æŒæœ‰å¼ºå¼•ç”¨ï¼Œæ— æ³• GC | å¤–éƒ¨æ— å¼•ç”¨æ—¶ï¼ŒKey å¯è¢« GC |
| å†…å­˜æ³„æ¼ | Key æ°¸è¿œæ— æ³•å›æ”¶ | Key å¯å›æ”¶ï¼Œä½† Value ä»å¯èƒ½æ³„æ¼ |

### 3.2 å¼±å¼•ç”¨ä¸èƒ½å®Œå…¨é¿å…å†…å­˜æ³„æ¼

```
ThreadLocal è¢« GC åï¼š

Entry: [Key=null, Value=å¤§å¯¹è±¡]  â† Value ä»ç„¶å­˜åœ¨ï¼
```

| é˜¶æ®µ | Key | Value | é—®é¢˜ |
|------|-----|-------|------|
| æ­£å¸¸ä½¿ç”¨ | ThreadLocal å¼•ç”¨ | å®é™…æ•°æ® | æ—  |
| ThreadLocal è¢« GC | null | å®é™…æ•°æ® | Value æ— æ³•è®¿é—®ä½†å ç”¨å†…å­˜ |
| è°ƒç”¨ set/get/remove | æ¸…ç† key=null çš„ Entry | è¢«æ¸…ç† | é—®é¢˜è§£å†³ |
| çº¿ç¨‹é•¿æœŸå­˜æ´»ä¸è°ƒç”¨ | null | å®é™…æ•°æ® | **å†…å­˜æ³„æ¼ï¼** |

### 3.3 å†…å­˜æ³„æ¼é£é™©åœºæ™¯

| åœºæ™¯ | é£é™© | è¯´æ˜ |
|------|------|------|
| çº¿ç¨‹æ±  | ğŸ”´ é«˜ | çº¿ç¨‹å¤ç”¨ï¼ŒThreadLocalMap ç´¯ç§¯ |
| Web å®¹å™¨ | ğŸ”´ é«˜ | è¯·æ±‚çº¿ç¨‹å¤ç”¨ |
| çŸ­ç”Ÿå‘½å‘¨æœŸçº¿ç¨‹ | ğŸŸ¢ ä½ | çº¿ç¨‹ç»“æŸæ—¶ Map è¢«å›æ”¶ |

---

## 4. å½±å“åˆ†æ

### 4.1 æ­£å‘æ”¶ç›Š

| æ”¶ç›Š | è¯´æ˜ |
|------|------|
| çº¿ç¨‹å®‰å…¨ | å¤©ç„¶éš”ç¦»ï¼Œæ— éœ€åŒæ­¥ |
| æ€§èƒ½ä¼˜å¼‚ | æ— é”æ“ä½œ |
| ä½¿ç”¨ç®€æ´ | get/set/remove ä¸‰æ¿æ–§ |

### 4.2 è´Ÿå‘æˆæœ¬

| æˆæœ¬ | è¯´æ˜ |
|------|------|
| å†…å­˜å ç”¨ | æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä»½å‰¯æœ¬ |
| å†…å­˜æ³„æ¼é£é™© | å¿˜è®° remove ä¼šå¯¼è‡´æ³„æ¼ |
| è°ƒè¯•å›°éš¾ | å€¼è·Ÿéšçº¿ç¨‹ï¼Œä¸æ˜“è¿½è¸ª |
| ç»§æ‰¿é—®é¢˜ | å­çº¿ç¨‹æ— æ³•ç»§æ‰¿çˆ¶çº¿ç¨‹çš„å€¼ï¼ˆéœ€ç”¨ InheritableThreadLocalï¼‰ |

---

## 5. é£é™©è¾¹ç•Œï¼ˆFailure Modesï¼‰

### 5.1 å†…å­˜æ³„æ¼

```java
// âŒ é”™è¯¯ï¼šå¿˜è®° remove
public void doRequest() {
    userContext.set(currentUser);
    processRequest();
    // å¿˜è®° removeï¼Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹å¤ç”¨ï¼Œå€¼ç´¯ç§¯
}

// âœ… æ­£ç¡®ï¼šfinally ä¸­ remove
public void doRequest() {
    try {
        userContext.set(currentUser);
        processRequest();
    } finally {
        userContext.remove();  // å¿…é¡»ï¼
    }
}
```

### 5.2 çº¿ç¨‹æ± ä¸­çš„å€¼æ®‹ç•™

```java
// âŒ å±é™©ï¼šçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹ï¼Œå¯èƒ½è¯»åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„å€¼
ExecutorService pool = Executors.newFixedThreadPool(10);

pool.submit(() -> {
    User user = userContext.get();  // å¯èƒ½æ˜¯ä¸Šä¸€ä¸ªè¯·æ±‚è®¾ç½®çš„å€¼ï¼
    processForUser(user);
});

// âœ… æ­£ç¡®ï¼šæ¯æ¬¡ä½¿ç”¨å‰è®¾ç½®ï¼Œä½¿ç”¨åæ¸…ç†
pool.submit(() -> {
    try {
        userContext.set(currentUser);
        processForUser(userContext.get());
    } finally {
        userContext.remove();
    }
});
```

### 5.3 çˆ¶å­çº¿ç¨‹å€¼ä¼ é€’å¤±è´¥

```java
// âŒ ThreadLocal ä¸ä¼šä¼ é€’åˆ°å­çº¿ç¨‹
ThreadLocal<String> local = new ThreadLocal<>();
local.set("parent");

new Thread(() -> {
    System.out.println(local.get());  // nullï¼Œä¸æ˜¯ "parent"
}).start();

// âœ… ä½¿ç”¨ InheritableThreadLocal
InheritableThreadLocal<String> inheritableLocal = new InheritableThreadLocal<>();
inheritableLocal.set("parent");

new Thread(() -> {
    System.out.println(inheritableLocal.get());  // "parent"
}).start();
```

---

## 6. å†³ç­–è§„åˆ™

### 6.1 é€‚ç”¨æ¡ä»¶

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| ä¸Šä¸‹æ–‡ä¼ é€’ | ç”¨æˆ·ä¿¡æ¯ã€è¯·æ±‚ IDã€äº‹åŠ¡ä¿¡æ¯ |
| çº¿ç¨‹ä¸å®‰å…¨å¯¹è±¡ | SimpleDateFormatã€Random |
| é¿å…å‚æ•°ä¼ é€’ | æ·±å±‚è°ƒç”¨é“¾ä¸­ä¼ é€’ä¸Šä¸‹æ–‡ |

### 6.2 å†³ç­–æ ‘

```
éœ€è¦åœ¨çº¿ç¨‹é—´å…±äº«æ•°æ®å—ï¼Ÿ
â”œâ”€â”€ æ˜¯ â†’ ä¸è¦ç”¨ ThreadLocalï¼Œç”¨å¹¶å‘å®¹å™¨æˆ–é”
â””â”€â”€ å¦ â†’ éœ€è¦çº¿ç¨‹éš”ç¦»å—ï¼Ÿ
          â”œâ”€â”€ æ˜¯ â†’ ThreadLocal
          â”‚       â””â”€â”€ éœ€è¦ä¼ é€’åˆ°å­çº¿ç¨‹å—ï¼Ÿ
          â”‚           â”œâ”€â”€ æ˜¯ â†’ InheritableThreadLocal
          â”‚           â””â”€â”€ å¦ â†’ ThreadLocal
          â””â”€â”€ å¦ â†’ æ™®é€šå˜é‡
```

### 6.3 ç¦ç”¨æ¡ä»¶

| åœºæ™¯ | åŸå›  |
|------|------|
| çº¿ç¨‹é—´é€šä¿¡ | ThreadLocal æ˜¯éš”ç¦»çš„ï¼Œæ— æ³•å…±äº« |
| å­˜å‚¨å¤§å¯¹è±¡ | å†…å­˜å ç”¨å€å¢ |
| ä¸æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ | æ— æ³•ä¿è¯ remove è°ƒç”¨ |

---

## 7. æœ€ä½³å®è·µ

### 7.1 å¿…é¡»éµå®ˆçš„è§„åˆ™

| è§„åˆ™ | å¼ºåº¦ | è¯´æ˜ |
|------|------|------|
| å£°æ˜ä¸º static final | âœ… å¼ºåˆ¶ | é¿å…é‡å¤åˆ›å»º ThreadLocal å®ä¾‹ |
| finally ä¸­ remove | âœ… å¼ºåˆ¶ | é˜²æ­¢å†…å­˜æ³„æ¼ |
| ä½¿ç”¨å‰è®¾ç½®å€¼ | âœ… å¼ºåˆ¶ | é¿å…è¯»åˆ°æ®‹ç•™å€¼ |
| é¿å…å­˜å‚¨å¤§å¯¹è±¡ | âš ï¸ å»ºè®® | å‡å°‘å†…å­˜å ç”¨ |

### 7.2 æ ‡å‡†ä»£ç æ¨¡å¼

```java
public class UserContext {
    // âœ… static finalï¼šå•ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»º
    private static final ThreadLocal<User> USER_HOLDER = new ThreadLocal<>();
    
    // æˆ–ä½¿ç”¨ withInitial æä¾›é»˜è®¤å€¼ï¼ˆJDK 8+ï¼‰
    private static final ThreadLocal<String> REQUEST_ID = 
        ThreadLocal.withInitial(() -> UUID.randomUUID().toString());
    
    public static void setUser(User user) {
        USER_HOLDER.set(user);
    }
    
    public static User getUser() {
        return USER_HOLDER.get();
    }
    
    public static void clear() {
        USER_HOLDER.remove();
        REQUEST_ID.remove();
    }
}

// ä½¿ç”¨æ–¹å¼
public void handleRequest(HttpServletRequest request) {
    try {
        UserContext.setUser(extractUser(request));
        processRequest();
    } finally {
        UserContext.clear();  // å¿…é¡»æ¸…ç†ï¼
    }
}
```

### 7.3 Spring ä¸­çš„ä½¿ç”¨

```java
// âœ… ä½¿ç”¨ RequestContextHolderï¼ˆSpring å·²å°è£…å¥½çš„ ThreadLocalï¼‰
public static User getCurrentUser() {
    HttpServletRequest request = 
        ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes())
        .getRequest();
    return (User) request.getAttribute("user");
}
```

### 7.4 æ¡†æ¶é›†æˆæ£€æŸ¥æ¸…å•

| æ¡†æ¶ | å†…ç½® ThreadLocal | æ³¨æ„äº‹é¡¹ |
|------|-----------------|---------|
| Spring MVC | RequestContextHolder | è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç† |
| Spring Security | SecurityContextHolder | å¼‚æ­¥åœºæ™¯éœ€ç‰¹æ®Šå¤„ç† |
| MyBatis | SqlSession | æ³¨æ„äº‹åŠ¡è¾¹ç•Œ |
| Log4j/Logback | MDC | å¼‚æ­¥æ—¥å¿—éœ€é…ç½®ä¼ é€’ |

---

## 8. InheritableThreadLocal

### 8.1 æ ¸å¿ƒè¯­ä¹‰

| ç‰¹æ€§ | ThreadLocal | InheritableThreadLocal |
|------|-------------|------------------------|
| å­çº¿ç¨‹ç»§æ‰¿ | âŒ ä¸ç»§æ‰¿ | âœ… åˆ›å»ºæ—¶ç»§æ‰¿çˆ¶çº¿ç¨‹çš„å€¼ |
| é€‚ç”¨åœºæ™¯ | å•çº¿ç¨‹ä¸Šä¸‹æ–‡ | éœ€è¦ä¼ é€’åˆ°å­çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ |
| æ³¨æ„äº‹é¡¹ | - | åªåœ¨çº¿ç¨‹åˆ›å»ºæ—¶æ‹·è´ï¼Œåç»­ä¿®æ”¹ä¸åŒæ­¥ |

### 8.2 å±€é™æ€§

| é—®é¢˜ | è¯´æ˜ |
|------|------|
| çº¿ç¨‹æ± ä¸é€‚ç”¨ | çº¿ç¨‹å¤ç”¨æ—¶ä¸ä¼šé‡æ–°ç»§æ‰¿ |
| åªæ˜¯æµ…æ‹·è´ | å¯¹è±¡å¼•ç”¨è¢«å…±äº«ï¼Œä¿®æ”¹ä¼šäº’ç›¸å½±å“ |

### 8.3 çº¿ç¨‹æ± åœºæ™¯æ›¿ä»£æ–¹æ¡ˆ

```java
// ä½¿ç”¨ TransmittableThreadLocalï¼ˆé˜¿é‡Œå¼€æºï¼‰
TransmittableThreadLocal<String> ttl = new TransmittableThreadLocal<>();
ttl.set("value");

// åŒ…è£… Runnable
Runnable task = TtlRunnable.get(() -> {
    System.out.println(ttl.get());  // æ­£ç¡®è·å–åˆ° "value"
});

executorService.submit(task);
```

---

## 9. è®°å¿†é”šç‚¹

| æ¦‚å¿µ | è®°å¿†å¥ï¼ˆâ‰¤20å­—ï¼‰ |
|------|----------------|
| ThreadLocal æœ¬è´¨ | æ¯ä¸ªçº¿ç¨‹ä¸€ä»½ï¼Œäº’ä¸å¹²æ‰° |
| å­˜å‚¨ä½ç½® | å€¼åœ¨ Thread é‡Œï¼Œä¸åœ¨ ThreadLocal é‡Œ |
| å¼±å¼•ç”¨ç›®çš„ | Key å¯å›æ”¶ï¼Œä½† Value ä»è¦æ‰‹åŠ¨æ¸… |
| å†…å­˜æ³„æ¼ | çº¿ç¨‹æ±  + å¿˜è®° remove = å¿…æ³„æ¼ |
| æœ€ä½³å®è·µ | static final + finally remove |
| å­çº¿ç¨‹ä¼ é€’ | InheritableThreadLocal æˆ– TTL |
