# 在 MySQL 中建索引时需要注意哪些事项？

## 索引创建原则

```
┌─────────────────────────────────────────────────────────────┐
│                    索引创建原则                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 选择性高的列优先                                        │
│   2. 常用于查询条件的列                                      │
│   3. 常用于 JOIN、ORDER BY、GROUP BY 的列                   │
│   4. 考虑联合索引                                            │
│   5. 控制索引数量                                            │
│   6. 避免过度索引                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 适合建索引的情况

```
┌─────────────────────────────────────────────────────────────┐
│                    适合建索引                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 主键自动有索引                                          │
│                                                             │
│   2. 频繁作为 WHERE 条件的列                                 │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  SELECT * FROM user WHERE email = ?;                 │  │
│   │  -- email 应该建索引                                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   3. 外键列                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- order 表的 user_id 应该建索引                    │  │
│   │  SELECT * FROM orders o                              │  │
│   │  JOIN user u ON o.user_id = u.id;                    │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   4. 排序和分组的列                                          │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  SELECT * FROM orders ORDER BY create_time DESC;     │  │
│   │  SELECT status, COUNT(*) FROM orders GROUP BY status;│  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   5. 选择性高的列 (区分度高)                                 │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- 选择性 = 不同值数量 / 总行数                     │  │
│   │  -- 选择性越接近 1 越好                              │  │
│   │  SELECT COUNT(DISTINCT column) / COUNT(*) FROM table;│  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 不适合建索引的情况

```
┌─────────────────────────────────────────────────────────────┐
│                    不适合建索引                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 数据量小的表                                            │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- 几百行的配置表，全表扫描更快                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   2. 选择性低的列 (区分度低)                                 │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- 性别：只有 男/女                                 │  │
│   │  -- 状态：只有几个值                                 │  │
│   │  -- 布尔值：0/1                                      │  │
│   │  这些列建索引反而可能降低性能                        │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   3. 频繁更新的列                                            │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- 每次更新都要维护索引                             │  │
│   │  -- update_time 如果频繁更新，建索引开销大           │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   4. 很少用于查询的列                                        │
│                                                             │
│   5. 有大量 NULL 值的列                                      │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- NULL 值不走索引 (取决于存储引擎)                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   6. 大字段 (TEXT, BLOB)                                    │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- 索引占用空间大                                   │  │
│   │  -- 考虑使用前缀索引                                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 联合索引注意事项

```
┌─────────────────────────────────────────────────────────────┐
│                    联合索引                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   最左前缀原则:                                              │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  CREATE INDEX idx_abc ON table (a, b, c);            │  │
│   │                                                     │  │
│   │  ✓ WHERE a = 1                    使用索引           │  │
│   │  ✓ WHERE a = 1 AND b = 2          使用索引           │  │
│   │  ✓ WHERE a = 1 AND b = 2 AND c = 3  使用索引         │  │
│   │  ✓ WHERE a = 1 AND c = 3          只用到 a           │  │
│   │  ✗ WHERE b = 2                    不使用索引         │  │
│   │  ✗ WHERE b = 2 AND c = 3          不使用索引         │  │
│   │  ✗ WHERE c = 3                    不使用索引         │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   列顺序:                                                    │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. 选择性高的列放前面                               │  │
│   │  2. 常用的查询条件放前面                             │  │
│   │  3. 范围查询的列放最后                               │  │
│   │                                                     │  │
│   │  -- 范围查询会导致后续列无法使用索引                 │  │
│   │  WHERE a = 1 AND b > 10 AND c = 3                    │  │
│   │  -- 只能用到 a, b，c 无法使用                        │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 索引失效场景

```
┌─────────────────────────────────────────────────────────────┐
│                    索引失效场景                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 对索引列使用函数                                        │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  ✗ WHERE YEAR(create_time) = 2024                    │  │
│   │  ✓ WHERE create_time >= '2024-01-01'                 │  │
│   │        AND create_time < '2025-01-01'                │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   2. 隐式类型转换                                            │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- phone 是 VARCHAR                                 │  │
│   │  ✗ WHERE phone = 13800138000  (数字)                 │  │
│   │  ✓ WHERE phone = '13800138000'  (字符串)             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   3. LIKE 以 % 开头                                         │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  ✗ WHERE name LIKE '%张'                             │  │
│   │  ✓ WHERE name LIKE '张%'                             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   4. OR 连接非索引列                                         │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- a 有索引，b 无索引                               │  │
│   │  ✗ WHERE a = 1 OR b = 2  (全表扫描)                  │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   5. NOT IN, NOT EXISTS, !=, <>                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- 可能导致全表扫描 (取决于优化器判断)              │  │
│   │  WHERE status != 0                                   │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   6. IS NULL / IS NOT NULL (某些情况)                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 索引优化建议

```
┌─────────────────────────────────────────────────────────────┐
│                    索引优化建议                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 控制索引数量                                            │
│      └── 单表索引不超过 5 个                                │
│                                                             │
│   2. 使用覆盖索引                                            │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- 索引包含所有查询字段，无需回表                   │  │
│   │  CREATE INDEX idx_name_age ON user(name, age);       │  │
│   │  SELECT name, age FROM user WHERE name = 'Tom';      │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   3. 长字符串使用前缀索引                                    │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  CREATE INDEX idx_email ON user(email(20));          │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   4. 定期分析和优化索引                                      │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  EXPLAIN SELECT ...;  -- 分析执行计划                │  │
│   │  SHOW INDEX FROM table;  -- 查看索引                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   5. 删除冗余索引                                            │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  -- idx_a 是 idx_ab 的前缀，冗余                     │  │
│   │  INDEX idx_a (a)                                     │  │
│   │  INDEX idx_ab (a, b)                                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> 建索引注意：1）**适合**：WHERE 条件列、JOIN 列、ORDER BY 列、选择性高的列；2）**不适合**：小表、选择性低的列（性别）、频繁更新的列、大字段；3）**联合索引**：遵循最左前缀，选择性高的放前面，范围查询放最后；4）**避免失效**：不对列用函数、注意类型转换、LIKE 不以 % 开头。

### 1分钟版本

> **适合建索引**：
> - 主键、外键
> - 常用 WHERE 条件
> - JOIN、ORDER BY、GROUP BY 的列
> - 选择性高的列（区分度高）
>
> **不适合建索引**：
> - 数据量小的表
> - 选择性低：性别、状态（只有几个值）
> - 频繁更新的列
> - 很少查询的列
> - TEXT/BLOB 大字段
>
> **联合索引**：
> - 最左前缀原则
> - 选择性高的列放前面
> - 范围查询列放最后
>
> **避免索引失效**：
> - 不对列使用函数
> - 注意隐式类型转换
> - LIKE 不以 % 开头
> - 优先用覆盖索引

---

*关联文档：[mysql-index-types.md](mysql-index-types.md) | [mysql-explain.md](mysql-explain.md)*
