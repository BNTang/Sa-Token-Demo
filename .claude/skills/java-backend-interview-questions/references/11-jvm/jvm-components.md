# JVM 由哪些部分组成？

## JVM 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                       JVM 架构图                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌───────────────────────────────────────────────────┐    │
│   │                  类加载子系统                       │    │
│   │   Bootstrap → Extension → Application ClassLoader  │    │
│   └───────────────────────────────────────────────────┘    │
│                           ↓                                 │
│   ┌───────────────────────────────────────────────────┐    │
│   │                  运行时数据区                       │    │
│   │   ┌─────────────────────┬───────────────────────┐ │    │
│   │   │     线程共享区域     │      线程私有区域      │ │    │
│   │   ├─────────────────────┼───────────────────────┤ │    │
│   │   │   ┌─────────────┐   │   ┌───────────────┐   │ │    │
│   │   │   │   方法区     │   │   │  程序计数器    │   │ │    │
│   │   │   │ (元空间)     │   │   │  (PC Register) │   │ │    │
│   │   │   └─────────────┘   │   └───────────────┘   │ │    │
│   │   │   ┌─────────────┐   │   ┌───────────────┐   │ │    │
│   │   │   │    堆       │   │   │  Java 虚拟机栈 │   │ │    │
│   │   │   │   (Heap)    │   │   │  (JVM Stack)   │   │ │    │
│   │   │   └─────────────┘   │   └───────────────┘   │ │    │
│   │   │                     │   ┌───────────────┐   │ │    │
│   │   │                     │   │  本地方法栈    │   │ │    │
│   │   │                     │   │(Native Stack) │   │ │    │
│   │   │                     │   └───────────────┘   │ │    │
│   │   └─────────────────────┴───────────────────────┘ │    │
│   └───────────────────────────────────────────────────┘    │
│                           ↓                                 │
│   ┌───────────────────────────────────────────────────┐    │
│   │                   执行引擎                         │    │
│   │   解释器 + JIT 编译器 + 垃圾回收器                  │    │
│   └───────────────────────────────────────────────────┘    │
│                           ↓                                 │
│   ┌───────────────────────────────────────────────────┐    │
│   │               本地方法接口 (JNI)                   │    │
│   └───────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 一、类加载子系统

```
┌─────────────────────────────────────────────────────────────┐
│                    类加载器层次                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │           Bootstrap ClassLoader (引导类加载器)       │  │
│   │               加载: JAVA_HOME/lib (rt.jar 等)        │  │
│   │               实现: C++ (HotSpot)                    │  │
│   └─────────────────────────────────────────────────────┘  │
│                           ↓ 父类加载器                       │
│   ┌─────────────────────────────────────────────────────┐  │
│   │           Extension ClassLoader (扩展类加载器)       │  │
│   │               加载: JAVA_HOME/lib/ext                │  │
│   │               Java 9+: PlatformClassLoader          │  │
│   └─────────────────────────────────────────────────────┘  │
│                           ↓ 父类加载器                       │
│   ┌─────────────────────────────────────────────────────┐  │
│   │           Application ClassLoader (应用类加载器)     │  │
│   │               加载: classpath                        │  │
│   │               也叫: SystemClassLoader                │  │
│   └─────────────────────────────────────────────────────┘  │
│                           ↓                                │
│   ┌─────────────────────────────────────────────────────┐  │
│   │           Custom ClassLoader (自定义类加载器)        │  │
│   │               热部署、加密解密、模块隔离              │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   双亲委派模型：                                             │
│   加载类时先委托父加载器 → 父加载器找不到 → 自己加载          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 类加载过程

```
┌─────────────────────────────────────────────────────────────┐
│                    类加载过程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   .class 文件                                               │
│        │                                                    │
│        ▼                                                    │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐                 │
│   │  加载   │ → │  链接   │ → │  初始化  │                 │
│   │ Loading │   │ Linking │   │  Init   │                 │
│   └─────────┘   └─────────┘   └─────────┘                 │
│        │              │              │                      │
│        │              ├─ 验证        │                      │
│        │              ├─ 准备        │                      │
│        │              └─ 解析        │                      │
│        │                             │                      │
│        ▼                             ▼                      │
│   读取字节码                    执行静态代码块               │
│   生成 Class 对象               初始化静态变量               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 二、运行时数据区

### 1. 程序计数器 (PC Register)

```
┌─────────────────────────────────────────────────────────────┐
│                    程序计数器                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   • 线程私有，每个线程独立                                   │
│   • 记录当前线程执行的字节码指令地址                         │
│   • 执行 Native 方法时为 undefined                          │
│   • 唯一不会 OOM 的区域                                      │
│                                                             │
│   作用：                                                     │
│   ┌────────────┐                                            │
│   │ Thread 1   │ PC → 0x0012 (当前执行 invokevirtual)       │
│   │ Thread 2   │ PC → 0x0048 (当前执行 iload_1)             │
│   │ Thread 3   │ PC → native (执行本地方法)                 │
│   └────────────┘                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. Java 虚拟机栈 (JVM Stack)

```
┌─────────────────────────────────────────────────────────────┐
│                    虚拟机栈结构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   • 线程私有，生命周期与线程相同                              │
│   • 每个方法调用创建一个栈帧                                  │
│   • 可能抛出 StackOverflowError 或 OOM                       │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                     虚拟机栈                          │  │
│   │   ┌─────────────────────────────────────────────┐   │  │
│   │   │                 栈帧 (Frame)                 │   │  │
│   │   │   ┌─────────────────────────────────────┐   │   │  │
│   │   │   │          局部变量表                  │   │   │  │
│   │   │   │  (存放方法参数、局部变量)            │   │   │  │
│   │   │   └─────────────────────────────────────┘   │   │  │
│   │   │   ┌─────────────────────────────────────┐   │   │  │
│   │   │   │          操作数栈                    │   │   │  │
│   │   │   │  (执行字节码指令时使用)              │   │   │  │
│   │   │   └─────────────────────────────────────┘   │   │  │
│   │   │   ┌─────────────────────────────────────┐   │   │  │
│   │   │   │        动态链接                      │   │   │  │
│   │   │   │  (指向运行时常量池的方法引用)         │   │   │  │
│   │   │   └─────────────────────────────────────┘   │   │  │
│   │   │   ┌─────────────────────────────────────┐   │   │  │
│   │   │   │        方法返回地址                  │   │   │  │
│   │   │   │  (方法退出后返回的位置)              │   │   │  │
│   │   │   └─────────────────────────────────────┘   │   │  │
│   │   └─────────────────────────────────────────────┘   │  │
│   │                        ↓                             │  │
│   │              更多栈帧 (调用链)                        │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   -Xss: 设置栈大小 (默认 1MB)                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3. 本地方法栈 (Native Method Stack)

```
┌─────────────────────────────────────────────────────────────┐
│                    本地方法栈                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   • 线程私有                                                 │
│   • 为 Native 方法服务                                       │
│   • HotSpot 中与虚拟机栈合二为一                             │
│                                                             │
│   Java 代码 ──调用──> native 方法 ──执行──> C/C++ 代码       │
│                           │                                 │
│                           └── 使用本地方法栈                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4. 堆 (Heap)

```
┌─────────────────────────────────────────────────────────────┐
│                        堆结构                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   • 线程共享，存放对象实例                                   │
│   • GC 的主要区域                                            │
│   • 可能抛出 OOM                                             │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                        堆                            │  │
│   │  ┌───────────────────────────────────────────────┐  │  │
│   │  │               年轻代 (Young Generation)        │  │  │
│   │  │  ┌─────────────┬───────────┬───────────────┐  │  │  │
│   │  │  │    Eden     │    S0     │      S1       │  │  │  │
│   │  │  │   (80%)     │  (10%)    │    (10%)      │  │  │  │
│   │  │  └─────────────┴───────────┴───────────────┘  │  │  │
│   │  │              Minor GC 频繁发生                 │  │  │
│   │  └───────────────────────────────────────────────┘  │  │
│   │  ┌───────────────────────────────────────────────┐  │  │
│   │  │               老年代 (Old Generation)          │  │  │
│   │  │                                               │  │  │
│   │  │         存放长期存活的对象                     │  │  │
│   │  │         Major/Full GC 时回收                  │  │  │
│   │  │                                               │  │  │
│   │  └───────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   -Xms: 初始堆大小   -Xmx: 最大堆大小                        │
│   -Xmn: 年轻代大小   -XX:NewRatio: 老年代/年轻代比例         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5. 方法区 (Method Area) / 元空间 (Metaspace)

```
┌─────────────────────────────────────────────────────────────┐
│                    方法区 / 元空间                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   • 线程共享                                                 │
│   • 存放类元信息、常量、静态变量、JIT 编译代码               │
│                                                             │
│   演进历史：                                                 │
│   ┌─────────────────────────────────────────────────────┐  │
│   │   JDK 7 及之前        │   JDK 8 及之后               │  │
│   ├───────────────────────┼─────────────────────────────┤  │
│   │   永久代 (PermGen)    │   元空间 (Metaspace)         │  │
│   │   堆内存的一部分      │   使用本地内存              │  │
│   │   -XX:PermSize        │   -XX:MetaspaceSize         │  │
│   │   容易 OOM            │   动态扩展，不易 OOM        │  │
│   └───────────────────────┴─────────────────────────────┘  │
│                                                             │
│   方法区包含：                                               │
│   ├── 类信息 (Class metadata)                               │
│   ├── 常量池 (Constant Pool)                                │
│   ├── 静态变量 (Static variables)                           │
│   └── JIT 编译后的代码缓存                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 三、执行引擎

```
┌─────────────────────────────────────────────────────────────┐
│                      执行引擎                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                    解释器                            │  │
│   │   逐行解释执行字节码 → 启动快，执行慢                │  │
│   └─────────────────────────────────────────────────────┘  │
│                           +                                 │
│   ┌─────────────────────────────────────────────────────┐  │
│   │              JIT 编译器 (Just-In-Time)              │  │
│   │   热点代码编译成本地机器码 → 启动慢，执行快          │  │
│   │   ├── C1 编译器 (Client): 快速编译，简单优化        │  │
│   │   └── C2 编译器 (Server): 深度优化，编译慢          │  │
│   └─────────────────────────────────────────────────────┘  │
│                           +                                 │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                  垃圾回收器 (GC)                     │  │
│   │   Serial, Parallel, CMS, G1, ZGC, Shenandoah       │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   混合模式 (-Xmixed): 解释器 + JIT 编译器配合工作            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 四、本地方法接口 (JNI)

```java
// Java 调用本地方法示例
public class NativeExample {
    
    // 声明本地方法
    public native void nativeMethod();
    
    // 加载本地库
    static {
        System.loadLibrary("nativeLib");
    }
    
    public static void main(String[] args) {
        new NativeExample().nativeMethod();
    }
}
```

## 常见 OOM 及对应区域

```
┌─────────────────────────────────────────────────────────────┐
│                  OOM 与内存区域对应                          │
├──────────────────────────┬──────────────────────────────────┤
│   错误信息                │   对应区域                       │
├──────────────────────────┼──────────────────────────────────┤
│   Java heap space        │   堆 (对象太多)                  │
│   GC overhead limit      │   堆 (GC 频繁但回收少)           │
│   Metaspace              │   元空间 (类太多)                │
│   PermGen space (JDK7-)  │   永久代                        │
│   Unable to create thread │   栈 (线程太多)                 │
│   Direct buffer memory   │   直接内存 (NIO)                │
├──────────────────────────┴──────────────────────────────────┤
│   StackOverflowError: 栈溢出 (递归太深)                      │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> JVM 主要由三部分组成：**类加载子系统**（负责加载 Class 文件）、**运行时数据区**（程序计数器、虚拟机栈、本地方法栈、堆、方法区）、**执行引擎**（解释器 + JIT 编译器 + GC）。其中堆和方法区线程共享，栈和程序计数器线程私有。

### 1分钟版本

> **JVM 组成**：
>
> 1. **类加载子系统**：
>    - 加载 .class 文件 → 链接 (验证、准备、解析) → 初始化
>    - 双亲委派：Bootstrap → Extension → Application
>
> 2. **运行时数据区**：
>    - **线程私有**：程序计数器（当前指令地址）、虚拟机栈（栈帧：局部变量表、操作数栈）、本地方法栈
>    - **线程共享**：堆（对象实例，GC 主战场）、方法区/元空间（类信息、常量池）
>
> 3. **执行引擎**：
>    - 解释器：逐行执行，启动快
>    - JIT 编译器：热点代码编译成机器码，执行快
>    - GC：回收堆中无用对象
>
> **JDK 8 变化**：永久代 → 元空间（使用本地内存，不易 OOM）

---

*关联文档：[jvm-gc-tuning.md](jvm-gc-tuning.md) | [jvm-memory-model.md](jvm-memory-model.md) | [classloader.md](classloader.md)*
