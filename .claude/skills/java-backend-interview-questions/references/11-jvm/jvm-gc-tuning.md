# JVM 垃圾回收调优的主要目标是什么？

## 调优目标概览

```
┌─────────────────────────────────────────────────────────────┐
│                    GC 调优核心目标                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 低延迟 (Low Latency)                                   │
│      └── 减少 GC 停顿时间 (STW)                             │
│      └── 适用：交易系统、实时服务                            │
│                                                             │
│   2. 高吞吐量 (High Throughput)                              │
│      └── 最大化应用运行时间占比                              │
│      └── 适用：批处理、数据分析                              │
│                                                             │
│   3. 低内存占用 (Low Memory Footprint)                       │
│      └── 减少堆内存使用                                      │
│      └── 适用：容器环境、边缘计算                            │
│                                                             │
│   注意：三者往往相互制约，需要权衡                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 目标权衡

```
┌─────────────────────────────────────────────────────────────┐
│                    GC 调优三角                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                      低延迟                                  │
│                        △                                    │
│                       /│\                                   │
│                      / │ \                                  │
│                     /  │  \                                 │
│                    /   │   \                                │
│                   /    │    \                               │
│                  /     │     \                              │
│                 /      │      \                             │
│                ────────┼────────                            │
│           高吞吐量     │     低内存占用                       │
│                                                             │
│   • 低延迟 vs 高吞吐量：频繁 GC 减少停顿但降低吞吐            │
│   • 低延迟 vs 低内存：小堆内存导致频繁 GC                     │
│   • 高吞吐量 vs 低内存：大堆提高吞吐但占用更多内存            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 不同场景的调优方向

```
┌─────────────────────────────────────────────────────────────┐
│                  场景与调优目标                              │
├──────────────────┬──────────────────────────────────────────┤
│   应用类型        │   目标与策略                             │
├──────────────────┼──────────────────────────────────────────┤
│   交易/支付系统   │   低延迟优先                             │
│                  │   目标: P99 < 50ms                       │
│                  │   GC: ZGC / Shenandoah                   │
├──────────────────┼──────────────────────────────────────────┤
│   Web 应用       │   均衡                                   │
│                  │   目标: 吞吐 > 95%, P99 < 200ms          │
│                  │   GC: G1                                 │
├──────────────────┼──────────────────────────────────────────┤
│   批处理/大数据   │   高吞吐优先                             │
│                  │   目标: 吞吐 > 99%                        │
│                  │   GC: Parallel                           │
├──────────────────┼──────────────────────────────────────────┤
│   容器/微服务     │   内存优先                               │
│                  │   目标: 内存 < 512MB                      │
│                  │   GC: Serial / G1                        │
└──────────────────┴──────────────────────────────────────────┘
```

## 关键指标

```
┌─────────────────────────────────────────────────────────────┐
│                    GC 关键指标                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. GC 停顿时间 (Pause Time)                               │
│      ├── Minor GC 停顿: 通常 < 50ms                         │
│      ├── Full GC 停顿: 可能 > 1s (需要避免)                 │
│      └── 目标: P99 停顿 < 业务 SLA                          │
│                                                             │
│   2. GC 频率                                                │
│      ├── Minor GC 频率: 越低越好                            │
│      ├── Full GC 频率: 理想情况为 0                         │
│      └── 异常: 每秒多次 GC 说明内存不足                      │
│                                                             │
│   3. 吞吐量                                                 │
│      ├── 公式: 应用运行时间 / (应用运行时间 + GC 时间)       │
│      ├── 目标: > 95% (批处理 > 99%)                         │
│      └── 计算: 如 GC 总耗时 5s / 运行 100s = 吞吐 95%       │
│                                                             │
│   4. 堆内存使用率                                            │
│      ├── 老年代使用率: < 70% 较健康                         │
│      ├── 频繁 Full GC 后使用率仍高: 可能内存泄漏            │
│      └── 持续增长: 排查内存泄漏                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 常用调优参数

### 1. 堆内存参数

```bash
# 堆大小设置
-Xms4g                  # 初始堆大小
-Xmx4g                  # 最大堆大小 (建议 Xms = Xmx 避免动态调整)

# 年轻代设置
-Xmn2g                  # 年轻代大小
-XX:NewRatio=2          # 老年代:年轻代 = 2:1
-XX:SurvivorRatio=8     # Eden:S0:S1 = 8:1:1

# 元空间
-XX:MetaspaceSize=256m  
-XX:MaxMetaspaceSize=256m
```

### 2. GC 选择

```bash
# Serial GC (单线程，小内存)
-XX:+UseSerialGC

# Parallel GC (吞吐量优先)
-XX:+UseParallelGC
-XX:ParallelGCThreads=4

# G1 GC (JDK 9+ 默认，均衡)
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200      # 目标停顿时间
-XX:G1HeapRegionSize=16m      # Region 大小

# ZGC (低延迟，JDK 11+)
-XX:+UseZGC
-XX:ZCollectionInterval=5     # GC 周期间隔

# Shenandoah (低延迟，JDK 12+)
-XX:+UseShenandoahGC
```

### 3. GC 日志

```bash
# JDK 8
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-Xloggc:/var/log/gc.log

# JDK 9+
-Xlog:gc*:file=/var/log/gc.log:time,uptime,level,tags
```

## 调优流程

```
┌─────────────────────────────────────────────────────────────┐
│                    GC 调优流程                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Step 1: 收集数据                                          │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • 开启 GC 日志                                      │  │
│   │  • 监控 GC 停顿时间、频率                            │  │
│   │  • 分析堆内存使用情况                                 │  │
│   │  • 工具: GCViewer, GCEasy, JVisualVM                │  │
│   └─────────────────────────────────────────────────────┘  │
│                           ↓                                 │
│   Step 2: 定位问题                                          │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • Full GC 频繁? → 老年代不足 / 大对象 / 内存泄漏    │  │
│   │  • Minor GC 频繁? → 年轻代太小                       │  │
│   │  • 停顿时间长? → GC 算法不合适                       │  │
│   │  • 吞吐量低? → 堆太小 / GC 太频繁                    │  │
│   └─────────────────────────────────────────────────────┘  │
│                           ↓                                 │
│   Step 3: 调整参数                                          │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • 调整堆大小和比例                                  │  │
│   │  • 选择合适的 GC 算法                                │  │
│   │  • 设置 GC 目标参数                                  │  │
│   └─────────────────────────────────────────────────────┘  │
│                           ↓                                 │
│   Step 4: 验证效果                                          │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • 压测验证                                          │  │
│   │  • 对比调优前后指标                                  │  │
│   │  • 持续监控                                          │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 常见问题与解决

```
┌─────────────────────────────────────────────────────────────┐
│                  常见 GC 问题与解决                          │
├──────────────────────────┬──────────────────────────────────┤
│   问题                    │   解决方案                       │
├──────────────────────────┼──────────────────────────────────┤
│   Full GC 频繁            │   增大老年代或堆大小              │
│                          │   排查大对象直接进入老年代         │
│                          │   检查内存泄漏                    │
├──────────────────────────┼──────────────────────────────────┤
│   Minor GC 过于频繁       │   增大年轻代                      │
│                          │   调整 Eden/Survivor 比例         │
├──────────────────────────┼──────────────────────────────────┤
│   GC 停顿时间长           │   换用低延迟 GC (G1/ZGC)         │
│                          │   减小堆大小 (权衡)               │
│                          │   增加 GC 线程                    │
├──────────────────────────┼──────────────────────────────────┤
│   OOM: Heap space         │   增大 -Xmx                      │
│                          │   排查内存泄漏 (MAT)              │
├──────────────────────────┼──────────────────────────────────┤
│   OOM: Metaspace          │   增大 MetaspaceSize             │
│                          │   排查类加载问题                  │
├──────────────────────────┼──────────────────────────────────┤
│   吞吐量低                │   增大堆减少 GC 频率              │
│                          │   使用 Parallel GC                │
└──────────────────────────┴──────────────────────────────────┘
```

## 实战调优示例

```bash
# 场景：电商 Web 应用，4 核 8G 服务器

# 初始配置 (存在问题)
java -Xms2g -Xmx2g -XX:+UseParallelGC -jar app.jar
# 问题：Full GC 停顿 500ms+，P99 延迟 800ms

# 优化后配置
java \
  -Xms4g -Xmx4g \                       # 增大堆
  -XX:+UseG1GC \                        # 换用 G1
  -XX:MaxGCPauseMillis=100 \            # 目标停顿 100ms
  -XX:G1HeapRegionSize=16m \            # Region 16MB
  -XX:InitiatingHeapOccupancyPercent=45 \ # 45% 触发并发标记
  -Xlog:gc*:file=/var/log/gc.log:time \
  -jar app.jar

# 效果：P99 停顿 < 100ms，P99 延迟 < 200ms
```

## 面试回答

### 30秒版本

> GC 调优三大目标：**低延迟**（减少停顿时间）、**高吞吐量**（应用运行时间占比高）、**低内存占用**。三者相互制约，需根据场景权衡。交易系统用 ZGC 追求低延迟；批处理用 Parallel GC 追求高吞吐；Web 应用用 G1 均衡。

### 1分钟版本

> **调优目标**：
> - **低延迟**：减少 STW 时间，适合交易系统（P99 < 50ms）
> - **高吞吐量**：应用时间 / 总时间 > 95%，适合批处理
> - **低内存**：容器环境内存受限
>
> **关键指标**：
> - GC 停顿时间（Minor/Full）
> - GC 频率（Full GC 应该极少）
> - 吞吐量（> 95%）
> - 堆使用率（老年代 < 70%）
>
> **调优流程**：
> 1. 收集 GC 日志
> 2. 定位问题（频繁 Full GC? 停顿长?）
> 3. 调整参数（堆大小、GC 算法）
> 4. 验证效果
>
> **GC 选择**：
> - 低延迟：ZGC / Shenandoah
> - 均衡：G1（JDK 9+ 默认）
> - 高吞吐：Parallel GC

---

*关联文档：[jvm-components.md](jvm-components.md) | [jvm-gc-algorithms.md](jvm-gc-algorithms.md) | [jvm-memory-model.md](jvm-memory-model.md)*
