# Java 中常见的垃圾收集器有哪些？

## 垃圾收集器概览

```
┌─────────────────────────────────────────────────────────────┐
│                    JVM 垃圾收集器                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   按代划分:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │   年轻代                │        老年代              │  │
│   ├─────────────────────────┼────────────────────────────┤  │
│   │   Serial                │        Serial Old          │  │
│   │   ParNew                │        CMS                 │  │
│   │   Parallel Scavenge     │        Parallel Old        │  │
│   └─────────────────────────┴────────────────────────────┘  │
│                                                             │
│   不分代:                                                    │
│   ┌─────────────────────────────────────────────────────┐  │
│   │   G1    │    ZGC    │    Shenandoah                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   JDK 版本默认 GC:                                           │
│   • JDK 8: Parallel Scavenge + Parallel Old                │
│   • JDK 9+: G1                                             │
│   • JDK 15+: ZGC 可用 (JDK 21 默认仍是 G1)                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 一、Serial / Serial Old

```
┌─────────────────────────────────────────────────────────────┐
│                    Serial 收集器                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 单线程，Stop-The-World                               │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │   应用线程   ════════════════════════════════════   │  │
│   │   应用线程   ════════════════════════════════════   │  │
│   │   应用线程   ═════╗         ╔══════════════════════   │  │
│   │                   ║  停顿   ║                        │  │
│   │   GC 线程         ╠═════════╣                        │  │
│   │                   (单线程GC)                          │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   算法:                                                     │
│   • Serial (年轻代): 复制算法                               │
│   • Serial Old (老年代): 标记-整理算法                      │
│                                                             │
│   适用场景:                                                  │
│   • 单核 CPU / 小内存 (几十到一两百 MB)                     │
│   • Client 模式 JVM                                        │
│                                                             │
│   参数: -XX:+UseSerialGC                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 二、Parallel Scavenge / Parallel Old

```
┌─────────────────────────────────────────────────────────────┐
│                    Parallel 收集器                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 多线程并行，吞吐量优先                               │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │   应用线程   ═════════════════════════════════════   │  │
│   │   应用线程   ═══════╗           ╔═════════════════   │  │
│   │   应用线程   ═══════╣   停顿    ╠═════════════════   │  │
│   │                     ║           ║                    │  │
│   │   GC 线程 1         ╠═══════════╣                    │  │
│   │   GC 线程 2         ╠═══════════╣                    │  │
│   │   GC 线程 N         ╠═══════════╣  (多线程并行GC)    │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   算法:                                                     │
│   • Parallel Scavenge (年轻代): 复制算法                    │
│   • Parallel Old (老年代): 标记-整理算法                    │
│                                                             │
│   特色功能:                                                  │
│   • 自适应调节 (-XX:+UseAdaptiveSizePolicy)                 │
│   • 可控制吞吐量 (-XX:GCTimeRatio=99, GC时间占1%)           │
│   • 可控制最大停顿 (-XX:MaxGCPauseMillis=100)               │
│                                                             │
│   适用场景:                                                  │
│   • 后台计算型任务                                          │
│   • 对吞吐量要求高，延迟要求不高                            │
│                                                             │
│   参数: -XX:+UseParallelGC                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 三、CMS (Concurrent Mark Sweep)

```
┌─────────────────────────────────────────────────────────────┐
│                    CMS 收集器                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 并发收集，低停顿                                     │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                                                     │  │
│   │   阶段1: 初始标记 (STW, 很短)                        │  │
│   │          仅标记 GC Roots 直接关联的对象              │  │
│   │                                                     │  │
│   │   阶段2: 并发标记 (并发, 最长)                       │  │
│   │          遍历对象图，与应用线程同时运行              │  │
│   │                                                     │  │
│   │   阶段3: 重新标记 (STW, 较短)                        │  │
│   │          修正并发标记期间的变化                      │  │
│   │                                                     │  │
│   │   阶段4: 并发清除 (并发)                             │  │
│   │          清除垃圾对象，与应用线程同时运行            │  │
│   │                                                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   算法: 标记-清除 (会产生碎片)                              │
│                                                             │
│   缺点:                                                     │
│   • 内存碎片                                                │
│   • CPU 敏感 (并发阶段占用 CPU)                             │
│   • 浮动垃圾 (并发清除期间新产生的垃圾)                     │
│   • Concurrent Mode Failure 风险                            │
│                                                             │
│   参数: -XX:+UseConcMarkSweepGC (JDK 14 已废弃)             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 四、G1 (Garbage First)

```
┌─────────────────────────────────────────────────────────────┐
│                    G1 收集器                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 区域化分代，可预测停顿                               │
│                                                             │
│   内存布局 (Region):                                         │
│   ┌───┬───┬───┬───┬───┬───┬───┬───┐                       │
│   │ E │ E │ S │ O │ O │ O │ H │ H │                       │
│   ├───┼───┼───┼───┼───┼───┼───┼───┤                       │
│   │ O │ O │ E │ E │   │   │ O │ O │                       │
│   ├───┼───┼───┼───┼───┼───┼───┼───┤                       │
│   │ E │ S │ O │ O │ H │ H │ H │   │                       │
│   └───┴───┴───┴───┴───┴───┴───┴───┘                       │
│   E=Eden  S=Survivor  O=Old  H=Humongous (大对象)           │
│                                                             │
│   工作流程:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │   1. 初始标记 (STW): 标记 GC Roots                   │  │
│   │   2. 并发标记: 遍历对象图                            │  │
│   │   3. 最终标记 (STW): 处理 SATB 记录                  │  │
│   │   4. 筛选回收 (STW): 选择 Region 回收                │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   特色功能:                                                  │
│   • 可预测停顿 (-XX:MaxGCPauseMillis=200)                  │
│   • 优先回收垃圾最多的 Region (Garbage First)              │
│   • 大对象不进入老年代，直接分配 Humongous Region          │
│                                                             │
│   适用场景:                                                  │
│   • 堆内存 4G+                                              │
│   • 需要可控的 GC 停顿时间                                  │
│                                                             │
│   参数: -XX:+UseG1GC                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 五、ZGC

```
┌─────────────────────────────────────────────────────────────┐
│                    ZGC 收集器                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 极低延迟 (< 1ms)，大堆支持 (TB级)                    │
│                                                             │
│   核心技术:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │   1. 着色指针 (Colored Pointers)                     │  │
│   │      在指针中存储 GC 状态信息                        │  │
│   │      ┌────────────────────────────────────────────┐ │  │
│   │      │ 颜色位 │          地址位 (42bit)            │ │  │
│   │      │ 4bit   │                                    │ │  │
│   │      └────────────────────────────────────────────┘ │  │
│   │                                                     │  │
│   │   2. 读屏障 (Load Barrier)                          │  │
│   │      每次读取对象时检查并修复指针                    │  │
│   │                                                     │  │
│   │   3. 并发整理 (Concurrent Compaction)               │  │
│   │      移动对象时应用线程可继续运行                    │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   停顿时间:                                                  │
│   • 停顿 < 1ms，与堆大小无关                               │
│   • 仅在 GC Roots 扫描时有极短停顿                         │
│                                                             │
│   适用场景:                                                  │
│   • 超大堆 (8MB - 16TB)                                    │
│   • 极端低延迟要求 (交易系统)                              │
│                                                             │
│   参数: -XX:+UseZGC (JDK 11+)                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 六、Shenandoah

```
┌─────────────────────────────────────────────────────────────┐
│                    Shenandoah 收集器                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 低延迟，与 ZGC 类似但实现不同                        │
│                                                             │
│   核心技术:                                                  │
│   • Brooks Pointer (转发指针)                               │
│   • 读写屏障 (比 ZGC 多写屏障)                              │
│   • 并发整理                                                │
│                                                             │
│   与 ZGC 区别:                                               │
│   ┌────────────────┬─────────────────┬──────────────────┐  │
│   │    特性        │      ZGC        │   Shenandoah     │  │
│   ├────────────────┼─────────────────┼──────────────────┤  │
│   │   实现方式     │  着色指针+读屏障 │ 转发指针+读写屏障│  │
│   │   来源        │  Oracle         │  Red Hat         │  │
│   │   JDK 支持    │  Oracle JDK     │  OpenJDK         │  │
│   │   停顿        │  < 1ms          │  < 10ms          │  │
│   └────────────────┴─────────────────┴──────────────────┘  │
│                                                             │
│   参数: -XX:+UseShenandoahGC (OpenJDK 12+)                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 收集器对比总结

```
┌─────────────────────────────────────────────────────────────┐
│                    收集器选型指南                            │
├────────────┬────────────┬────────────┬──────────────────────┤
│   收集器    │  停顿时间  │  吞吐量    │  适用场景            │
├────────────┼────────────┼────────────┼──────────────────────┤
│   Serial   │   长       │  低        │ 单核/小内存/Client   │
│   Parallel │   中       │  高        │ 后台计算/吞吐优先    │
│   CMS      │   较短     │  中        │ Web应用/响应优先     │
│   G1       │   可控     │  中高      │ 大堆/平衡延迟吞吐    │
│   ZGC      │   极短<1ms │  中        │ 超大堆/极端低延迟    │
│ Shenandoah │   短<10ms  │  中        │ 大堆/低延迟          │
├────────────┴────────────┴────────────┴──────────────────────┤
│                                                             │
│   选型建议:                                                  │
│   • 堆 < 1G: Serial / Parallel                              │
│   • 堆 1-4G: CMS / G1                                       │
│   • 堆 4-16G: G1                                            │
│   • 堆 > 16G: ZGC / Shenandoah                              │
│   • 延迟敏感: ZGC                                           │
│   • 吞吐优先: Parallel                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> Java 常见 GC：1）**Serial**：单线程，小内存；2）**Parallel**：多线程并行，吞吐量优先，JDK8 默认；3）**CMS**：并发标记清除，低停顿（已废弃）；4）**G1**：Region 分区，可控停顿，JDK9+ 默认；5）**ZGC**：着色指针，停顿 < 1ms，支持 TB 级堆。

### 1分钟版本

> **常见垃圾收集器**：
>
> 1. **Serial/Serial Old**
>    - 单线程，复制+标记整理
>    - 适用：单核、小内存
>
> 2. **Parallel Scavenge/Parallel Old**
>    - 多线程并行，吞吐量优先
>    - JDK 8 默认，适合后台计算
>
> 3. **CMS**
>    - 并发标记清除，4 阶段
>    - 低停顿，但有碎片问题（已废弃）
>
> 4. **G1**
>    - Region 分区，不分代物理隔离
>    - 可预测停顿（-XX:MaxGCPauseMillis）
>    - JDK 9+ 默认，适合大堆
>
> 5. **ZGC**
>    - 着色指针 + 读屏障
>    - 停顿 < 1ms，支持 TB 级堆
>    - 极端低延迟场景
>
> **选型**：吞吐优先用 Parallel，延迟优先用 G1/ZGC，默认选 G1。

---

*关联文档：[jvm-gc-algorithms.md](jvm-gc-algorithms.md) | [jvm-gc-tuning.md](jvm-gc-tuning.md) | [jvm-parameters.md](jvm-parameters.md)*
