# 从输入网址到页面显示的全过程

> 分类: 网络协议 | 难度: ⭐⭐⭐⭐ | 频率: 高频

---

## 一、整体流程概览

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                    从输入网址到页面显示的完整流程                                    │
├────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                    │
│  用户输入: https://www.example.com/index.html                                      │
│                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │ 1. URL 解析                                                                  │   │
│  │    ↓                                                                        │   │
│  │ 2. DNS 解析 (域名 → IP)                                                      │   │
│  │    ↓                                                                        │   │
│  │ 3. TCP 三次握手 (建立连接)                                                   │   │
│  │    ↓                                                                        │   │
│  │ 4. TLS 握手 (HTTPS 加密通道)                                                 │   │
│  │    ↓                                                                        │   │
│  │ 5. HTTP 请求/响应                                                            │   │
│  │    ↓                                                                        │   │
│  │ 6. 浏览器解析渲染                                                            │   │
│  │    ↓                                                                        │   │
│  │ 7. TCP 四次挥手 (关闭连接)                                                   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、详细步骤分析

### 2.1 URL 解析

```
输入: https://www.example.com:443/path/page.html?id=1#section

┌────────────────────────────────────────────────────────────────┐
│                       URL 组成部分                              │
├─────────────┬──────────────────────────────────────────────────┤
│  协议       │  https://                                         │
│  域名       │  www.example.com                                  │
│  端口       │  443 (HTTPS默认端口，可省略)                       │
│  路径       │  /path/page.html                                  │
│  查询参数   │  ?id=1                                            │
│  片段标识   │  #section                                         │
└─────────────┴──────────────────────────────────────────────────┘

浏览器处理:
1. 判断是 URL 还是搜索关键词
2. 补全协议(http/https)
3. 检查 HSTS 列表，强制 HTTPS
4. 编码特殊字符
```

### 2.2 DNS 解析

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          DNS 解析流程                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  www.example.com → 93.184.216.34                                               │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 浏览器缓存 (Chrome: chrome://net-internals/#dns)                      │   │
│  │    ↓ 未命中                                                             │   │
│  │ 2. 操作系统缓存 (hosts文件, DNS缓存)                                     │   │
│  │    ↓ 未命中                                                             │   │
│  │ 3. 路由器缓存                                                            │   │
│  │    ↓ 未命中                                                             │   │
│  │ 4. ISP DNS服务器 (递归查询)                                              │   │
│  │    ↓ 未命中                                                             │   │
│  │ 5. 根域名服务器 → .com顶级域 → example.com权威服务器                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  迭代查询过程:                                                                  │
│  ┌───────┐     ┌───────┐     ┌───────┐     ┌─────────────┐                     │
│  │ 根DNS │ ──→ │ .com  │ ──→ │example│ ──→ │ 93.184.216.34│                    │
│  │       │     │ DNS   │     │.com   │     │ (最终IP)     │                    │
│  └───────┘     └───────┘     └───────┘     └─────────────┘                     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 TCP 三次握手

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TCP 三次握手                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│     客户端                                              服务器                  │
│        │                                                   │                    │
│        │  ──────── SYN seq=x ────────────────────────────→ │                    │
│        │           (请求建立连接)                           │                    │
│        │                                                   │                    │
│        │  ←──────── SYN+ACK seq=y, ack=x+1 ────────────── │                    │
│        │           (同意连接，确认收到)                     │                    │
│        │                                                   │                    │
│        │  ──────── ACK ack=y+1 ───────────────────────────→│                    │
│        │           (确认收到，连接建立)                     │                    │
│        │                                                   │                    │
│     ┌──┴──┐                                           ┌──┴──┐                  │
│     │已连接│                                           │已连接│                  │
│     └─────┘                                           └─────┘                  │
│                                                                                 │
│  为什么需要三次?                                                                │
│  - 两次: 服务器无法确认客户端是否收到响应                                        │
│  - 三次: 双方都确认了对方的发送和接收能力                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 TLS 握手 (HTTPS)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TLS 1.3 握手 (1-RTT)                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│     客户端                                              服务器                  │
│        │                                                   │                    │
│        │  ─────── ClientHello ─────────────────────────→   │                    │
│        │          支持的加密套件、随机数                    │                    │
│        │          客户端密钥分享(KeyShare)                  │                    │
│        │                                                   │                    │
│        │  ←────── ServerHello + 证书 + Finished ────────   │                    │
│        │          服务器选择的加密套件                       │                    │
│        │          服务器证书(验证身份)                       │                    │
│        │          服务器密钥分享                            │                    │
│        │                                                   │                    │
│        │  ─────── Finished ─────────────────────────────→  │                    │
│        │          (加密开始)                                │                    │
│        │                                                   │                    │
│     ┌──┴──────────────────────────────────────────────────┴──┐                  │
│     │                   加密通道已建立                         │                  │
│     └─────────────────────────────────────────────────────────┘                  │
│                                                                                 │
│  证书验证:                                                                      │
│  1. 验证证书签名(CA链)                                                          │
│  2. 检查证书有效期                                                              │
│  3. 检查域名是否匹配                                                            │
│  4. 检查证书吊销状态(OCSP)                                                      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.5 HTTP 请求/响应

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           HTTP 请求/响应                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  请求报文:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ GET /index.html HTTP/1.1                                                 │   │
│  │ Host: www.example.com                                                    │   │
│  │ User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)                   │   │
│  │ Accept: text/html,application/xhtml+xml                                  │   │
│  │ Accept-Encoding: gzip, deflate, br                                       │   │
│  │ Accept-Language: zh-CN,zh;q=0.9                                          │   │
│  │ Connection: keep-alive                                                   │   │
│  │ Cookie: session_id=abc123                                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  服务器处理:                                                                    │
│  1. 接收请求 → 2. 路由分发 → 3. 业务处理 → 4. 返回响应                         │
│                                                                                 │
│  响应报文:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ HTTP/1.1 200 OK                                                          │   │
│  │ Content-Type: text/html; charset=UTF-8                                   │   │
│  │ Content-Length: 1256                                                     │   │
│  │ Content-Encoding: gzip                                                   │   │
│  │ Cache-Control: max-age=3600                                              │   │
│  │ Set-Cookie: session_id=xyz789; HttpOnly; Secure                          │   │
│  │                                                                          │   │
│  │ <!DOCTYPE html><html>...</html>                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.6 浏览器解析渲染

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           浏览器渲染流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                          │   │
│  │  HTML ──→ DOM Tree ──────────────────────────────────┐                   │   │
│  │                                                      ↓                   │   │
│  │  CSS ───→ CSSOM ─────→ Render Tree ──→ Layout ──→ Paint ──→ Composite   │   │
│  │                           ↑           (布局)     (绘制)    (合成)        │   │
│  │  JS ────→ 执行 ───────────┘                                              │   │
│  │                                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  详细步骤:                                                                      │
│  1. 解析HTML → 构建DOM树                                                        │
│  2. 解析CSS → 构建CSSOM树                                                       │
│  3. 执行JavaScript (可能修改DOM/CSSOM)                                          │
│  4. 合并DOM+CSSOM → Render Tree                                                 │
│  5. Layout: 计算每个元素的位置和大小                                             │
│  6. Paint: 绘制元素到各个图层                                                   │
│  7. Composite: 合成图层显示到屏幕                                               │
│                                                                                 │
│  阻塞问题:                                                                      │
│  - CSS 阻塞渲染 (需等CSSOM构建完成)                                              │
│  - JS 阻塞DOM解析 (除非async/defer)                                             │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.7 TCP 四次挥手

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           TCP 四次挥手                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│     客户端                                              服务器                  │
│        │                                                   │                    │
│        │  ──────── FIN ──────────────────────────────────→ │                    │
│        │           (请求关闭连接)                           │                    │
│        │                                                   │                    │
│        │  ←──────── ACK ─────────────────────────────────  │                    │
│        │           (确认收到)                               │                    │
│        │                                                   │                    │
│        │  ←──────── FIN ─────────────────────────────────  │                    │
│        │           (服务器也关闭)                           │                    │
│        │                                                   │                    │
│        │  ──────── ACK ──────────────────────────────────→ │                    │
│        │           (确认收到)                               │                    │
│        │                                                   │                    │
│     ┌──┴──┐                                           ┌──┴──┐                  │
│     │TIME │  ← 等待2MSL →                             │已关闭│                  │
│     │WAIT │                                                                     │
│     └──┬──┘                                                                     │
│     ┌──┴──┐                                                                     │
│     │已关闭│                                                                    │
│     └─────┘                                                                     │
│                                                                                 │
│  为什么需要四次?                                                                │
│  - TCP是全双工，需要双方各自关闭发送通道                                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、性能优化点

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          各阶段优化策略                                           │
├─────────────────┬────────────────────────────────────────────────────────────────┤
│   DNS 解析      │  - DNS 预解析 <link rel="dns-prefetch">                        │
│                 │  - 减少域名数量(域名收敛)                                       │
│                 │  - 使用 CDN                                                    │
├─────────────────┼────────────────────────────────────────────────────────────────┤
│   TCP 连接      │  - HTTP/2 多路复用(减少连接数)                                  │
│                 │  - Keep-Alive 复用连接                                         │
│                 │  - TCP Fast Open                                               │
├─────────────────┼────────────────────────────────────────────────────────────────┤
│   TLS 握手      │  - TLS 1.3 (1-RTT)                                             │
│                 │  - Session Resumption                                          │
│                 │  - OCSP Stapling                                               │
├─────────────────┼────────────────────────────────────────────────────────────────┤
│   HTTP 传输     │  - Gzip/Brotli 压缩                                            │
│                 │  - 资源合并与内联                                              │
│                 │  - HTTP 缓存策略                                               │
├─────────────────┼────────────────────────────────────────────────────────────────┤
│   浏览器渲染    │  - CSS 放头部、JS 放底部                                        │
│                 │  - async/defer 异步加载 JS                                     │
│                 │  - 图片懒加载                                                  │
│                 │  - Critical CSS                                                │
└─────────────────┴────────────────────────────────────────────────────────────────┘
```

---

## 四、面试回答

### 30秒版本

> 主要经过7个步骤：
> 1. **URL 解析**：提取协议、域名、路径
> 2. **DNS 解析**：域名转IP（浏览器缓存→系统缓存→DNS服务器）
> 3. **TCP 三次握手**：建立连接
> 4. **TLS 握手**：建立加密通道（HTTPS）
> 5. **HTTP 请求响应**：发送请求，接收HTML
> 6. **浏览器渲染**：解析HTML/CSS/JS，构建渲染树，绘制页面
> 7. **TCP 四次挥手**：关闭连接

### 1分钟版本

> 完整流程涵盖**网络层面**和**浏览器层面**：
>
> **网络层面：**
> 1. URL 解析，提取域名和路径
> 2. DNS 解析，按顺序查询：浏览器缓存 → 系统缓存 → 路由器缓存 → DNS 服务器
> 3. 获取 IP 后，TCP 三次握手建立连接
> 4. HTTPS 需要 TLS 握手，交换证书建立加密通道
> 5. 发送 HTTP 请求，服务器返回 HTML
>
> **浏览器层面：**
> 1. 解析 HTML 构建 DOM 树
> 2. 解析 CSS 构建 CSSOM 树
> 3. 执行 JavaScript
> 4. 合并生成渲染树(Render Tree)
> 5. 布局(Layout)计算元素位置
> 6. 绘制(Paint)并合成(Composite)显示
>
> 最后 TCP 四次挥手关闭连接（或 Keep-Alive 复用）。

---

## 五、相关 Java 代码

### 5.1 模拟 HTTP 请求

```java
/**
 * 使用 HttpClient 发起请求
 */
public class HttpRequestExample {
    
    public static void main(String[] args) throws Exception {
        // Java 11+ HttpClient
        HttpClient client = HttpClient.newBuilder()
            .version(HttpClient.Version.HTTP_2)
            .connectTimeout(Duration.ofSeconds(10))
            .build();
        
        HttpRequest request = HttpRequest.newBuilder()
            .uri(URI.create("https://www.example.com/index.html"))
            .header("User-Agent", "Java HttpClient")
            .GET()
            .build();
        
        HttpResponse<String> response = client.send(request, 
            HttpResponse.BodyHandlers.ofString());
        
        System.out.println("Status: " + response.statusCode());
        System.out.println("Body: " + response.body());
    }
}
```

### 5.2 DNS 解析示例

```java
/**
 * Java DNS 解析
 */
public class DnsLookupExample {
    
    public static void main(String[] args) throws Exception {
        // 获取域名的所有IP地址
        InetAddress[] addresses = InetAddress.getAllByName("www.example.com");
        
        for (InetAddress addr : addresses) {
            System.out.println("IP: " + addr.getHostAddress());
        }
        
        // 反向解析
        InetAddress addr = InetAddress.getByName("93.184.216.34");
        System.out.println("Hostname: " + addr.getHostName());
    }
}
```
