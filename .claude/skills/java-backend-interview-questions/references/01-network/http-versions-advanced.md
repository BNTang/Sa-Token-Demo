# HTTP/2.0 和 HTTP/3.0 有什么区别？

## 核心对比

```
┌─────────────────────────────────────────────────────────────┐
│                  HTTP/2 vs HTTP/3 对比                       │
├──────────────────┬─────────────────┬────────────────────────┤
│   特性            │   HTTP/2         │   HTTP/3              │
├──────────────────┼─────────────────┼────────────────────────┤
│   传输层协议      │   TCP            │   QUIC (基于 UDP)      │
│   多路复用        │   ✅ 有队头阻塞   │   ✅ 无队头阻塞        │
│   连接建立        │   TCP 三次握手   │   0-RTT / 1-RTT       │
│   TLS 集成        │   可选 TLS       │   内置 TLS 1.3        │
│   丢包影响        │   所有流阻塞     │   只影响单个流         │
│   连接迁移        │   ❌ 不支持      │   ✅ 支持 (Connection ID) │
│   头部压缩        │   HPACK          │   QPACK               │
│   标准化时间      │   2015 (RFC 7540) │   2022 (RFC 9000)     │
└──────────────────┴─────────────────┴────────────────────────┘
```

## HTTP/2 的局限性

```
┌─────────────────────────────────────────────────────────────┐
│                  HTTP/2 队头阻塞问题                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   HTTP/2 在 TCP 层的问题：                                   │
│                                                             │
│   Stream 1: ──────┐                                         │
│   Stream 2: ──────┼─── TCP 连接 ─── 丢包 ─── 重传等待        │
│   Stream 3: ──────┘          ↓                              │
│                           所有流都被阻塞！                   │
│                                                             │
│   原因：TCP 保证有序交付，一个包丢失，后续包必须等待重传      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## HTTP/3 解决方案 (QUIC)

```
┌─────────────────────────────────────────────────────────────┐
│                  HTTP/3 QUIC 协议                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                   HTTP/3                            │  │
│   ├─────────────────────────────────────────────────────┤  │
│   │                    QUIC                             │  │
│   │  ┌─────────┬─────────┬─────────┬─────────────────┐  │  │
│   │  │ 多路复用 │ 可靠传输 │ 拥塞控制 │ 连接迁移/0-RTT │  │  │
│   │  └─────────┴─────────┴─────────┴─────────────────┘  │  │
│   │  ┌──────────────────────────────────────────────┐   │  │
│   │  │              TLS 1.3 (内置)                   │   │  │
│   │  └──────────────────────────────────────────────┘   │  │
│   ├─────────────────────────────────────────────────────┤  │
│   │                     UDP                             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   QUIC = Quick UDP Internet Connections                     │
│   • 在 UDP 上实现可靠传输                                    │
│   • 每个流独立，丢包只影响该流                               │
│   • 内置加密，首次 1-RTT，重连 0-RTT                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 详细特性对比

### 1. 多路复用与队头阻塞

```
HTTP/2 (TCP):
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   Client ─────── TCP Connection ─────── Server              │
│           [Stream 1][Stream 2][Stream 3]                    │
│                      ↓ 丢包                                  │
│           [Stream 1][  等待  ][  等待  ]  ← 全部阻塞         │
│                                                             │
└─────────────────────────────────────────────────────────────┘

HTTP/3 (QUIC):
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   Client ─────── QUIC Connection ─────── Server             │
│           [Stream 1] ─────────→ 正常                        │
│           [Stream 2] ─── 丢包 ─→ 只影响 Stream 2            │
│           [Stream 3] ─────────→ 正常                        │
│                                                             │
│   每个流独立处理丢包重传！                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. 连接建立时间

```
┌─────────────────────────────────────────────────────────────┐
│                    连接建立对比                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   HTTP/2 + TLS 1.2:                                         │
│   ┌────────────────────────────────────────────────────┐   │
│   │  TCP 三次握手 (1.5 RTT) + TLS 握手 (2 RTT)          │   │
│   │  = 3.5 RTT 才能发送第一个 HTTP 请求                  │   │
│   └────────────────────────────────────────────────────┘   │
│                                                             │
│   HTTP/3 (QUIC + TLS 1.3):                                  │
│   ┌────────────────────────────────────────────────────┐   │
│   │  首次连接: 1 RTT (QUIC + TLS 握手合并)              │   │
│   │  重连: 0 RTT (会话恢复，立即发送数据)                │   │
│   └────────────────────────────────────────────────────┘   │
│                                                             │
│   RTT (Round-Trip Time): 往返延迟                           │
│   移动网络 RTT 可能 100ms+，3.5 RTT 意味着 350ms 延迟        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```
# HTTP/2 + TLS 1.2 握手过程
Client                                    Server
  │                                          │
  │ ──────── TCP SYN ─────────────────────→  │
  │ ←─────── TCP SYN-ACK ─────────────────   │  1.5 RTT (TCP)
  │ ──────── TCP ACK ─────────────────────→  │
  │                                          │
  │ ──────── TLS ClientHello ─────────────→  │
  │ ←─────── TLS ServerHello ─────────────   │  2 RTT (TLS)
  │ ──────── TLS Finished ────────────────→  │
  │                                          │
  │ ──────── HTTP Request ────────────────→  │  开始传输
  │                                          │

# HTTP/3 (QUIC) 首次握手
Client                                    Server
  │                                          │
  │ ──── QUIC Initial + TLS ClientHello ──→  │
  │ ←─── QUIC Handshake + TLS ServerHello ─  │  1 RTT
  │ ──── QUIC Handshake + HTTP Request ───→  │
  │                                          │

# HTTP/3 (QUIC) 0-RTT 重连
Client                                    Server
  │                                          │
  │ ──── QUIC 0-RTT + HTTP Request ───────→  │  0 RTT!
  │ ←─── HTTP Response ───────────────────   │
  │                                          │
```

### 3. 连接迁移

```
┌─────────────────────────────────────────────────────────────┐
│                      连接迁移                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   HTTP/2 (TCP):                                             │
│   ┌──────────────────────────────────────────────────────┐ │
│   │  TCP 连接 = (源IP, 源端口, 目的IP, 目的端口)           │ │
│   │                                                      │ │
│   │  WiFi ──────────────┐                               │ │
│   │  192.168.1.10:12345 │ ← 切换 → 断开！需要重新建连     │ │
│   │                     │                               │ │
│   │  4G ────────────────┘                               │ │
│   │  10.20.30.40:54321  ← 新 IP，新连接                  │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
│   HTTP/3 (QUIC):                                            │
│   ┌──────────────────────────────────────────────────────┐ │
│   │  QUIC 连接 = Connection ID (64 位随机数)              │ │
│   │                                                      │ │
│   │  WiFi ──────────────┐                               │ │
│   │  192.168.1.10:12345 │ ← 切换 → 连接保持！            │ │
│   │  Connection ID: A1B2│                               │ │
│   │                     │                               │ │
│   │  4G ────────────────┘                               │ │
│   │  10.20.30.40:54321  │ Connection ID 相同，无感切换   │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
│   移动场景：WiFi/4G/5G 切换时连接不断，用户体验更好          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4. 头部压缩

```
┌─────────────────────────────────────────────────────────────┐
│                    头部压缩对比                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   HTTP/2 - HPACK:                                           │
│   • 静态表 (61 个常用头) + 动态表                            │
│   • Huffman 编码                                            │
│   • 依赖 TCP 有序交付维护动态表状态                          │
│                                                             │
│   HTTP/3 - QPACK:                                           │
│   • 与 HPACK 类似，针对 QUIC 优化                           │
│   • 独立的编码/解码流                                        │
│   • 解决 QUIC 乱序到达时的动态表同步问题                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 性能对比

```
┌─────────────────────────────────────────────────────────────┐
│                      性能场景对比                            │
├──────────────────────────┬──────────────────────────────────┤
│   场景                    │   HTTP/3 优势                    │
├──────────────────────────┼──────────────────────────────────┤
│   高丢包网络 (>2%)        │   显著优势，流独立不阻塞          │
│   高延迟网络 (卫星等)      │   0-RTT 减少等待                 │
│   移动网络切换            │   连接迁移，无感切换              │
│   低丢包稳定网络          │   差异不大，TCP 够用              │
│   短连接场景              │   0-RTT 优势明显                 │
│   长连接稳定传输          │   优势不明显                     │
└──────────────────────────┴──────────────────────────────────┘
```

## 部署现状

```
┌─────────────────────────────────────────────────────────────┐
│                      HTTP/3 部署情况                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   支持情况 (2024):                                           │
│   • Chrome、Firefox、Safari、Edge 均支持                    │
│   • Cloudflare、Google Cloud、AWS CloudFront 支持           │
│   • Nginx 1.25+、Caddy 2.0+ 支持                            │
│   • 约 30% 的网站已启用 HTTP/3                               │
│                                                             │
│   挑战:                                                      │
│   • 部分防火墙/NAT 阻止 UDP 443                              │
│   • 运维调试工具不如 TCP 成熟                                 │
│   • CPU 开销略高 (加密+用户态实现)                           │
│                                                             │
│   配置示例 (Nginx):                                          │
│   server {                                                  │
│       listen 443 ssl;                                       │
│       listen 443 quic reuseport;  # HTTP/3                  │
│       http2 on;                                             │
│       http3 on;                                             │
│       add_header Alt-Svc 'h3=":443"';                       │
│   }                                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> HTTP/3 最大改变是底层从 **TCP 换成 QUIC（基于 UDP）**。核心优势：1）**解决队头阻塞**——流独立，丢包只影响单个流；2）**更快建连**——首次 1-RTT，重连 0-RTT；3）**连接迁移**——基于 Connection ID，切换网络不断连。适合高丢包、高延迟、移动网络场景。

### 1分钟版本

> **HTTP/2 的问题**：虽然应用层多路复用，但 TCP 层仍存在队头阻塞——一个包丢失，所有流都要等待重传。
>
> **HTTP/3 的解决方案**：
> 1. **QUIC 协议**：在 UDP 上实现可靠传输，每个流独立处理丢包
> 2. **0-RTT 建连**：内置 TLS 1.3，首次 1-RTT，重连 0-RTT（HTTP/2 需要 3.5 RTT）
> 3. **连接迁移**：使用 Connection ID 标识连接，WiFi/4G 切换不断连
> 4. **内置加密**：TLS 1.3 是必须的，更安全
>
> **适用场景**：高丢包网络（>2%）、移动网络、短连接场景收益明显；低丢包稳定网络差异不大。
>
> **部署情况**：主流浏览器和 CDN 已支持，约 30% 网站启用。挑战是部分防火墙阻止 UDP 443、调试工具不够成熟。

---

*关联文档：[http-versions.md](http-versions.md) | [tcp-connection.md](tcp-connection.md)*
