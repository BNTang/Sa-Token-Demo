# 线程与进程的区别

> 分类: 操作系统 | 难度: ⭐⭐ | 频率: 高频

---

## 一、核心概念

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          进程 vs 线程                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                          进程 (Process)                                   │   │
│  │  ────────────────────────────────────────────────────────────────────    │   │
│  │  定义: 操作系统资源分配的基本单位                                         │   │
│  │  特点: 拥有独立的地址空间、内存、文件句柄等资源                           │   │
│  │  举例: 一个运行的程序就是一个进程(Chrome、IDEA、JVM)                      │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                          线程 (Thread)                                    │   │
│  │  ────────────────────────────────────────────────────────────────────    │   │
│  │  定义: CPU调度的基本单位                                                  │   │
│  │  特点: 共享进程的资源，有自己独立的栈和程序计数器                         │   │
│  │  举例: 一个进程可以有多个线程并发执行任务                                 │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  关系: 一个进程至少有一个线程(主线程)，可以有多个线程                            │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、结构对比

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          内存结构对比                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  进程结构:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │                          进程 A                                             ││
│  │  ┌─────────────────────────────────────────────────────────────────────┐   ││
│  │  │                      独立地址空间                                    │   ││
│  │  ├────────────┬────────────┬────────────┬────────────┬────────────────┤   ││
│  │  │    代码段   │   数据段    │    堆      │   共享库   │     栈         │   ││
│  │  │   (Code)   │   (Data)   │   (Heap)   │  (Libs)    │   (Stack)      │   ││
│  │  └────────────┴────────────┴────────────┴────────────┴────────────────┘   ││
│  │  └─────── 进程独有，其他进程无法直接访问 ────────────────────────────────┘   ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                  │
│  线程结构:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │                          进程 B                                             ││
│  │  ┌─────────────────────────────────────────────────────────────────────┐   ││
│  │  │                 共享资源 (代码段、数据段、堆、文件句柄)                │   ││
│  │  └─────────────────────────────────────────────────────────────────────┘   ││
│  │                                                                             ││
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐               ││
│  │  │  线程1     │  │  线程2     │  │  线程3     │  │  线程4     │               ││
│  │  │ ───────── │  │ ───────── │  │ ───────── │  │ ───────── │               ││
│  │  │ 独立栈    │  │ 独立栈     │  │ 独立栈     │  │ 独立栈     │               ││
│  │  │ 程序计数器 │  │ 程序计数器 │  │ 程序计数器 │  │ 程序计数器 │               ││
│  │  │ 寄存器状态 │  │ 寄存器状态 │  │ 寄存器状态 │  │ 寄存器状态 │               ││
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘               ││
│  │                                                                             ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、详细对比

```
┌────────────────────────────────────────────────────────────────────────────────────┐
│                            进程 vs 线程 详细对比                                    │
├─────────────────┬──────────────────────────────┬───────────────────────────────────┤
│    对比维度     │           进程                │            线程                   │
├─────────────────┼──────────────────────────────┼───────────────────────────────────┤
│    定义        │  资源分配的基本单位            │  CPU调度的基本单位                │
│    地址空间    │  独立的虚拟地址空间            │  共享所属进程的地址空间           │
│    资源拥有    │  拥有独立资源(内存、文件等)    │  共享进程资源，只有少量独立资源   │
│    独立资源    │  代码段、数据段、堆、栈、文件  │  栈、程序计数器、寄存器           │
│    创建开销    │  大(需分配独立资源)            │  小(只需分配栈等少量资源)         │
│    切换开销    │  大(需切换页表、刷新TLB)       │  小(共享地址空间，无需切换页表)   │
│    通信方式    │  IPC(管道、信号、共享内存等)   │  直接读写共享变量                 │
│    安全性      │  一个进程崩溃不影响其他进程    │  一个线程崩溃可能导致整个进程崩溃 │
│    并发能力    │  可跨CPU核心并行              │  可跨CPU核心并行                   │
└─────────────────┴──────────────────────────────┴───────────────────────────────────┘
```

---

## 四、Java 中的进程与线程

### 4.1 创建进程

```java
/**
 * Java 创建进程示例
 */
public class ProcessExample {
    
    public static void main(String[] args) throws Exception {
        // 方式1: Runtime.exec()
        Process process1 = Runtime.getRuntime().exec("notepad.exe");
        
        // 方式2: ProcessBuilder (推荐)
        ProcessBuilder builder = new ProcessBuilder("ping", "localhost");
        builder.redirectErrorStream(true);
        Process process2 = builder.start();
        
        // 读取进程输出
        try (BufferedReader reader = new BufferedReader(
                new InputStreamReader(process2.getInputStream()))) {
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
        }
        
        // 等待进程结束
        int exitCode = process2.waitFor();
        System.out.println("Exit code: " + exitCode);
    }
}
```

### 4.2 创建线程

```java
/**
 * Java 创建线程的几种方式
 */
public class ThreadExample {
    
    public static void main(String[] args) {
        // 方式1: 继承 Thread
        Thread t1 = new MyThread();
        t1.start();
        
        // 方式2: 实现 Runnable
        Thread t2 = new Thread(new MyRunnable());
        t2.start();
        
        // 方式3: Lambda 表达式
        Thread t3 = new Thread(() -> {
            System.out.println("Lambda thread: " + Thread.currentThread().getName());
        });
        t3.start();
        
        // 方式4: 线程池 (推荐)
        ExecutorService executor = Executors.newFixedThreadPool(4);
        executor.submit(() -> {
            System.out.println("Pool thread: " + Thread.currentThread().getName());
        });
        executor.shutdown();
    }
    
    static class MyThread extends Thread {
        @Override
        public void run() {
            System.out.println("MyThread: " + getName());
        }
    }
    
    static class MyRunnable implements Runnable {
        @Override
        public void run() {
            System.out.println("MyRunnable: " + Thread.currentThread().getName());
        }
    }
}
```

### 4.3 JVM 中的线程

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          JVM 进程中的线程                                         │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   JVM 进程                                                                       │
│   ┌────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                            │ │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │ │
│   │  │   main   │  │   GC     │  │ Finalizer│  │ Compiler │  │  用户    │    │ │
│   │  │   线程   │  │  线程    │  │   线程   │  │   线程   │  │  线程    │    │ │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │ │
│   │                                                                            │ │
│   │  共享: 堆内存、方法区、常量池、类信息                                       │ │
│   │  独立: 虚拟机栈、本地方法栈、程序计数器                                     │ │
│   │                                                                            │ │
│   └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、上下文切换

### 5.1 进程上下文切换

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          进程上下文切换                                           │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   进程A运行 → 中断/系统调用 → 保存进程A上下文 → 加载进程B上下文 → 进程B运行       │
│                                                                                  │
│   需要切换的内容:                                                                │
│   ┌────────────────────────────────────────────────────────────────────────────┐ │
│   │  1. 页表基地址 (切换虚拟地址空间)                                          │ │
│   │  2. 内核栈                                                                 │ │
│   │  3. 硬件上下文 (寄存器、程序计数器等)                                       │ │
│   │  4. 刷新 TLB (Translation Lookaside Buffer)                                │ │
│   └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│   开销大的原因: 需要切换整个地址空间，刷新 CPU 缓存                               │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 线程上下文切换

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          线程上下文切换                                           │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   同一进程内:                                                                    │
│   线程A运行 → 中断 → 保存线程A上下文 → 加载线程B上下文 → 线程B运行               │
│                                                                                  │
│   需要切换的内容:                                                                │
│   ┌────────────────────────────────────────────────────────────────────────────┐ │
│   │  1. 程序计数器 (PC)                                                        │ │
│   │  2. 寄存器状态                                                             │ │
│   │  3. 栈指针                                                                 │ │
│   └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│   开销小的原因: 共享地址空间，无需切换页表和刷新TLB                               │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、进程间通信 vs 线程间通信

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          通信方式对比                                             │
├───────────────────────┬────────────────────────────────────────────────────────┤
│   进程间通信 (IPC)    │   线程间通信                                             │
├───────────────────────┼────────────────────────────────────────────────────────┤
│   管道 (Pipe)         │   共享变量                                               │
│   命名管道 (FIFO)     │   synchronized/Lock                                     │
│   消息队列            │   wait()/notify()                                       │
│   共享内存            │   Condition                                             │
│   信号量 (Semaphore)  │   BlockingQueue                                         │
│   信号 (Signal)       │   CountDownLatch/CyclicBarrier                          │
│   Socket              │   volatile                                              │
└───────────────────────┴────────────────────────────────────────────────────────┘
```

---

## 七、面试回答

### 30秒版本

> **进程**是资源分配的基本单位，拥有独立的地址空间和资源；**线程**是 CPU 调度的基本单位，共享所属进程的资源。
>
> 区别：
> 1. 进程有独立内存空间，线程共享进程内存
> 2. 进程切换开销大，线程切换开销小
> 3. 进程间通信需要 IPC，线程直接读写共享变量
> 4. 一个线程崩溃可能导致整个进程崩溃

### 1分钟版本

> **定义：**
> - 进程是程序的一次执行，是操作系统资源分配的基本单位
> - 线程是进程中的执行单元，是 CPU 调度的基本单位
>
> **资源分配：**
> - 进程拥有独立的地址空间、代码段、数据段、堆、栈、文件句柄
> - 线程共享进程的资源，只有栈、程序计数器、寄存器是独立的
>
> **开销对比：**
> - 进程创建/销毁开销大，需要分配/回收独立资源
> - 线程创建/销毁开销小，只需分配栈空间
> - 进程切换需要切换页表、刷新 TLB；线程切换只需保存/恢复寄存器
>
> **安全性：**
> - 进程间相互隔离，一个进程崩溃不影响其他进程
> - 线程共享内存，一个线程崩溃可能导致整个进程崩溃

---

## 八、延伸：协程

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          协程 (Coroutine)                                         │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  定义: 用户态的轻量级线程，由程序自己调度                                         │
│                                                                                  │
│  ┌──────────────┬──────────────┬──────────────┐                                  │
│  │    进程      │    线程      │    协程      │                                  │
│  ├──────────────┼──────────────┼──────────────┤                                  │
│  │  操作系统管理 │  操作系统调度 │  用户态调度  │                                  │
│  │  MB级内存    │  MB级内存    │  KB级内存    │                                  │
│  │  切换慢      │  切换较慢    │  切换极快    │                                  │
│  │  独立地址空间 │  共享地址空间 │  共享地址空间 │                                  │
│  └──────────────┴──────────────┴──────────────┘                                  │
│                                                                                  │
│  Java 中的协程:                                                                  │
│  - Java 19+: Virtual Threads (虚拟线程)                                          │
│  - Kotlin: Coroutines                                                            │
│  - Quasar/Loom 项目                                                              │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

```java
// Java 21 虚拟线程示例
public class VirtualThreadExample {
    public static void main(String[] args) {
        // 创建虚拟线程
        Thread vt = Thread.ofVirtual().start(() -> {
            System.out.println("Virtual thread: " + Thread.currentThread());
        });
        
        // 虚拟线程执行器
        try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
            for (int i = 0; i < 10000; i++) {
                executor.submit(() -> {
                    // 可以创建大量虚拟线程
                    Thread.sleep(1000);
                    return null;
                });
            }
        }
    }
}
```
