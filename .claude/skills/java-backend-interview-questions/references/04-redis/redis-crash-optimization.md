# 线上发现 Redis 机器爆了，如何优化？

## 问题排查流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Redis 机器爆了排查流程                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 确认问题类型                                            │
│      ├── 内存爆了 (OOM)                                     │
│      ├── CPU 爆了                                           │
│      └── 连接数爆了                                         │
│                                                             │
│   2. 紧急处理                                                │
│      ├── 如果是主节点，考虑切换到从节点                     │
│      ├── 限流降级                                           │
│      └── 扩容                                               │
│                                                             │
│   3. 定位原因                                                │
│                                                             │
│   4. 根本解决                                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 内存爆了 (最常见)

### 排查命令

```bash
# 查看内存使用情况
redis-cli INFO memory

# 关键指标:
# used_memory: 已使用内存
# used_memory_peak: 峰值内存
# maxmemory: 最大内存限制
# mem_fragmentation_ratio: 内存碎片率

# 查看 Key 数量和类型分布
redis-cli INFO keyspace

# 扫描大 Key
redis-cli --bigkeys

# 更精确的大 Key 扫描 (线上慎用)
redis-cli DEBUG OBJECT <key>
```

### 常见原因和解决方案

```
┌─────────────────────────────────────────────────────────────┐
│                    内存问题原因与解决                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 大 Key 问题                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  原因: 单个 Key 存储数据过大                         │  │
│   │  排查: redis-cli --bigkeys                           │  │
│   │  解决:                                               │  │
│   │  • Hash/List/Set 拆分成多个小 Key                    │  │
│   │  • String 大 Value 压缩或拆分                        │  │
│   │  • 设置合理的过期时间                                │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   2. Key 数量过多                                            │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  原因: 缓存没有过期、业务数据堆积                    │  │
│   │  解决:                                               │  │
│   │  • 检查 TTL 设置                                     │  │
│   │  • 清理无用 Key                                      │  │
│   │  • 设置 maxmemory-policy                             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   3. 内存碎片                                                │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  检查: mem_fragmentation_ratio > 1.5 说明碎片多      │  │
│   │  解决:                                               │  │
│   │  • Redis 4.0+ 开启内存碎片整理                       │  │
│   │  • config set activedefrag yes                       │  │
│   │  • 重启 Redis (不推荐)                               │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   4. 未设置 maxmemory                                        │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  解决: 设置合理的内存上限                            │  │
│   │  config set maxmemory 4gb                            │  │
│   │  config set maxmemory-policy allkeys-lru             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## CPU 爆了

```
┌─────────────────────────────────────────────────────────────┐
│                    CPU 问题排查                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 慢查询                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  排查: SLOWLOG GET 10                                │  │
│   │  常见问题:                                           │  │
│   │  • KEYS *                                            │  │
│   │  • 大 Key 的 HGETALL, SMEMBERS, LRANGE              │  │
│   │  • 复杂 Lua 脚本                                     │  │
│   │  解决:                                               │  │
│   │  • 禁用 KEYS，用 SCAN 代替                           │  │
│   │  • 分批获取大集合                                    │  │
│   │  • 优化 Lua 脚本                                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   2. 高 QPS                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  排查: redis-cli INFO stats                          │  │
│   │  解决:                                               │  │
│   │  • 读写分离 (从节点读)                               │  │
│   │  • 集群分片                                          │  │
│   │  • 本地缓存                                          │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   3. 持久化影响                                              │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  排查: INFO persistence                              │  │
│   │  问题: BGSAVE/BGREWRITEAOF fork 阻塞                 │  │
│   │  解决:                                               │  │
│   │  • 调整持久化策略                                    │  │
│   │  • 在从节点做持久化                                  │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 连接数爆了

```
┌─────────────────────────────────────────────────────────────┐
│                    连接数问题                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   排查:                                                      │
│   redis-cli INFO clients                                    │
│   redis-cli CLIENT LIST                                     │
│                                                             │
│   常见原因:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. 连接池配置不当                                   │  │
│   │     • 最大连接数过大                                 │  │
│   │     • 连接未正确归还                                 │  │
│   │                                                     │  │
│   │  2. 连接泄漏                                         │  │
│   │     • 使用后未关闭                                   │  │
│   │     • 异常时未释放                                   │  │
│   │                                                     │  │
│   │  3. 客户端实例过多                                   │  │
│   │     • 应该单例使用 Redis 客户端                      │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   解决:                                                      │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. 调整 maxclients                                  │  │
│   │     config set maxclients 10000                      │  │
│   │                                                     │  │
│   │  2. 优化连接池配置                                   │  │
│   │     spring.redis.lettuce.pool.max-active=50          │  │
│   │     spring.redis.lettuce.pool.max-idle=20            │  │
│   │                                                     │  │
│   │  3. 设置超时                                         │  │
│   │     config set timeout 300  # 空闲连接超时           │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 优化方案总结

```
┌─────────────────────────────────────────────────────────────┐
│                    优化方案总结                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   内存优化:                                                  │
│   1. 拆分大 Key                                              │
│   2. 设置合理 TTL                                            │
│   3. 选择合适的数据结构                                      │
│   4. 开启内存淘汰策略                                        │
│   5. 定期清理无用数据                                        │
│                                                             │
│   CPU 优化:                                                  │
│   1. 避免慢查询 (KEYS, 大集合遍历)                          │
│   2. 读写分离                                                │
│   3. 集群分片                                                │
│   4. 本地缓存 + Redis 多级缓存                              │
│                                                             │
│   连接数优化:                                                │
│   1. 使用连接池                                              │
│   2. 合理配置连接池参数                                      │
│   3. 单例使用客户端                                          │
│                                                             │
│   架构优化:                                                  │
│   1. 主从复制 + 哨兵                                        │
│   2. Redis Cluster 集群                                     │
│   3. 多级缓存 (本地 + Redis)                                │
│   4. 热点 Key 本地缓存                                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> Redis 机器爆了先确定问题类型：1）**内存爆**：`--bigkeys` 找大 Key，拆分或加 TTL，设置 maxmemory 和淘汰策略；2）**CPU 爆**：`SLOWLOG` 查慢查询，禁用 KEYS，读写分离；3）**连接数爆**：检查连接池配置，客户端单例，设置超时。长期方案：集群分片、多级缓存。

### 1分钟版本

> **排查步骤**：
>
> 1. **确定问题类型**：
>    - `INFO memory` 看内存
>    - `INFO stats` 看 QPS
>    - `INFO clients` 看连接数
>
> 2. **内存问题**：
>    - `--bigkeys` 找大 Key
>    - 大 Key 拆分
>    - 设置 maxmemory + 淘汰策略
>    - 检查 TTL 设置
>    - 开启碎片整理
>
> 3. **CPU 问题**：
>    - `SLOWLOG` 查慢查询
>    - 禁用 KEYS，用 SCAN
>    - 大集合分批读取
>    - 读写分离
>
> 4. **连接数问题**：
>    - 使用连接池
>    - 合理配置 max-active
>    - 设置空闲超时
>
> **长期优化**：
> - Redis Cluster 分片
> - 本地缓存 + Redis 多级缓存
> - 热点 Key 本地化

---

*关联文档：[redis-oom.md](redis-oom.md) | [redis-hotkey.md](redis-hotkey.md) | [redis-bigkey.md](redis-bigkey.md)*
