# Redis 的持久化机制有哪些？

## 持久化概述

```
┌─────────────────────────────────────────────────────────────┐
│                    Redis 持久化方式                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                       RDB                           │  │
│   │               (Redis DataBase)                       │  │
│   │                                                     │  │
│   │   • 定时生成内存快照                                 │  │
│   │   • 二进制文件，体积小                               │  │
│   │   • 恢复速度快                                       │  │
│   │   • 可能丢失最后一次快照后的数据                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                       AOF                           │  │
│   │            (Append Only File)                        │  │
│   │                                                     │  │
│   │   • 记录每条写命令                                   │  │
│   │   • 文本文件，可读性好                               │  │
│   │   • 数据更安全（可配置每秒同步）                     │  │
│   │   • 文件体积大，恢复较慢                             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                   混合持久化                         │  │
│   │             (RDB + AOF, Redis 4.0+)                  │  │
│   │                                                     │  │
│   │   • RDB 做全量备份                                   │  │
│   │   • AOF 记录增量命令                                 │  │
│   │   • 结合两者优点                                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 一、RDB 持久化

### 工作原理

```
┌─────────────────────────────────────────────────────────────┐
│                    RDB 工作原理                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   触发时机:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. 手动触发: SAVE / BGSAVE                         │  │
│   │  2. 配置触发: save 900 1 (900秒内1次修改)           │  │
│   │  3. 关闭触发: shutdown 时自动保存                    │  │
│   │  4. 主从复制: 主节点执行 BGSAVE 发送给从节点         │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   BGSAVE 流程 (后台保存):                                    │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  Redis 主进程                                       │  │
│   │      │                                              │  │
│   │      │ fork()                                       │  │
│   │      ▼                                              │  │
│   │  ┌────────────┐                                     │  │
│   │  │  子进程    │ ──→ 写入 RDB 文件                   │  │
│   │  └────────────┘     (dump.rdb)                      │  │
│   │      ↑                                              │  │
│   │  Copy-On-Write                                      │  │
│   │  (写时复制)                                          │  │
│   │                                                     │  │
│   │  主进程继续处理客户端请求                            │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   文件格式:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  REDIS │ 版本 │ DB选择器 │ Key-Value对 │ EOF │ 校验 │  │
│   │   5B   │  4B  │   ...    │    ...      │ 1B  │  8B  │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 配置

```bash
# redis.conf RDB 配置

# 触发条件 (满足任一条件触发)
save 900 1      # 900秒内至少1次修改
save 300 10     # 300秒内至少10次修改
save 60 10000   # 60秒内至少10000次修改

# 禁用 RDB
save ""

# RDB 文件名
dbfilename dump.rdb

# RDB 文件目录
dir /var/lib/redis

# bgsave 出错时停止写入
stop-writes-on-bgsave-error yes

# RDB 文件压缩
rdbcompression yes

# RDB 文件校验
rdbchecksum yes
```

### RDB 优缺点

```
┌─────────────────────────────────────────────────────────────┐
│                    RDB 优缺点                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   优点:                                                      │
│   ✅ 文件紧凑，适合备份和灾难恢复                            │
│   ✅ 性能好，fork 子进程后台执行                             │
│   ✅ 恢复速度快（直接加载二进制数据）                        │
│   ✅ 对主进程影响小                                          │
│                                                             │
│   缺点:                                                      │
│   ❌ 可能丢失最后一次快照后的数据                            │
│   ❌ fork 可能导致短暂延迟（大内存时）                       │
│   ❌ 不适合实时持久化                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 二、AOF 持久化

### 工作原理

```
┌─────────────────────────────────────────────────────────────┐
│                    AOF 工作原理                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   写入流程:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  客户端命令                                         │  │
│   │      │                                              │  │
│   │      ▼                                              │  │
│   │  Redis 执行命令                                      │  │
│   │      │                                              │  │
│   │      ▼                                              │  │
│   │  追加到 AOF 缓冲区                                   │  │
│   │      │                                              │  │
│   │      ▼ (根据 fsync 策略)                             │  │
│   │  写入 AOF 文件                                       │  │
│   │  (appendonly.aof)                                    │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   文件格式 (RESP 协议):                                      │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  *3                                                 │  │
│   │  $3                                                 │  │
│   │  SET                                                │  │
│   │  $4                                                 │  │
│   │  name                                               │  │
│   │  $5                                                 │  │
│   │  alice                                              │  │
│   │                                                     │  │
│   │  (表示: SET name alice)                             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   同步策略 (appendfsync):                                    │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  always    - 每条命令都 fsync (最安全，性能差)      │  │
│   │  everysec  - 每秒 fsync 一次 (推荐，最多丢1秒)      │  │
│   │  no        - 由 OS 决定何时 fsync (性能最好，不安全)│  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### AOF 重写

```
┌─────────────────────────────────────────────────────────────┐
│                    AOF 重写                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   问题: AOF 文件会越来越大                                   │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  SET count 1                                        │  │
│   │  INCR count                                         │  │
│   │  INCR count                                         │  │
│   │  INCR count                                         │  │
│   │  → 可合并为: SET count 4                            │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   重写流程:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. fork 子进程                                      │  │
│   │  2. 子进程遍历内存数据，写入新 AOF 文件              │  │
│   │  3. 主进程继续处理请求，新命令写入重写缓冲区         │  │
│   │  4. 子进程完成后，主进程将重写缓冲区追加到新文件     │  │
│   │  5. 用新文件替换旧文件                               │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   触发条件:                                                  │
│   • auto-aof-rewrite-percentage 100  (比上次大100%)         │
│   • auto-aof-rewrite-min-size 64mb   (最小64MB才触发)       │
│   • 手动: BGREWRITEAOF                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 配置

```bash
# redis.conf AOF 配置

# 开启 AOF
appendonly yes

# AOF 文件名
appendfilename "appendonly.aof"

# 同步策略
appendfsync everysec  # always / everysec / no

# 重写时是否暂停 fsync
no-appendfsync-on-rewrite no

# 自动重写条件
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

### AOF 优缺点

```
┌─────────────────────────────────────────────────────────────┐
│                    AOF 优缺点                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   优点:                                                      │
│   ✅ 数据更安全（everysec 最多丢1秒）                        │
│   ✅ 可读性好，便于分析和修复                                │
│   ✅ 支持误操作恢复（删除错误命令后重放）                    │
│   ✅ 追加写入，不影响已有数据                                │
│                                                             │
│   缺点:                                                      │
│   ❌ 文件体积大于 RDB                                        │
│   ❌ 恢复速度慢（需要重放所有命令）                          │
│   ❌ 写入性能略低于 RDB (需要 fsync)                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 三、混合持久化 (Redis 4.0+)

```
┌─────────────────────────────────────────────────────────────┐
│                    混合持久化                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   开启方式:                                                  │
│   aof-use-rdb-preamble yes                                  │
│                                                             │
│   文件格式:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  ┌───────────────────────┬─────────────────────┐   │  │
│   │  │    RDB 格式 (全量)    │   AOF 格式 (增量)   │   │  │
│   │  │                       │                     │   │  │
│   │  │    重写时刻的快照     │  重写后的写命令     │   │  │
│   │  └───────────────────────┴─────────────────────┘   │  │
│   │                                                     │  │
│   │  appendonly.aof = RDB头 + AOF尾                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   恢复流程:                                                  │
│   1. 加载 RDB 部分（快速）                                  │
│   2. 重放 AOF 部分（少量命令）                              │
│                                                             │
│   优势:                                                      │
│   ✅ 启动速度快（RDB 部分）                                  │
│   ✅ 数据安全（AOF 部分，最多丢1秒）                         │
│   ✅ 文件较小（RDB 压缩 + 增量 AOF）                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 对比总结

```
┌─────────────────────────────────────────────────────────────┐
│                    持久化方案对比                            │
├──────────────┬───────────────┬──────────────────────────────┤
│   特性        │     RDB       │          AOF                │
├──────────────┼───────────────┼──────────────────────────────┤
│   文件大小    │     小        │          大                 │
│   恢复速度    │     快        │          慢                 │
│   数据安全    │    可能丢失   │    最多丢1秒 (everysec)     │
│   写入性能    │     高        │          中                 │
│   文件格式    │   二进制      │        文本                 │
│   适用场景    │   备份/容灾   │     主存储/高安全           │
├──────────────┴───────────────┴──────────────────────────────┤
│                                                             │
│   生产建议:                                                  │
│   • 同时开启 RDB 和 AOF                                     │
│   • Redis 4.0+ 开启混合持久化                               │
│   • AOF 使用 everysec 策略                                  │
│   • 定期备份 RDB 文件到其他存储                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> Redis 两种持久化：1）**RDB**：定时生成内存快照，文件小恢复快，但可能丢失最后一次快照后的数据；2）**AOF**：记录每条写命令，数据更安全（everysec 最多丢1秒），但文件大恢复慢。**推荐**：开启混合持久化（RDB+AOF），兼顾恢复速度和数据安全。

### 1分钟版本

> **RDB 持久化**：
> - 原理：fork 子进程，生成内存快照
> - 触发：save 配置 / BGSAVE 命令
> - 优点：文件小、恢复快、性能好
> - 缺点：可能丢失最后一次快照后数据
>
> **AOF 持久化**：
> - 原理：追加记录每条写命令
> - 同步策略：always/everysec/no
> - 优点：数据安全、可读性好
> - 缺点：文件大、恢复慢
> - 重写：BGREWRITEAOF 压缩文件
>
> **混合持久化**（Redis 4.0+）：
> - AOF 文件 = RDB头 + AOF尾
> - 兼顾恢复速度和数据安全
>
> **生产建议**：
> - 同时开启 RDB + AOF
> - AOF 用 everysec
> - 开启混合持久化

---

*关联文档：[redis-use-cases.md](redis-use-cases.md) | [redis-oom.md](redis-oom.md)*
