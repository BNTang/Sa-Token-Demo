# Redis 过期删除策略

> 分类: Redis | 难度: ⭐⭐⭐ | 频率: 高频

---

## 一、三种删除策略

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          过期删除策略                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  1. 定时删除 (Timer)                                                             │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  为每个 key 设置定时器，到期立即删除                                        │ │
│  │                                                                             │ │
│  │  优点: 内存友好，过期立即释放                                               │ │
│  │  缺点: CPU 不友好，大量定时器消耗 CPU                                       │ │
│  │  Redis: 不采用                                                              │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  2. 惰性删除 (Lazy)                                                              │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  访问 key 时检查是否过期，过期则删除                                        │ │
│  │                                                                             │ │
│  │  优点: CPU 友好，只在访问时检查                                             │ │
│  │  缺点: 内存不友好，不访问的 key 永远不删除                                  │ │
│  │  Redis: 采用 ✅                                                             │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  3. 定期删除 (Periodic)                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  每隔一段时间，随机抽查一批 key，删除过期的                                 │ │
│  │                                                                             │ │
│  │  优点: 平衡 CPU 和内存                                                      │ │
│  │  缺点: 难以确定最佳频率                                                     │ │
│  │  Redis: 采用 ✅                                                             │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  Redis 采用: 惰性删除 + 定期删除                                                 │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、Redis 的实现细节

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          惰性删除实现                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  // 访问 key 时触发检查                                                          │
│  int expireIfNeeded(redisDb *db, robj *key) {                                    │
│      // 获取过期时间                                                             │
│      mstime_t when = getExpire(db, key);                                         │
│      if (when < 0) return 0;  // 没有设置过期时间                                │
│                                                                                  │
│      // 检查是否过期                                                             │
│      if (mstime() <= when) return 0;  // 未过期                                  │
│                                                                                  │
│      // 已过期，删除 key                                                         │
│      deleteKey(db, key);                                                         │
│      return 1;                                                                   │
│  }                                                                               │
│                                                                                  │
│  每次执行 GET、SET、EXISTS 等命令时，都会先调用 expireIfNeeded()                 │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────┐
│                          定期删除实现                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Redis 服务器周期性执行 activeExpireCycle():                                     │
│                                                                                  │
│  1. 每次执行时长限制 (默认 25ms)                                                 │
│     避免阻塞主线程太久                                                           │
│                                                                                  │
│  2. 每次随机抽取 ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP 个 key (默认 20)           │
│                                                                                  │
│  3. 检查抽取的 key，删除过期的                                                   │
│                                                                                  │
│  4. 如果过期 key 比例 > 25%，继续下一轮抽取                                      │
│     如果 < 25% 或超时，结束本次删除                                              │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  for (每个数据库 db) {                                                      │ │
│  │      while (未超时 && 过期比例 > 25%) {                                     │ │
│  │          随机抽取 20 个有过期时间的 key                                     │ │
│  │          删除其中已过期的 key                                               │ │
│  │          统计过期比例                                                       │ │
│  │      }                                                                      │ │
│  │  }                                                                          │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、过期信息存储

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          过期时间存储                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  redisDb 结构:                                                                   │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  typedef struct redisDb {                                                   │ │
│  │      dict *dict;       // 所有键值对                                        │ │
│  │      dict *expires;    // 过期时间字典 (key -> 过期时间戳)                  │ │
│  │      ...                                                                    │ │
│  │  } redisDb;                                                                 │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  设置过期时间:                                                                   │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  EXPIRE key 60      // 60秒后过期                                          │ │
│  │  EXPIREAT key 1735689600   // 指定时间戳过期                               │ │
│  │  PEXPIRE key 60000  // 60000毫秒后过期                                     │ │
│  │  SET key value EX 60 // 设置值同时设置过期                                  │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  查看剩余时间:                                                                   │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  TTL key    // 返回秒数，-1 表示永不过期，-2 表示不存在                    │ │
│  │  PTTL key   // 返回毫秒数                                                   │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、主从复制下的过期处理

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                    主从复制下的过期处理                                           │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  主节点:                                                                         │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  • 正常执行惰性删除和定期删除                                               │ │
│  │  • 删除 key 时，向从节点发送 DEL 命令                                       │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  从节点:                                                                         │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  • 不主动删除过期 key                                                       │ │
│  │  • 等待主节点的 DEL 命令                                                    │ │
│  │  • 读取时如果发现过期，返回 null (但不删除)                                 │ │
│  │                                                                             │ │
│  │  为什么?                                                                    │ │
│  │  保证主从数据一致性，避免数据不同步                                         │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  注意: Redis 3.2 之前从节点读取过期 key 会返回数据 (bug)                         │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、面试回答

### 30秒版本

> Redis 使用 **惰性删除 + 定期删除** 两种策略：
>
> - **惰性删除**：访问 key 时检查是否过期，过期则删除
> - **定期删除**：每 100ms 随机抽取一批 key，删除过期的
>
> 过期时间存储在单独的 `expires` 字典中。
>
> 如果仍有过期 key 未删除占用内存，会触发**内存淘汰策略**。

### 1分钟版本

> **三种删除策略对比**：
> 1. 定时删除：为每个 key 设定时器，内存友好但 CPU 消耗大，Redis 不用
> 2. 惰性删除：访问时检查删除，CPU 友好但可能内存泄漏
> 3. 定期删除：周期性抽查删除，平衡 CPU 和内存
>
> **Redis 采用惰性删除 + 定期删除**：
>
> **惰性删除**：
> - 每次读写 key 时调用 expireIfNeeded()
> - 如果已过期则删除并返回 null
>
> **定期删除**：
> - 默认每 100ms 执行一次 activeExpireCycle()
> - 每次限时 25ms，避免阻塞主线程
> - 每次随机抽取 20 个有过期时间的 key
> - 如果过期比例 > 25%，继续下一轮
> - 如果 < 25% 或超时，结束本次
>
> **主从复制**：
> - 从节点不主动删除过期 key
> - 等待主节点同步 DEL 命令
> - 保证数据一致性
>
> **兜底机制**：
> 如果仍有大量过期 key 未删除，触发内存淘汰策略（maxmemory-policy）。
