# Redis 主从复制的实现原理是什么？

## 主从复制概述

```
┌─────────────────────────────────────────────────────────────┐
│                    Redis 主从复制                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   什么是主从复制？                                           │
│   将一台 Redis 服务器的数据，复制到其他 Redis 服务器         │
│                                                             │
│   架构:                                                      │
│   ┌─────────────────┐                                      │
│   │     Master      │  主节点 (读写)                        │
│   │  192.168.1.100  │                                      │
│   └────────┬────────┘                                      │
│            │ 复制                                           │
│     ┌──────┴──────┐                                        │
│     ▼             ▼                                        │
│   ┌──────────┐  ┌──────────┐                               │
│   │ Slave 1  │  │ Slave 2  │  从节点 (只读)                 │
│   └──────────┘  └──────────┘                               │
│                                                             │
│   作用:                                                      │
│   • 数据备份 (容灾)                                         │
│   • 读写分离 (提高读性能)                                   │
│   • 高可用基础 (配合哨兵)                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 复制过程

```
┌─────────────────────────────────────────────────────────────┐
│                    复制过程                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   首次复制 (全量复制):                                       │
│                                                             │
│   ┌────────────┐                    ┌────────────┐         │
│   │   Slave    │                    │   Master   │         │
│   └─────┬──────┘                    └─────┬──────┘         │
│         │                                 │                 │
│         │ ──── 1. PSYNC ? -1 ─────────→  │  首次连接       │
│         │                                 │                 │
│         │ ←─── 2. +FULLRESYNC ────────── │  触发全量复制   │
│         │      runid offset              │                 │
│         │                                 │                 │
│         │                           ┌────┴────┐            │
│         │                           │ BGSAVE  │  生成RDB   │
│         │                           └────┬────┘            │
│         │                                 │                 │
│         │ ←─── 3. 发送 RDB 文件 ──────── │                 │
│         │                                 │                 │
│   ┌────┴────┐                            │                 │
│   │ 加载RDB │                            │                 │
│   └────┬────┘                            │                 │
│         │                                 │                 │
│         │ ←─── 4. 发送缓冲区命令 ──────── │  增量数据      │
│         │                                 │                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────┐
│                    增量复制                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   断线重连后 (增量复制):                                     │
│                                                             │
│   ┌────────────┐                    ┌────────────┐         │
│   │   Slave    │                    │   Master   │         │
│   └─────┬──────┘                    └─────┬──────┘         │
│         │                                 │                 │
│         │ ──── PSYNC runid offset ─────→ │  带上次的偏移量 │
│         │                                 │                 │
│         │      检查 repl_backlog_buffer   │                 │
│         │                                 │                 │
│         │ ←─── +CONTINUE ─────────────── │  可以增量复制   │
│         │                                 │                 │
│         │ ←─── 发送 offset 之后的命令 ─── │                 │
│         │                                 │                 │
│                                                             │
│   如果 offset 不在 backlog 中 → 触发全量复制                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 复制缓冲区

```
┌─────────────────────────────────────────────────────────────┐
│                    repl_backlog_buffer                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   复制积压缓冲区 (环形缓冲区):                               │
│                                                             │
│   ┌──────────────────────────────────────────────────────┐ │
│   │    ← 旧数据                           新数据 →       │ │
│   │  ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐     │ │
│   │  │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │ 9 │10 │11 │     │ │
│   │  └───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘     │ │
│   │                          ↑                          │ │
│   │                      写入位置                        │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
│   作用:                                                      │
│   • 保存最近的写命令                                        │
│   • 断线重连时，从缓冲区获取增量数据                        │
│   • 避免每次重连都全量复制                                  │
│                                                             │
│   配置:                                                      │
│   repl-backlog-size 1mb   # 缓冲区大小，建议设大些          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 配置方法

```bash
# 从节点配置 (redis.conf)

# 方式1: 配置文件
replicaof 192.168.1.100 6379

# 主节点密码
masterauth mypassword

# 从节点只读
replica-read-only yes

# 方式2: 命令行
> REPLICAOF 192.168.1.100 6379

# 取消复制，变为独立主节点
> REPLICAOF NO ONE
```

```bash
# 主节点配置 (redis.conf)

# 认证密码
requirepass mypassword

# 复制积压缓冲区大小 (建议调大)
repl-backlog-size 256mb

# 缓冲区释放时间 (主节点无从节点时)
repl-backlog-ttl 3600

# 无盘复制 (不生成RDB文件，直接发送)
repl-diskless-sync yes
```

## RDB 生成时如何处理请求？

```
┌─────────────────────────────────────────────────────────────┐
│                    BGSAVE 期间请求处理                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   BGSAVE 使用 fork() 创建子进程:                            │
│                                                             │
│   ┌─────────────────┐        ┌─────────────────┐           │
│   │   主进程        │ fork() │   子进程        │           │
│   │   (处理请求)    │ ─────→ │   (写RDB文件)   │           │
│   └────────┬────────┘        └─────────────────┘           │
│            │                                                │
│            │ Copy-On-Write (写时复制)                       │
│            │                                                │
│   ┌────────┴──────────────────────────────────────────┐    │
│   │  1. fork() 时，父子进程共享内存页                  │    │
│   │  2. 父进程修改数据时，复制该内存页再修改           │    │
│   │  3. 子进程看到的是 fork() 时刻的数据快照           │    │
│   └───────────────────────────────────────────────────┘    │
│                                                             │
│   所以:                                                      │
│   • BGSAVE 期间，主进程正常处理读写请求                     │
│   • 不会阻塞客户端 (fork() 本身可能短暂阻塞)                │
│   • 内存占用可能翻倍 (极端情况，所有页都被修改)             │
│                                                             │
│   注意:                                                      │
│   • SAVE 命令是同步的，会阻塞所有请求                       │
│   • 生产环境使用 BGSAVE                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 复制延迟问题

```
┌─────────────────────────────────────────────────────────────┐
│                    复制延迟                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   原因:                                                      │
│   • 网络延迟                                                │
│   • 从节点处理能力不足                                      │
│   • 全量复制期间                                            │
│                                                             │
│   监控:                                                      │
│   > INFO replication                                        │
│   slave0:ip=192.168.1.101,port=6379,state=online,offset=xxx│
│   master_repl_offset:yyy                                    │
│                                                             │
│   延迟 = master_repl_offset - slave_offset                  │
│                                                             │
│   解决方案:                                                  │
│   • 减少全量复制 (调大 repl-backlog-size)                   │
│   • 优化网络                                                │
│   • 读写分离时，对一致性要求高的读主库                      │
│   • 使用 WAIT 命令等待复制完成                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> Redis 主从复制分**全量复制**和**增量复制**。首次连接执行全量复制：主节点 BGSAVE 生成 RDB，发送给从节点加载；期间的写命令存入缓冲区，RDB 发完后再发增量命令。断线重连时，如果 offset 在复制积压缓冲区内，只做增量复制；否则全量复制。BGSAVE 用 fork + Copy-On-Write，不阻塞主进程。

### 1分钟版本

> **复制过程**：
>
> 1. **全量复制**（首次连接）：
>    - 从节点发送 `PSYNC ? -1`
>    - 主节点 BGSAVE 生成 RDB 文件
>    - 发送 RDB 给从节点
>    - 发送期间的增量命令（缓冲区）
>
> 2. **增量复制**（断线重连）：
>    - 从节点发送 `PSYNC runid offset`
>    - 主节点检查 repl_backlog_buffer
>    - offset 在缓冲区内 → 发送增量命令
>    - offset 不在 → 全量复制
>
> **BGSAVE 不阻塞请求**：
> - fork() 创建子进程写 RDB
> - Copy-On-Write：父进程继续处理请求
> - 修改数据时复制内存页
>
> **优化建议**：
> - repl-backlog-size 调大（减少全量复制）
> - 开启无盘复制（repl-diskless-sync）
> - 监控复制延迟

---

*关联文档：[redis-sentinel.md](redis-sentinel.md) | [redis-persistence.md](redis-persistence.md)*
