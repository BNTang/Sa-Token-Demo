# Redis 的哨兵机制是什么？

## 哨兵概述

```
┌─────────────────────────────────────────────────────────────┐
│                    Redis Sentinel                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   什么是哨兵？                                               │
│   Sentinel 是 Redis 的高可用解决方案                         │
│                                                             │
│   核心功能:                                                  │
│   ├── 监控 (Monitoring)                                     │
│   │   └── 监控主从节点是否正常运行                          │
│   │                                                         │
│   ├── 通知 (Notification)                                   │
│   │   └── 节点故障时通知管理员或其他应用                    │
│   │                                                         │
│   ├── 自动故障转移 (Automatic Failover)                     │
│   │   └── 主节点故障时，自动将从节点提升为主节点            │
│   │                                                         │
│   └── 配置提供者 (Configuration Provider)                   │
│       └── 客户端通过哨兵获取当前主节点地址                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    哨兵架构                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│         ┌─────────────────────────────────────┐            │
│         │          Sentinel 集群              │            │
│         │  ┌────────┐ ┌────────┐ ┌────────┐  │            │
│         │  │Sentinel│ │Sentinel│ │Sentinel│  │            │
│         │  │   1    │ │   2    │ │   3    │  │            │
│         │  └───┬────┘ └───┬────┘ └───┬────┘  │            │
│         └──────┼──────────┼──────────┼───────┘            │
│                │          │          │                     │
│                │    监控/选举/通知    │                     │
│                ▼          ▼          ▼                     │
│         ┌─────────────────────────────────────┐            │
│         │          Redis 主从集群             │            │
│         │                                     │            │
│         │      ┌─────────────────┐           │            │
│         │      │   Master        │           │            │
│         │      │  (读写)         │           │            │
│         │      └────────┬────────┘           │            │
│         │               │ 复制               │            │
│         │        ┌──────┴──────┐             │            │
│         │        ▼             ▼             │            │
│         │   ┌─────────┐   ┌─────────┐       │            │
│         │   │ Slave 1 │   │ Slave 2 │       │            │
│         │   │  (只读) │   │  (只读) │       │            │
│         │   └─────────┘   └─────────┘       │            │
│         └─────────────────────────────────────┘            │
│                                                             │
│   哨兵数量建议: 奇数个 (3, 5, 7)，便于投票                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 故障检测

```
┌─────────────────────────────────────────────────────────────┐
│                    故障检测机制                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   主观下线 (Subjective Down, SDOWN)                         │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • 单个哨兵认为节点下线                              │  │
│   │  • 哨兵 PING 节点，超过 down-after-milliseconds 无响应│  │
│   │  • 只是怀疑，不足以触发故障转移                      │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   客观下线 (Objective Down, ODOWN)                          │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • 多数哨兵认为节点下线                              │  │
│   │  • 哨兵之间通过 SENTINEL is-master-down-by-addr 询问 │  │
│   │  • 超过 quorum 个哨兵同意，确认客观下线              │  │
│   │  • 触发故障转移                                      │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  Sentinel1: Master 下线了！                          │  │
│   │      │                                               │  │
│   │      ├──→ 询问 Sentinel2: Master 下线了吗？          │  │
│   │      │    Sentinel2: 是的，下线了                    │  │
│   │      │                                               │  │
│   │      ├──→ 询问 Sentinel3: Master 下线了吗？          │  │
│   │      │    Sentinel3: 是的，下线了                    │  │
│   │      │                                               │  │
│   │      ▼                                               │  │
│   │  达到 quorum，确认客观下线，启动故障转移             │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 故障转移流程

```
┌─────────────────────────────────────────────────────────────┐
│                    故障转移流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   Step 1: 选举领导者 Sentinel                               │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • 使用 Raft 算法选举                                │  │
│   │  • 先到先得，投票给第一个请求的哨兵                  │  │
│   │  • 获得多数票的成为领导者，负责执行故障转移          │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   Step 2: 选择新主节点                                      │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  选择优先级顺序:                                     │  │
│   │  1. 过滤掉已下线的从节点                             │  │
│   │  2. 过滤掉响应慢的从节点                             │  │
│   │  3. 选择 replica-priority 最小的                     │  │
│   │  4. 选择复制偏移量最大的 (数据最新)                  │  │
│   │  5. 选择 runid 最小的                                │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   Step 3: 执行故障转移                                      │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. 向新主节点发送 SLAVEOF NO ONE，提升为主节点      │  │
│   │  2. 向其他从节点发送 SLAVEOF 新主节点                │  │
│   │  3. 更新哨兵配置，记录新主节点                       │  │
│   │  4. 旧主节点恢复后，自动变为从节点                   │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 配置示例

```bash
# sentinel.conf

# 监控的主节点名称、IP、端口、quorum
sentinel monitor mymaster 192.168.1.100 6379 2

# 主节点多久无响应认为主观下线 (毫秒)
sentinel down-after-milliseconds mymaster 30000

# 故障转移超时时间
sentinel failover-timeout mymaster 180000

# 同时进行同步的从节点数量
sentinel parallel-syncs mymaster 1

# 认证密码
sentinel auth-pass mymaster mypassword
```

## 客户端连接

```java
/**
 * Spring Boot 配置哨兵
 */
@Configuration
public class RedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        RedisSentinelConfiguration sentinelConfig = 
            new RedisSentinelConfiguration()
                .master("mymaster")
                .sentinel("192.168.1.101", 26379)
                .sentinel("192.168.1.102", 26379)
                .sentinel("192.168.1.103", 26379);
        
        sentinelConfig.setPassword(RedisPassword.of("mypassword"));
        
        return new LettuceConnectionFactory(sentinelConfig);
    }
}
```

```yaml
# application.yml 配置
spring:
  redis:
    sentinel:
      master: mymaster
      nodes:
        - 192.168.1.101:26379
        - 192.168.1.102:26379
        - 192.168.1.103:26379
    password: mypassword
```

## 哨兵 vs 集群

```
┌─────────────────────────────────────────────────────────────┐
│                    Sentinel vs Cluster                      │
├─────────────────┬──────────────────┬────────────────────────┤
│   特性          │   Sentinel       │   Cluster              │
├─────────────────┼──────────────────┼────────────────────────┤
│   高可用        │   ✓              │   ✓                    │
│   自动故障转移  │   ✓              │   ✓                    │
│   数据分片      │   ✗              │   ✓                    │
│   横向扩展      │   ✗              │   ✓                    │
│   复杂度        │   低             │   高                   │
│   适用场景      │   数据量小       │   大数据量、高并发     │
├─────────────────┴──────────────────┴────────────────────────┤
│                                                             │
│   选型建议:                                                  │
│   • 数据量 < 16GB，QPS < 10万 → Sentinel                    │
│   • 数据量大，需要分片 → Cluster                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> **哨兵**是 Redis 的高可用方案，核心功能：1）**监控**主从节点健康状态；2）**自动故障转移**：主节点故障时，选举新主节点；3）**配置提供**：客户端通过哨兵获取当前主节点。故障检测分**主观下线**（单个哨兵）和**客观下线**（多数哨兵同意），客观下线后启动故障转移。

### 1分钟版本

> **哨兵功能**：
> - 监控：定期 PING 主从节点
> - 通知：节点故障时通知
> - 自动故障转移：主节点挂了自动选新主
> - 配置提供：客户端通过哨兵获取主节点地址
>
> **故障检测**：
> - 主观下线（SDOWN）：单个哨兵认为节点下线
> - 客观下线（ODOWN）：quorum 个哨兵同意，确认下线
>
> **故障转移流程**：
> 1. 哨兵之间选举领导者（Raft）
> 2. 选择新主节点（优先级、复制偏移量）
> 3. 执行 SLAVEOF NO ONE 提升新主
> 4. 其他从节点指向新主
>
> **配置建议**：
> - 哨兵数量：奇数个（3、5）
> - quorum：一般设为 n/2 + 1
> - Sentinel vs Cluster：数据量小用 Sentinel，大用 Cluster

---

*关联文档：[redis-replication.md](redis-replication.md) | [redis-persistence.md](redis-persistence.md)*
