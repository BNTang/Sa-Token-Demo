# ä»€ä¹ˆæ˜¯é™æµï¼Ÿé™æµç®—æ³•æœ‰å“ªäº›ï¼Ÿæ€ä¹ˆå®ç°çš„ï¼Ÿ

## é™æµæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é™æµçš„ä½œç”¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   é—®é¢˜ï¼šç³»ç»Ÿå¤„ç†èƒ½åŠ›æœ‰é™ï¼Œè¯·æ±‚è¿‡å¤šä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ             â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   æ­£å¸¸æµé‡           å¤§é‡è¯·æ±‚               ç³»ç»Ÿå´©æºƒ  â”‚  â”‚
â”‚   â”‚      â†“                  â†“                     â†“      â”‚  â”‚
â”‚   â”‚   â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      ğŸ’¥ å®•æœº     â”‚  â”‚
â”‚   â”‚   â€¾â€¾â€¾â€¾â€¾â€¾â€¾â€¾                                          â”‚  â”‚
â”‚   â”‚   ç³»ç»Ÿå®¹é‡                                           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚   é™æµè§£å†³æ–¹æ¡ˆï¼š                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   å¤§é‡è¯·æ±‚ â†’ [é™æµå™¨] â†’ å…è®¸çš„è¯·æ±‚ â†’ ç³»ç»Ÿ            â”‚  â”‚
â”‚   â”‚                â†“                                     â”‚  â”‚
â”‚   â”‚            æ‹’ç»/æ’é˜Ÿ                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚   é™æµç»´åº¦ï¼š                                                 â”‚
â”‚   â€¢ æ¥å£çº§é™æµï¼šå•ä¸ªæ¥å£ QPS é™åˆ¶                           â”‚
â”‚   â€¢ ç”¨æˆ·çº§é™æµï¼šå•ä¸ªç”¨æˆ·è¯·æ±‚é¢‘ç‡é™åˆ¶                        â”‚
â”‚   â€¢ IP çº§é™æµï¼šå•ä¸ª IP è¯·æ±‚é¢‘ç‡é™åˆ¶                         â”‚
â”‚   â€¢ é›†ç¾¤é™æµï¼šæ•´ä¸ªé›†ç¾¤æ€» QPS é™åˆ¶                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸€ã€è®¡æ•°å™¨ç®—æ³• (å›ºå®šçª—å£)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å›ºå®šçª—å£è®¡æ•°å™¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   åŸç†ï¼šå›ºå®šæ—¶é—´çª—å£å†…ï¼Œè¯·æ±‚æ•°ä¸è¶…è¿‡é˜ˆå€¼                     â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  æ—¶é—´çª—å£1 (1ç§’)    â”‚  æ—¶é—´çª—å£2 (1ç§’)               â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚  â”‚
â”‚   â”‚  â”‚ è®¡æ•°: 100     â”‚  â”‚  â”‚ è®¡æ•°: é‡ç½®    â”‚            â”‚  â”‚
â”‚   â”‚  â”‚ é™åˆ¶: 100 QPS â”‚  â”‚  â”‚               â”‚            â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚   é—®é¢˜ï¼šä¸´ç•Œç‚¹çªå‘æµé‡                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  çª—å£1 ååŠéƒ¨åˆ†    â”‚  çª—å£2 å‰åŠéƒ¨åˆ†                 â”‚  â”‚
â”‚   â”‚  â†â”€â”€â”€ 100 è¯·æ±‚ â”€â”€â”€â†’â”‚â†â”€â”€â”€ 100 è¯·æ±‚ â”€â”€â”€â†’              â”‚  â”‚
â”‚   â”‚       0.5s         â”‚       0.5s                      â”‚  â”‚
â”‚   â”‚                    â”‚                                 â”‚  â”‚
â”‚   â”‚  åœ¨ 1 ç§’å†…å®é™…æœ‰ 200 ä¸ªè¯·æ±‚é€šè¿‡ï¼                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
/**
 * å›ºå®šçª—å£è®¡æ•°å™¨
 */
public class FixedWindowRateLimiter {
    
    private long windowStart;       // çª—å£å¼€å§‹æ—¶é—´
    private int count;              // å½“å‰çª—å£è¯·æ±‚æ•°
    private final int limit;        // é™åˆ¶æ•°
    private final long windowSize;  // çª—å£å¤§å° (æ¯«ç§’)
    
    public FixedWindowRateLimiter(int limit, long windowSizeMs) {
        this.limit = limit;
        this.windowSize = windowSizeMs;
        this.windowStart = System.currentTimeMillis();
        this.count = 0;
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç½®çª—å£
        if (now - windowStart >= windowSize) {
            windowStart = now;
            count = 0;
        }
        
        if (count < limit) {
            count++;
            return true;
        }
        return false;
    }
}
```

## äºŒã€æ»‘åŠ¨çª—å£ç®—æ³•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ»‘åŠ¨çª—å£è®¡æ•°å™¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   åŸç†ï¼šå°†çª—å£ç»†åˆ†ä¸ºå¤šä¸ªå°çª—å£ï¼Œå¹³æ»‘è®¡æ•°                     â”‚
â”‚                                                             â”‚
â”‚   çª—å£åˆ’åˆ† (1ç§’åˆ†ä¸º10ä¸ª100msçš„æ ¼å­):                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ 10 â”‚ 8  â”‚ 12 â”‚ 15 â”‚ 5  â”‚ 10 â”‚ 12 â”‚ 8  â”‚ 10 â”‚ 10 â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜     â”‚
â”‚                                                             â”‚
â”‚   æ»‘åŠ¨è¿‡ç¨‹:                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  T1: [10â”‚8 â”‚12â”‚15â”‚5 â”‚10â”‚12â”‚8 â”‚10â”‚10] = 100        â”‚   â”‚
â”‚   â”‚  T2:    [8 â”‚12â”‚15â”‚5 â”‚10â”‚12â”‚8 â”‚10â”‚10â”‚11] = 101     â”‚   â”‚
â”‚   â”‚  T3:       [12â”‚15â”‚5 â”‚10â”‚12â”‚8 â”‚10â”‚10â”‚11â”‚9] = 102   â”‚   â”‚
â”‚   â”‚  æ–°è¯·æ±‚è¿›æ¥ï¼Œæœ€æ—§çš„æ ¼å­ç§»å‡ºï¼Œæ–°æ ¼å­åŠ å…¥              â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚   ä¼˜ç‚¹ï¼šè§£å†³å›ºå®šçª—å£çš„ä¸´ç•Œé—®é¢˜ï¼Œæ›´å¹³æ»‘                       â”‚
â”‚   ç¼ºç‚¹ï¼šéœ€è¦ç»´æŠ¤å¤šä¸ªå°çª—å£çš„è®¡æ•°                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
/**
 * æ»‘åŠ¨çª—å£é™æµå™¨
 */
public class SlidingWindowRateLimiter {
    
    private final int limit;            // é™åˆ¶æ•°
    private final long windowSize;      // çª—å£å¤§å° (æ¯«ç§’)
    private final int bucketCount;      // æ¡¶æ•°é‡
    private final long bucketSize;      // æ¯ä¸ªæ¡¶çš„å¤§å°
    private final int[] buckets;        // å„æ¡¶çš„è®¡æ•°
    private long lastUpdateTime;        // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
    
    public SlidingWindowRateLimiter(int limit, long windowSizeMs, int bucketCount) {
        this.limit = limit;
        this.windowSize = windowSizeMs;
        this.bucketCount = bucketCount;
        this.bucketSize = windowSizeMs / bucketCount;
        this.buckets = new int[bucketCount];
        this.lastUpdateTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        
        // è®¡ç®—éœ€è¦æ»‘åŠ¨å¤šå°‘ä¸ªæ¡¶
        long elapsed = now - lastUpdateTime;
        int slideCount = (int) (elapsed / bucketSize);
        
        if (slideCount > 0) {
            slideWindow(slideCount);
            lastUpdateTime = now;
        }
        
        // è®¡ç®—å½“å‰çª—å£æ€»æ•°
        int total = 0;
        for (int count : buckets) {
            total += count;
        }
        
        if (total < limit) {
            buckets[bucketCount - 1]++;  // å¢åŠ æœ€æ–°æ¡¶
            return true;
        }
        return false;
    }
    
    private void slideWindow(int slideCount) {
        if (slideCount >= bucketCount) {
            Arrays.fill(buckets, 0);
        } else {
            // å·¦ç§»æ¡¶
            for (int i = 0; i < bucketCount - slideCount; i++) {
                buckets[i] = buckets[i + slideCount];
            }
            // æ–°æ¡¶ç½®0
            for (int i = bucketCount - slideCount; i < bucketCount; i++) {
                buckets[i] = 0;
            }
        }
    }
}
```

## ä¸‰ã€æ¼æ¡¶ç®—æ³•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¼æ¡¶ç®—æ³•                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   åŸç†ï¼šè¯·æ±‚è¿›å…¥æ¼æ¡¶ï¼ŒåŒ€é€Ÿæµå‡ºå¤„ç†                           â”‚
â”‚                                                             â”‚
â”‚            è¯·æ±‚æ¶Œå…¥ (ä»»æ„é€Ÿç‡)                               â”‚
â”‚                â†“â†“â†“â†“â†“â†“â†“â†“                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚            â”‚ â–“â–“â–“â–“â–“â–“â–“â–“ â”‚ â† æ¡¶å®¹é‡æœ‰é™                       â”‚
â”‚            â”‚ â–“â–“â–“â–“â–“â–“â–“â–“ â”‚   æº¢å‡ºå³æ‹’ç»                       â”‚
â”‚            â”‚ â–“â–“â–“â–“â–“â–“â–“â–“ â”‚                                     â”‚
â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                 â”‚ åŒ€é€Ÿæµå‡º (å›ºå®šé€Ÿç‡)                        â”‚
â”‚                 â†“                                            â”‚
â”‚            å¤„ç†è¯·æ±‚                                          â”‚
â”‚                                                             â”‚
â”‚   ç‰¹ç‚¹ï¼š                                                     â”‚
â”‚   â€¢ æµå‡ºé€Ÿç‡æ’å®šï¼Œå¹³æ»‘æµé‡                                  â”‚
â”‚   â€¢ æ¡¶æ»¡åˆ™æ‹’ç»æ–°è¯·æ±‚                                        â”‚
â”‚   â€¢ æ— æ³•å¤„ç†çªå‘æµé‡ (å³ä½¿ç³»ç»Ÿç©ºé—²)                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
/**
 * æ¼æ¡¶ç®—æ³•
 */
public class LeakyBucketRateLimiter {
    
    private final int capacity;        // æ¡¶å®¹é‡
    private final double leakRate;     // æ¼å‡ºé€Ÿç‡ (ä¸ª/ç§’)
    private double water;              // å½“å‰æ°´é‡
    private long lastLeakTime;         // ä¸Šæ¬¡æ¼æ°´æ—¶é—´
    
    public LeakyBucketRateLimiter(int capacity, double leakRate) {
        this.capacity = capacity;
        this.leakRate = leakRate;
        this.water = 0;
        this.lastLeakTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        leak();  // å…ˆæ¼æ°´
        
        if (water < capacity) {
            water++;
            return true;
        }
        return false;  // æ¡¶æ»¡ï¼Œæ‹’ç»
    }
    
    private void leak() {
        long now = System.currentTimeMillis();
        double elapsed = (now - lastLeakTime) / 1000.0;
        
        // è®¡ç®—æ¼å‡ºçš„æ°´é‡
        double leaked = elapsed * leakRate;
        water = Math.max(0, water - leaked);
        lastLeakTime = now;
    }
}
```

## å››ã€ä»¤ç‰Œæ¡¶ç®—æ³•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»¤ç‰Œæ¡¶ç®—æ³•                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   åŸç†ï¼šä»¥å›ºå®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œè¯·æ±‚éœ€è¦è·å–ä»¤ç‰Œæ‰èƒ½é€šè¿‡         â”‚
â”‚                                                             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚         â”‚ ä»¤ç‰Œç”Ÿæˆå™¨       â”‚                                â”‚
â”‚         â”‚ (å›ºå®šé€Ÿç‡ç”Ÿæˆ)   â”‚                                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                  â†“                                          â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚            â”‚ â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹ â”‚ â† ä»¤ç‰Œæ¡¶ (æœ‰å®¹é‡ä¸Šé™)              â”‚
â”‚            â”‚ â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—‹ â”‚   æ»¡äº†ä¸å†ç”Ÿæˆ                     â”‚
â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                 â”‚                                           â”‚
â”‚          è¯·æ±‚è·å–ä»¤ç‰Œ                                        â”‚
â”‚                 â†“                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚  æœ‰ä»¤ç‰Œ â†’ è·å–æˆåŠŸï¼Œå¤„ç†è¯·æ±‚        â”‚                   â”‚
â”‚   â”‚  æ— ä»¤ç‰Œ â†’ æ‹’ç» æˆ– ç­‰å¾…              â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â”‚   ç‰¹ç‚¹ï¼š                                                     â”‚
â”‚   â€¢ å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘æµé‡ (ç§¯ç´¯çš„ä»¤ç‰Œ)                     â”‚
â”‚   â€¢ é•¿æœŸé€Ÿç‡å—ä»¤ç‰Œç”Ÿæˆé€Ÿç‡é™åˆ¶                              â”‚
â”‚   â€¢ æ¯”æ¼æ¡¶çµæ´»ï¼Œæ›´å¸¸ç”¨                                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
/**
 * ä»¤ç‰Œæ¡¶ç®—æ³•
 */
public class TokenBucketRateLimiter {
    
    private final int capacity;        // æ¡¶å®¹é‡
    private final double refillRate;   // ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ (ä¸ª/ç§’)
    private double tokens;             // å½“å‰ä»¤ç‰Œæ•°
    private long lastRefillTime;       // ä¸Šæ¬¡å¡«å……æ—¶é—´
    
    public TokenBucketRateLimiter(int capacity, double refillRate) {
        this.capacity = capacity;
        this.refillRate = refillRate;
        this.tokens = capacity;  // åˆå§‹æ»¡æ¡¶
        this.lastRefillTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        return tryAcquire(1);
    }
    
    public synchronized boolean tryAcquire(int permits) {
        refill();  // å…ˆå¡«å……ä»¤ç‰Œ
        
        if (tokens >= permits) {
            tokens -= permits;
            return true;
        }
        return false;
    }
    
    private void refill() {
        long now = System.currentTimeMillis();
        double elapsed = (now - lastRefillTime) / 1000.0;
        
        // è®¡ç®—ç”Ÿæˆçš„ä»¤ç‰Œæ•°
        double newTokens = elapsed * refillRate;
        tokens = Math.min(capacity, tokens + newTokens);
        lastRefillTime = now;
    }
}
```

## Guava RateLimiter

```java
/**
 * ä½¿ç”¨ Guava RateLimiter (æ¨è)
 * åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°
 */
@Service
public class OrderService {
    
    // æ¯ç§’ 10 ä¸ªè¯·æ±‚
    private final RateLimiter rateLimiter = RateLimiter.create(10.0);
    
    public void createOrder(Order order) {
        // æ–¹å¼1ï¼šé˜»å¡ç­‰å¾…è·å–ä»¤ç‰Œ
        rateLimiter.acquire();
        doCreateOrder(order);
        
        // æ–¹å¼2ï¼šéé˜»å¡ï¼Œå°è¯•è·å–
        if (rateLimiter.tryAcquire()) {
            doCreateOrder(order);
        } else {
            throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
        
        // æ–¹å¼3ï¼šå¸¦è¶…æ—¶çš„ç­‰å¾…
        if (rateLimiter.tryAcquire(1, 500, TimeUnit.MILLISECONDS)) {
            doCreateOrder(order);
        } else {
            throw new RateLimitException("è¯·æ±‚è¶…æ—¶");
        }
    }
    
    // é¢„çƒ­æ¨¡å¼ï¼šå†·å¯åŠ¨æ—¶ç¼“æ…¢å¢åŠ é€Ÿç‡
    private final RateLimiter warmUpLimiter = RateLimiter.create(10.0, 3, TimeUnit.SECONDS);
}
```

## åˆ†å¸ƒå¼é™æµ (Redis)

```java
/**
 * Redis åˆ†å¸ƒå¼é™æµ - æ»‘åŠ¨çª—å£
 */
@Service
public class RedisRateLimiter {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    private static final String SCRIPT = 
        "local key = KEYS[1] " +
        "local window = tonumber(ARGV[1]) " +
        "local limit = tonumber(ARGV[2]) " +
        "local now = tonumber(ARGV[3]) " +
        "-- æ¸…é™¤çª—å£å¤–çš„è¯·æ±‚ " +
        "redis.call('ZREMRANGEBYSCORE', key, 0, now - window) " +
        "-- è·å–å½“å‰çª—å£è¯·æ±‚æ•° " +
        "local count = redis.call('ZCARD', key) " +
        "if count < limit then " +
        "    redis.call('ZADD', key, now, now .. '-' .. math.random()) " +
        "    redis.call('EXPIRE', key, window / 1000 + 1) " +
        "    return 1 " +
        "else " +
        "    return 0 " +
        "end";
    
    public boolean tryAcquire(String key, int limit, long windowMs) {
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(SCRIPT, Long.class),
            Collections.singletonList("ratelimit:" + key),
            String.valueOf(windowMs),
            String.valueOf(limit),
            String.valueOf(System.currentTimeMillis())
        );
        return result != null && result == 1;
    }
}
```

## ç®—æ³•å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é™æµç®—æ³•å¯¹æ¯”                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç®—æ³•        â”‚   ç‰¹ç‚¹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å›ºå®šçª—å£    â”‚   ç®€å•ï¼Œæœ‰ä¸´ç•Œçªå‘é—®é¢˜                       â”‚
â”‚   æ»‘åŠ¨çª—å£    â”‚   è§£å†³ä¸´ç•Œé—®é¢˜ï¼Œæ›´å¹³æ»‘                       â”‚
â”‚   æ¼æ¡¶        â”‚   åŒ€é€Ÿè¾“å‡ºï¼Œæ— æ³•å¤„ç†çªå‘                     â”‚
â”‚   ä»¤ç‰Œæ¡¶      â”‚   å…è®¸çªå‘ï¼Œæœ€å¸¸ç”¨                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ¨èï¼šä»¤ç‰Œæ¡¶ (Guava RateLimiter / Sentinel)               â”‚
â”‚   åˆ†å¸ƒå¼ï¼šRedis + Lua å®ç°                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é¢è¯•å›ç­”

### 30ç§’ç‰ˆæœ¬

> **é™æµ**æ˜¯æ§åˆ¶è¯·æ±‚é€Ÿç‡ï¼Œä¿æŠ¤ç³»ç»Ÿã€‚å››ç§ç®—æ³•ï¼š1ï¼‰**å›ºå®šçª—å£**ï¼šç®€å•ä½†æœ‰ä¸´ç•Œçªå‘é—®é¢˜ï¼›2ï¼‰**æ»‘åŠ¨çª—å£**ï¼šè§£å†³ä¸´ç•Œé—®é¢˜ï¼›3ï¼‰**æ¼æ¡¶**ï¼šåŒ€é€Ÿè¾“å‡ºï¼Œä¸èƒ½å¤„ç†çªå‘ï¼›4ï¼‰**ä»¤ç‰Œæ¡¶**ï¼šå…è®¸ä¸€å®šçªå‘ï¼Œæœ€å¸¸ç”¨ã€‚æ¨è Guava RateLimiterï¼ˆæœ¬åœ°ï¼‰æˆ– Redis + Luaï¼ˆåˆ†å¸ƒå¼ï¼‰ã€‚

### 1åˆ†é’Ÿç‰ˆæœ¬

> **é™æµä½œç”¨**ï¼šæ§åˆ¶è¯·æ±‚é€Ÿç‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½
>
> **å››ç§ç®—æ³•**ï¼š
>
> 1. **å›ºå®šçª—å£**
>    - å›ºå®šæ—¶é—´çª—å£è®¡æ•°
>    - ç¼ºç‚¹ï¼šä¸´ç•Œçªå‘ï¼ˆçª—å£è¾¹ç•Œå¯èƒ½çªç ´é™åˆ¶ï¼‰
>
> 2. **æ»‘åŠ¨çª—å£**
>    - çª—å£ç»†åˆ†å¤šä¸ªæ¡¶ï¼Œå¹³æ»‘æ»‘åŠ¨
>    - è§£å†³ä¸´ç•Œé—®é¢˜
>
> 3. **æ¼æ¡¶**
>    - è¯·æ±‚å…¥æ¡¶ï¼ŒåŒ€é€Ÿæµå‡º
>    - æµé‡å¹³æ»‘ï¼Œä½†æ— æ³•å¤„ç†çªå‘
>
> 4. **ä»¤ç‰Œæ¡¶**ï¼ˆæœ€å¸¸ç”¨ï¼‰
>    - å›ºå®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œ
>    - å…è®¸ä¸€å®šçªå‘ï¼ˆæ¶ˆè€—ç§¯ç´¯çš„ä»¤ç‰Œï¼‰
>
> **å®ç°**ï¼š
> - å•æœºï¼šGuava RateLimiterï¼ˆä»¤ç‰Œæ¡¶ï¼‰
> - åˆ†å¸ƒå¼ï¼šRedis + Lua / Sentinel

---

*å…³è”æ–‡æ¡£ï¼š[service-degradation.md](service-degradation.md) | [service-avalanche.md](service-avalanche.md)*
