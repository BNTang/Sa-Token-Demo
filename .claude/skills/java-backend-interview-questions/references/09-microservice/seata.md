# 什么是 Seata？

## Seata 概述

```
┌─────────────────────────────────────────────────────────────┐
│                    Seata                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   什么是 Seata？                                             │
│   阿里巴巴开源的分布式事务解决方案                          │
│   Simple Extensible Autonomous Transaction Architecture     │
│                                                             │
│   解决的问题:                                                │
│   微服务架构下，一个业务操作涉及多个服务的数据库操作        │
│   如何保证多个服务的数据一致性？                            │
│                                                             │
│   典型场景:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  下单流程:                                           │  │
│   │  订单服务 创建订单 → 库存服务 扣库存 → 账户服务 扣款│  │
│   │                                                     │  │
│   │  问题: 如果扣款失败，订单和库存如何回滚？           │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Seata 架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Seata 架构                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   三大组件:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                                                     │  │
│   │   ┌─────────────────────────────────────────────┐   │  │
│   │   │          TC (Transaction Coordinator)       │   │  │
│   │   │               事务协调者                     │   │  │
│   │   │          维护全局事务和分支事务状态          │   │  │
│   │   │          驱动全局提交或回滚                  │   │  │
│   │   │                                             │   │  │
│   │   │              Seata Server                   │   │  │
│   │   └──────────────────┬──────────────────────────┘   │  │
│   │                      │                               │  │
│   │         ┌────────────┼────────────┐                 │  │
│   │         ▼            ▼            ▼                 │  │
│   │   ┌──────────┐ ┌──────────┐ ┌──────────┐          │  │
│   │   │   TM     │ │   RM     │ │   RM     │          │  │
│   │   │事务管理器│ │资源管理器│ │资源管理器│          │  │
│   │   │          │ │          │ │          │          │  │
│   │   │订单服务  │ │库存服务  │ │账户服务  │          │  │
│   │   └──────────┘ └──────────┘ └──────────┘          │  │
│   │                                                     │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   TC: Transaction Coordinator - 事务协调者 (Seata Server)   │
│   TM: Transaction Manager - 事务管理器 (发起方)             │
│   RM: Resource Manager - 资源管理器 (参与方)                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 事务流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Seata 事务流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐    │
│   │   TM   │    │   TC   │    │  RM1   │    │  RM2   │    │
│   │ 订单服务│    │ Seata  │    │ 库存服务│    │ 账户服务│    │
│   └───┬────┘    └───┬────┘    └───┬────┘    └───┬────┘    │
│       │             │             │             │          │
│       │ 1.Begin     │             │             │          │
│       │────────────→│             │             │          │
│       │ (开启全局事务)│             │             │          │
│       │←────────────│             │             │          │
│       │  XID        │             │             │          │
│       │             │             │             │          │
│       │         2.分支注册         │             │          │
│       │─────────────────────────→│             │          │
│       │             │    Branch   │             │          │
│       │             │←────────────│             │          │
│       │             │  Register   │             │          │
│       │             │             │             │          │
│       │         3.分支注册         │             │          │
│       │──────────────────────────────────────→│          │
│       │             │             │    Branch   │          │
│       │             │←─────────────────────────│          │
│       │             │  Register   │             │          │
│       │             │             │             │          │
│       │ 4.Commit/Rollback         │             │          │
│       │────────────→│             │             │          │
│       │             │ 5.提交/回滚  │             │          │
│       │             │────────────→│             │          │
│       │             │─────────────────────────→│          │
│       │             │             │             │          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 四种事务模式

### AT 模式（推荐）

```
┌─────────────────────────────────────────────────────────────┐
│                    AT 模式 (Automatic Transaction)          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 无侵入，基于数据库代理实现                          │
│                                                             │
│   执行流程:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  一阶段:                                             │  │
│   │  1. 解析 SQL，获取表、主键                           │  │
│   │  2. 查询前镜像 (Before Image)                        │  │
│   │  3. 执行业务 SQL                                     │  │
│   │  4. 查询后镜像 (After Image)                         │  │
│   │  5. 生成 undo_log 并入库                             │  │
│   │  6. 本地事务提交                                     │  │
│   │  7. 向 TC 注册分支事务                               │  │
│   └─────────────────────────────────────────────────────┘  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  二阶段 (提交):                                      │  │
│   │  1. 删除 undo_log (异步批量)                         │  │
│   │                                                     │  │
│   │  二阶段 (回滚):                                      │  │
│   │  1. 根据 undo_log 恢复数据                           │  │
│   │  2. 删除 undo_log                                    │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   undo_log 表:                                              │
│   ┌────────────────────────────────────────────────────┐   │
│   │  branch_id, xid, rollback_info, log_status         │   │
│   │  context, log_created, log_modified                │   │
│   └────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### TCC 模式

```
┌─────────────────────────────────────────────────────────────┐
│                    TCC 模式                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 业务侵入，需要手动实现 Try-Confirm-Cancel           │
│                                                             │
│   三个阶段:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  Try: 预留资源                                       │  │
│   │  ├── 冻结库存 (不是真扣)                             │  │
│   │  ├── 冻结余额 (不是真扣)                             │  │
│   │  └── 检查业务可行性                                  │  │
│   │                                                     │  │
│   │  Confirm: 确认提交 (所有 Try 成功后)                 │  │
│   │  ├── 扣减冻结的库存                                  │  │
│   │  └── 扣减冻结的余额                                  │  │
│   │                                                     │  │
│   │  Cancel: 取消回滚 (任一 Try 失败后)                  │  │
│   │  ├── 释放冻结的库存                                  │  │
│   │  └── 释放冻结的余额                                  │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   适用场景: 对一致性要求高，可接受业务改造                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### SAGA 模式

```
┌─────────────────────────────────────────────────────────────┐
│                    SAGA 模式                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 长事务，通过补偿回滚                                │
│                                                             │
│   执行流程:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  正向执行:                                           │  │
│   │  T1 → T2 → T3 → ... → Tn                            │  │
│   │                                                     │  │
│   │  如果 T3 失败:                                       │  │
│   │  C2 (补偿T2) → C1 (补偿T1)                          │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   适用场景: 业务流程长、参与者多                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### XA 模式

```
┌─────────────────────────────────────────────────────────────┐
│                    XA 模式                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   特点: 依赖数据库 XA 协议，强一致性                        │
│                                                             │
│   执行流程:                                                  │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  一阶段: 执行 SQL，但不提交 (prepare)                │  │
│   │  二阶段: TC 通知所有 RM 提交或回滚                   │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   优点: 强一致性                                            │
│   缺点: 性能差，锁定时间长                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 代码示例

```java
// AT 模式使用示例
@Service
public class OrderService {
    
    @Autowired
    private StorageFeign storageFeign;
    @Autowired
    private AccountFeign accountFeign;
    
    // 开启全局事务
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public void createOrder(OrderDTO orderDTO) {
        // 1. 创建订单
        orderMapper.create(orderDTO);
        
        // 2. 扣减库存 (远程调用)
        storageFeign.deduct(orderDTO.getProductId(), orderDTO.getCount());
        
        // 3. 扣减余额 (远程调用)
        accountFeign.deduct(orderDTO.getUserId(), orderDTO.getMoney());
        
        // 任何一步失败，全部回滚
    }
}
```

## 模式选择

```
┌─────────────────────────────────────────────────────────────┐
│                    模式选择                                  │
├────────────┬─────────────────────────────────────────────────┤
│   模式     │   适用场景                                      │
├────────────┼─────────────────────────────────────────────────┤
│   AT       │ 默认推荐，无侵入，适合大多数场景               │
│   TCC      │ 高一致性要求，可接受业务改造                   │
│   SAGA     │ 长事务，参与者多，可接受最终一致               │
│   XA       │ 强一致性要求，可接受性能损失                   │
└────────────┴─────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> **Seata** 是阿里开源的分布式事务解决方案。三大组件：**TC**（事务协调者，Seata Server）、**TM**（事务管理器，发起方）、**RM**（资源管理器，参与方）。提供四种模式：**AT**（无侵入，基于 undo_log 回滚，推荐）、**TCC**（Try-Confirm-Cancel，业务侵入）、**SAGA**（长事务补偿）、**XA**（强一致性）。

### 1分钟版本

> **Seata 是什么**：
> - 分布式事务解决方案
> - 解决微服务跨库事务一致性
>
> **三大组件**：
> - TC：事务协调者，维护事务状态，驱动提交/回滚
> - TM：事务管理器，开启全局事务
> - RM：资源管理器，管理分支事务
>
> **四种模式**：
> 1. **AT 模式**（推荐）
>    - 无侵入，自动生成 undo_log
>    - 一阶段提交，二阶段异步删除 log 或回滚
>
> 2. **TCC 模式**
>    - Try 预留 → Confirm 确认 → Cancel 取消
>    - 业务侵入，但一致性高
>
> 3. **SAGA**：长事务，补偿回滚
>
> 4. **XA**：强一致，性能差
>
> **使用**：`@GlobalTransactional` 注解

---

*关联文档：[distributed-transaction.md](distributed-transaction.md) | [distributed-vs-microservice.md](distributed-vs-microservice.md)*
