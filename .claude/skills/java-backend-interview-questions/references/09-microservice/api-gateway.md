# API 网关详解

> 分类: 微服务 | 难度: ⭐⭐⭐ | 频率: 高频

---

## 一、什么是 API 网关

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          API 网关定义                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  API 网关是微服务架构中的统一入口，位于客户端与后端服务之间。                     │
│  所有外部请求都先经过网关，由网关进行处理后再转发到具体服务。                     │
│                                                                                  │
│  类比:                                                                           │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  API 网关就像大楼的前台:                                                    │ │
│  │  - 访客(请求)必须先到前台登记(认证)                                        │ │
│  │  - 前台告诉访客去哪个房间(路由)                                            │ │
│  │  - 前台控制同时接待的人数(限流)                                            │ │
│  │  - 前台记录所有访客信息(日志)                                              │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、网关架构

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          微服务网关架构                                           │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   外部客户端                                                                     │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐                                         │
│   │   Web   │  │   App   │  │ 第三方  │                                         │
│   └────┬────┘  └────┬────┘  └────┬────┘                                         │
│        │            │            │                                               │
│        └────────────┼────────────┘                                               │
│                     │ HTTPS                                                      │
│                     ↓                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         API 网关 (Gateway)                               │   │
│   │  ┌─────────────────────────────────────────────────────────────────────┐│   │
│   │  │ 认证鉴权 │ 路由转发 │ 负载均衡 │ 限流熔断 │ 日志监控 │ 协议转换    ││   │
│   │  └─────────────────────────────────────────────────────────────────────┘│   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                     │ HTTP/gRPC                                                  │
│        ┌────────────┼────────────┬────────────┐                                 │
│        ↓            ↓            ↓            ↓                                 │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                           │
│   │用户服务  │  │订单服务  │  │商品服务  │  │支付服务  │                           │
│   └─────────┘  └─────────┘  └─────────┘  └─────────┘                           │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心功能

### 3.1 功能详解

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          网关核心功能                                             │
├─────────────────┬────────────────────────────────────────────────────────────────┤
│   功能          │                        说明                                     │
├─────────────────┼────────────────────────────────────────────────────────────────┤
│   路由转发      │  根据请求路径/Header等将请求转发到对应的后端服务               │
│   负载均衡      │  将请求分发到多个服务实例，支持轮询/权重/随机等策略            │
│   认证鉴权      │  统一处理 JWT 验证、OAuth2、API Key 等认证                     │
│   限流熔断      │  控制请求速率，防止服务过载；熔断保护后端服务                  │
│   协议转换      │  HTTP 转 gRPC、WebSocket 代理等                                 │
│   请求聚合      │  将多个后端服务的响应聚合为一个响应返回                        │
│   缓存          │  缓存常用请求的响应，减少后端压力                              │
│   日志监控      │  统一记录请求日志，收集指标数据                                │
│   安全防护      │  防止 SQL 注入、XSS、CSRF 等攻击                               │
│   灰度发布      │  根据规则将部分流量导向新版本服务                              │
└─────────────────┴────────────────────────────────────────────────────────────────┘
```

### 3.2 为什么需要 API 网关

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          没有网关 vs 有网关                                       │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  没有网关:                                                                       │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  • 客户端需要知道所有服务的地址                                            │ │
│  │  • 每个服务都要实现认证、限流等功能                                        │ │
│  │  • 跨域问题分散处理                                                        │ │
│  │  • 服务变更需要通知所有客户端                                              │ │
│  │  • 无法统一监控和日志                                                      │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  有网关:                                                                         │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  • 客户端只需知道网关地址                                                  │ │
│  │  • 认证、限流等功能在网关统一处理                                          │ │
│  │  • 跨域在网关统一配置                                                      │ │
│  │  • 后端服务变更对客户端透明                                                │ │
│  │  • 统一的监控和日志平台                                                    │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、主流网关对比

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          主流 API 网关对比                                        │
├──────────────┬───────────┬─────────────┬───────────────────────────────────────┤
│    网关      │   语言    │   特点       │              适用场景                 │
├──────────────┼───────────┼─────────────┼───────────────────────────────────────┤
│ Spring Cloud │  Java     │ Spring生态   │ Java 微服务、Spring Cloud 体系       │
│ Gateway      │           │ 响应式编程   │                                       │
├──────────────┼───────────┼─────────────┼───────────────────────────────────────┤
│ Kong         │  Lua/Go   │ 插件丰富     │ 多语言微服务、需要丰富插件            │
│              │           │ 性能强      │                                       │
├──────────────┼───────────┼─────────────┼───────────────────────────────────────┤
│ APISIX       │  Lua      │ 高性能      │ 高性能要求、云原生                    │
│              │           │ 动态配置    │                                       │
├──────────────┼───────────┼─────────────┼───────────────────────────────────────┤
│ Nginx        │  C        │ 高性能      │ 静态路由、反向代理                    │
│              │           │ 静态配置    │                                       │
├──────────────┼───────────┼─────────────┼───────────────────────────────────────┤
│ Envoy        │  C++      │ 云原生      │ Kubernetes、Service Mesh              │
│              │           │ xDS协议     │                                       │
└──────────────┴───────────┴─────────────┴───────────────────────────────────────┘
```

---

## 五、Spring Cloud Gateway 示例

### 5.1 基础配置

```yaml
# application.yml
spring:
  cloud:
    gateway:
      routes:
        # 用户服务路由
        - id: user-service
          uri: lb://user-service  # 负载均衡到注册中心的服务
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=1       # 去掉 /api 前缀
            
        # 订单服务路由
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/order/**
            - Header=X-Request-Id, \d+   # 要求有数字格式的请求ID
          filters:
            - StripPrefix=1
            - AddRequestHeader=X-Gateway, spring-cloud-gateway
```

### 5.2 全局过滤器

```java
/**
 * 全局认证过滤器
 */
@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {
    
    private static final List<String> WHITE_LIST = Arrays.asList(
        "/api/user/login", "/api/user/register"
    );
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getPath().value();
        
        // 白名单放行
        if (WHITE_LIST.stream().anyMatch(path::startsWith)) {
            return chain.filter(exchange);
        }
        
        // 验证 Token
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");
        if (token == null || !validateToken(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        
        // 解析用户信息，传递给下游服务
        String userId = parseUserId(token);
        ServerHttpRequest request = exchange.getRequest().mutate()
            .header("X-User-Id", userId)
            .build();
        
        return chain.filter(exchange.mutate().request(request).build());
    }
    
    @Override
    public int getOrder() {
        return -100;  // 优先级高
    }
    
    private boolean validateToken(String token) {
        // JWT 验证逻辑
        return true;
    }
    
    private String parseUserId(String token) {
        // 解析 JWT 获取用户ID
        return "12345";
    }
}
```

### 5.3 限流配置

```java
/**
 * Redis 限流配置
 */
@Configuration
public class RateLimiterConfig {
    
    @Bean
    public KeyResolver userKeyResolver() {
        // 按用户限流
        return exchange -> Mono.just(
            exchange.getRequest().getHeaders().getFirst("X-User-Id")
        );
    }
    
    @Bean
    public KeyResolver ipKeyResolver() {
        // 按 IP 限流
        return exchange -> Mono.just(
            exchange.getRequest().getRemoteAddress().getHostString()
        );
    }
}
```

```yaml
# 限流配置
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10  # 每秒10个请求
                redis-rate-limiter.burstCapacity: 20  # 突发20个
                key-resolver: "#{@ipKeyResolver}"
```

---

## 六、面试回答

### 30秒版本

> API 网关是微服务架构的**统一入口**，所有外部请求都先经过网关再转发到后端服务。
>
> 核心功能：
> - **路由转发**：根据路径将请求转发到对应服务
> - **认证鉴权**：统一处理 JWT、OAuth2 等认证
> - **限流熔断**：控制请求速率，保护后端服务
> - **日志监控**：统一记录请求日志和指标
>
> 主流网关：Spring Cloud Gateway、Kong、APISIX、Nginx。

### 1分钟版本

> **什么是 API 网关：**
> API 网关是微服务架构中的边缘服务，作为所有客户端请求的统一入口。它将请求路由到适当的后端服务，并提供横切关注点的统一处理。
>
> **核心功能：**
> - 路由转发：根据请求路径、Header 等规则路由到后端服务
> - 负载均衡：将请求分发到多个服务实例
> - 认证鉴权：统一处理用户认证，验证 Token
> - 限流熔断：控制请求速率，防止后端服务过载
> - 协议转换：HTTP 转 gRPC、WebSocket 代理等
> - 日志监控：统一的请求日志和指标收集
>
> **为什么需要网关：**
> - 客户端只需知道网关地址，简化调用
> - 横切功能统一处理，避免重复开发
> - 后端服务变更对客户端透明
> - 统一的安全防护和监控
>
> **常用网关：**
> Java 生态用 Spring Cloud Gateway，多语言/高性能场景用 Kong 或 APISIX。

---

## 七、最佳实践

### ✅ 推荐做法

```java
// 1. 网关只做路由和横切功能，不要放业务逻辑
// 2. 使用响应式编程，提高并发能力
// 3. 合理配置超时和熔断
spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 1000
        response-timeout: 5000

// 4. 网关部署多实例，前置 Nginx/LB
// 5. 敏感信息脱敏后再记录日志
```

### ❌ 避免做法

```java
// ❌ 在网关中执行复杂业务逻辑
// ❌ 网关单点部署，无高可用
// ❌ 不设置超时，请求堆积
// ❌ 不做限流，后端服务被打垮
// ❌ 日志记录敏感信息(密码、Token等)
```
