# 为什么 JDK 9 中将 String 的 char 数组改为 byte 数组？

## 变更内容

```
┌─────────────────────────────────────────────────────────────┐
│                    String 内部实现变更                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   JDK 8 及之前:                                              │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  private final char[] value;  // 2 字节/字符        │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   JDK 9 及之后:                                              │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  private final byte[] value;  // 1 字节存储        │  │
│   │  private final byte coder;    // 编码标识          │  │
│   │                                                     │  │
│   │  coder = LATIN1 (0)  // ISO-8859-1, 1 字节/字符     │  │
│   │  coder = UTF16 (1)   // UTF-16, 2 字节/字符         │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   这个优化称为 Compact Strings (紧凑字符串)                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 变更原因

```
┌─────────────────────────────────────────────────────────────┐
│                    为什么要改？                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 节省内存                                                │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  大多数字符串只包含 Latin-1 字符 (ASCII + 西欧字符)  │  │
│   │  使用 char[] 每个字符占 2 字节，浪费 50% 空间        │  │
│   │                                                     │  │
│   │  "Hello" (5个字符):                                  │  │
│   │  char[]: 5 × 2 = 10 字节                             │  │
│   │  byte[]: 5 × 1 = 5 字节  (节省 50%)                  │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   2. 统计数据支持                                            │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  • 大多数 Java 应用中，字符串占用堆内存 25%+         │  │
│   │  • 大多数字符串只包含 ASCII 字符                     │  │
│   │  • 内存减少 → GC 压力减少 → 性能提升                 │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   3. 缓存友好                                                │
│   • 更小的内存占用 → 更好的 CPU 缓存利用率                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 工作原理

```java
// JDK 9+ String 内部
public final class String {
    private final byte[] value;
    private final byte coder;  // 编码标识
    
    static final byte LATIN1 = 0;  // ISO-8859-1
    static final byte UTF16 = 1;   // UTF-16
    
    // 创建字符串时根据内容选择编码
    public String(char[] value) {
        if (内容都是 Latin-1 字符) {
            this.coder = LATIN1;
            this.value = 压缩为 byte[] (每字符1字节);
        } else {
            this.coder = UTF16;
            this.value = char[] 转为 byte[] (每字符2字节);
        }
    }
    
    public int length() {
        return value.length >> coder;  // 根据编码计算长度
    }
    
    public char charAt(int index) {
        if (coder == LATIN1) {
            return (char)(value[index] & 0xff);
        } else {
            return 从UTF16格式读取;
        }
    }
}
```

```
┌─────────────────────────────────────────────────────────────┐
│                    存储对比                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   "Hello" (纯 ASCII):                                        │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  JDK 8 (char[]):                                     │  │
│   │  [H(2字节)] [e(2字节)] [l(2字节)] [l(2字节)] [o(2字节)]│  │
│   │  = 10 字节                                           │  │
│   │                                                     │  │
│   │  JDK 9+ (byte[], LATIN1):                            │  │
│   │  [H(1字节)] [e(1字节)] [l(1字节)] [l(1字节)] [o(1字节)]│  │
│   │  = 5 字节                                            │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   "你好" (中文):                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  JDK 8 (char[]):                                     │  │
│   │  [你(2字节)] [好(2字节)] = 4 字节                     │  │
│   │                                                     │  │
│   │  JDK 9+ (byte[], UTF16):                             │  │
│   │  [你(2字节)] [好(2字节)] = 4 字节 (无变化)            │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 性能影响

```
┌─────────────────────────────────────────────────────────────┐
│                    性能影响                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ✅ 优点:                                                   │
│   • 内存占用减少 (纯 ASCII 字符串减少 50%)                  │
│   • GC 压力减少                                             │
│   • 缓存利用率提高                                          │
│                                                             │
│   ⚠️ 代价:                                                   │
│   • 需要额外判断编码类型                                    │
│   • charAt() 等操作略有开销                                 │
│   • 混合字符串不节省空间                                    │
│                                                             │
│   总体收益 > 代价                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 相关 JVM 选项

```bash
# 禁用 Compact Strings (不推荐)
java -XX:-CompactStrings MyApp

# 默认启用
java -XX:+CompactStrings MyApp
```

## 面试回答

### 30秒版本

> JDK 9 引入 **Compact Strings** 优化：char[] 改为 byte[] + coder 标识。原因是大多数字符串只包含 Latin-1 字符（ASCII），用 char[] 每字符占 2 字节浪费空间。改为 byte[] 后，纯 ASCII 字符串**节省 50% 内存**。含中文等字符时用 UTF-16 编码，不节省但也不增加。

### 1分钟版本

> **变更内容**：
> - JDK 8: `char[] value`（2 字节/字符）
> - JDK 9+: `byte[] value` + `byte coder`
>
> **coder 取值**：
> - LATIN1 (0): 1 字节/字符
> - UTF16 (1): 2 字节/字符
>
> **变更原因**：
> - 大多数字符串是纯 ASCII
> - char[] 浪费 50% 空间
> - 字符串占堆内存 25%+
>
> **收益**：
> - 纯 ASCII 节省 50% 内存
> - GC 压力减少
> - 缓存利用率提高
>
> **代价**：
> - 额外编码判断（可忽略）

---

*关联文档：[string-buffer-builder.md](string-buffer-builder.md) | [stringbuilder-implementation.md](stringbuilder-implementation.md)*
