# 使用 new String("yupi") 会创建多少个对象？

## 答案

```
┌─────────────────────────────────────────────────────────────┐
│                    new String("yupi") 对象创建               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   答案: 1 个或 2 个对象                                     │
│                                                             │
│   情况一: 常量池中没有 "yupi"                               │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. 在字符串常量池中创建 "yupi" 对象                 │  │
│   │  2. 在堆中创建 new String 对象                       │  │
│   │  共 2 个对象                                         │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   情况二: 常量池中已有 "yupi"                               │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. 只在堆中创建 new String 对象                     │  │
│   │  共 1 个对象                                         │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 内存结构

```
┌─────────────────────────────────────────────────────────────┐
│                    String 内存结构                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   String s = new String("yupi");                            │
│                                                             │
│   ┌──────────────────────────────────────────────────────┐ │
│   │  栈                                                   │ │
│   │  ┌───────┐                                           │ │
│   │  │   s   │ ──────────────┐                           │ │
│   │  └───────┘               │                           │ │
│   └──────────────────────────┼───────────────────────────┘ │
│                              │                              │
│   ┌──────────────────────────┼───────────────────────────┐ │
│   │  堆                      ▼                            │ │
│   │              ┌─────────────────────┐                 │ │
│   │              │  String 对象        │ ← new 创建      │ │
│   │              │  value ─────────────┼───┐             │ │
│   │              └─────────────────────┘   │             │ │
│   │                                        │             │ │
│   │   字符串常量池                         ▼             │ │
│   │   ┌─────────────────────────────────────────────┐   │ │
│   │   │  "yupi" (char[] / byte[])                   │   │ │
│   │   └─────────────────────────────────────────────┘   │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
│   new String() 创建的对象的 value 指向常量池中的数组        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 源码分析

```java
// String 构造方法 (Java 8)
public String(String original) {
    this.value = original.value;  // 共享 char 数组
    this.hash = original.hash;
}

// "yupi" 字面量在编译时就确定，存入常量池
// new String("yupi") 在堆中创建新对象，但共享 value 数组
```

## 字节码验证

```java
public class StringTest {
    public static void main(String[] args) {
        String s = new String("yupi");
    }
}
```

```
// javap -c StringTest.class
0: new           #2   // class java/lang/String
3: dup
4: ldc           #3   // String yupi (从常量池加载)
6: invokespecial #4   // String.<init>(String)
9: astore_1
```

## 对比不同写法

```java
// 写法 1: 直接字面量
String s1 = "yupi";
// 只在常量池创建 1 个对象 (如果不存在)

// 写法 2: new String
String s2 = new String("yupi");
// 最多创建 2 个对象

// 写法 3: 拼接
String s3 = new String("yu") + new String("pi");
// 更多对象: "yu"(常量池) + String(堆) + "pi"(常量池) + String(堆) + StringBuilder + 结果String

// 验证
System.out.println(s1 == s2);  // false (不同对象)
System.out.println(s1 == s3);  // false

// intern() 返回常量池引用
System.out.println(s1 == s2.intern());  // true
System.out.println(s1 == s3.intern());  // true (JDK 7+)
```

## intern() 方法

```
┌─────────────────────────────────────────────────────────────┐
│                    String.intern()                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   JDK 6:                                                     │
│   • 常量池在永久代                                          │
│   • intern() 会复制字符串到永久代                           │
│                                                             │
│   JDK 7+:                                                    │
│   • 常量池移到堆中                                          │
│   • intern() 只是在常量池放一个引用，不复制                 │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  String s = new String("a") + new String("b");       │  │
│   │  s.intern();  // JDK 7+: 常量池存 s 的引用           │  │
│   │  String t = "ab";                                    │  │
│   │  System.out.println(s == t);  // JDK 7+: true        │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> **1 个或 2 个对象**：如果常量池没有 "yupi"，先在常量池创建一个，再在堆中创建一个 String 对象，共 2 个；如果常量池已有 "yupi"，只在堆中创建 1 个。new 出的 String 对象的 value 数组指向常量池中的字符序列。建议直接用字面量 `"yupi"` 而非 new。

### 1分钟版本

> **对象数量**：
> - 常量池无 "yupi"：2 个
> - 常量池有 "yupi"：1 个
>
> **创建过程**：
> 1. "yupi" 字面量 → 常量池
> 2. new String() → 堆对象
> 3. 堆对象的 value 指向常量池
>
> **字节码**：
> - `ldc` 加载常量池字符串
> - `new` + `invokespecial` 创建堆对象
>
> **intern()**：
> - JDK 7+ 常量池在堆中
> - 返回常量池引用
>
> **建议**：
> - 直接用字面量，避免 new String

---

*关联文档：[string-buffer-builder.md](string-buffer-builder.md) | [string-byte-array.md](string-byte-array.md)*
