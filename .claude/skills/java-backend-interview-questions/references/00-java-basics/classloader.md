# Java 的类加载过程是怎样的？

## 类加载概述

```
┌─────────────────────────────────────────────────────────────┐
│                    类加载过程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   .class 文件                                                │
│      │                                                      │
│      ▼                                                      │
│   ┌──────────────────────────────────────────────────────┐ │
│   │  1. 加载 (Loading)                                    │ │
│   │     • 读取 .class 文件到内存                          │ │
│   │     • 生成 Class 对象                                 │ │
│   └──────────────────────────────────────────────────────┘ │
│      │                                                      │
│      ▼                                                      │
│   ┌──────────────────────────────────────────────────────┐ │
│   │  2. 链接 (Linking)                                    │ │
│   │     ├── 验证: 确保字节码合法安全                      │ │
│   │     ├── 准备: 为静态变量分配内存，设默认值            │ │
│   │     └── 解析: 符号引用 → 直接引用                     │ │
│   └──────────────────────────────────────────────────────┘ │
│      │                                                      │
│      ▼                                                      │
│   ┌──────────────────────────────────────────────────────┐ │
│   │  3. 初始化 (Initialization)                           │ │
│   │     • 执行静态代码块 <clinit>                         │ │
│   │     • 给静态变量赋实际值                              │ │
│   └──────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 详细阶段说明

### 1. 加载 (Loading)

```
┌─────────────────────────────────────────────────────────────┐
│                    加载阶段                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   1. 通过类的全限定名获取二进制字节流                       │
│      • 从 .class 文件                                       │
│      • 从 JAR/WAR 包                                        │
│      • 从网络 (Applet)                                      │
│      • 运行时生成 (动态代理)                                │
│                                                             │
│   2. 将字节流转化为方法区的运行时数据结构                   │
│                                                             │
│   3. 在堆中生成 java.lang.Class 对象                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. 链接 (Linking)

```
┌─────────────────────────────────────────────────────────────┐
│                    链接阶段                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   2.1 验证 (Verification)                                    │
│   ├── 文件格式验证: 魔数、版本号                            │
│   ├── 元数据验证: 语义检查                                  │
│   ├── 字节码验证: 指令合法性                                │
│   └── 符号引用验证: 引用可访问性                            │
│                                                             │
│   2.2 准备 (Preparation)                                     │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  public static int value = 123;                      │  │
│   │  准备阶段: value = 0  (默认值)                       │  │
│   │  初始化阶段: value = 123  (赋实际值)                 │  │
│   │                                                     │  │
│   │  public static final int CONST = 123;               │  │
│   │  准备阶段: CONST = 123  (常量直接赋值)               │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   2.3 解析 (Resolution)                                      │
│   符号引用 (类名字符串) → 直接引用 (内存地址)              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3. 初始化 (Initialization)

```java
public class Example {
    static int a = 1;        // 静态变量赋值
    static {                  // 静态代码块
        System.out.println("静态代码块执行");
        a = 2;
    }
}

// 初始化阶段执行 <clinit> 方法
// <clinit> = 静态变量赋值语句 + 静态代码块 (按代码顺序)
```

## 类加载器

```
┌─────────────────────────────────────────────────────────────┐
│                    类加载器层次                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│          ┌─────────────────────────────────┐               │
│          │ Bootstrap ClassLoader           │  C++ 实现     │
│          │ 加载 $JAVA_HOME/lib (rt.jar)   │               │
│          └───────────────┬─────────────────┘               │
│                          │ 父                              │
│          ┌───────────────┴─────────────────┐               │
│          │ Extension ClassLoader           │  Java 实现    │
│          │ 加载 $JAVA_HOME/lib/ext         │               │
│          └───────────────┬─────────────────┘               │
│                          │ 父                              │
│          ┌───────────────┴─────────────────┐               │
│          │ Application ClassLoader         │  Java 实现    │
│          │ 加载 classpath                  │               │
│          └───────────────┬─────────────────┘               │
│                          │ 父                              │
│          ┌───────────────┴─────────────────┐               │
│          │ Custom ClassLoader              │  自定义       │
│          │ 自定义加载逻辑                  │               │
│          └─────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 双亲委派模型

```
┌─────────────────────────────────────────────────────────────┐
│                    双亲委派模型                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   加载类时，先委托父加载器加载，父加载器无法加载时才自己加载 │
│                                                             │
│   加载 java.lang.String:                                    │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  1. Application → 委托给 Extension                   │  │
│   │  2. Extension → 委托给 Bootstrap                     │  │
│   │  3. Bootstrap 加载成功 (在 rt.jar 中)                │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   好处:                                                      │
│   1. 避免类重复加载                                         │
│   2. 保护核心类 (如 java.lang.String 不会被篡改)           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

```java
// 双亲委派源码 (ClassLoader.loadClass)
protected Class<?> loadClass(String name, boolean resolve) {
    // 1. 检查是否已加载
    Class<?> c = findLoadedClass(name);
    if (c == null) {
        try {
            // 2. 委托父加载器
            if (parent != null) {
                c = parent.loadClass(name, false);
            } else {
                c = findBootstrapClassOrNull(name);
            }
        } catch (ClassNotFoundException e) {}
        
        if (c == null) {
            // 3. 父加载器无法加载，自己加载
            c = findClass(name);
        }
    }
    return c;
}
```

## 面试回答

### 30秒版本

> 类加载分三个阶段：**加载**（读取 .class 到内存，生成 Class 对象）、**链接**（验证、准备、解析）、**初始化**（执行 `<clinit>`，静态变量赋值）。类加载器采用**双亲委派模型**：先委托父加载器，父无法加载才自己加载。好处是避免重复加载、保护核心类。

### 1分钟版本

> **三个阶段**：
> - 加载：读取字节码，生成 Class 对象
> - 链接：验证（安全检查）→ 准备（静态变量分配内存，设默认值）→ 解析（符号引用→直接引用）
> - 初始化：执行 `<clinit>`，静态变量赋实际值
>
> **类加载器层次**：
> - Bootstrap（rt.jar）
> - Extension（lib/ext）
> - Application（classpath）
> - 自定义
>
> **双亲委派**：
> - 先委托父加载器
> - 父无法加载才自己加载
> - 保护核心类，避免重复加载

---

*关联文档：[jvm-memory.md](../05-jvm/jvm-memory.md) | [jdk-vs-jre.md](jdk-vs-jre.md)*
