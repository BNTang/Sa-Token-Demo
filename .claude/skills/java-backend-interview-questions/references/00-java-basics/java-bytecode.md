# Java 中的字节码是什么？

## 字节码概述

```
┌─────────────────────────────────────────────────────────────┐
│                    Java 字节码                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   定义: Java 源码编译后的中间代码，以 .class 文件存储       │
│                                                             │
│   编译过程:                                                  │
│   ┌──────────┐   javac   ┌──────────┐   JVM   ┌──────────┐ │
│   │  .java   │ ────────→ │  .class  │ ──────→ │ 机器码   │ │
│   │ 源代码   │  编译器   │ 字节码   │  解释   │ 执行     │ │
│   └──────────┘           └──────────┘  /JIT   └──────────┘ │
│                                                             │
│   特点:                                                      │
│   • 与平台无关 (一次编译，到处运行)                         │
│   • 由 JVM 解释执行或 JIT 编译                              │
│   • 紧凑高效的二进制格式                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 字节码示例

```java
// 源代码: Hello.java
public class Hello {
    public static void main(String[] args) {
        int a = 1;
        int b = 2;
        int c = a + b;
        System.out.println(c);
    }
}
```

```
# 编译: javac Hello.java
# 查看字节码: javap -c Hello.class

public static void main(java.lang.String[]);
  Code:
     0: iconst_1        // 将常量 1 压入栈
     1: istore_1        // 存储到局部变量 1 (a)
     2: iconst_2        // 将常量 2 压入栈
     3: istore_2        // 存储到局部变量 2 (b)
     4: iload_1         // 加载变量 1 (a)
     5: iload_2         // 加载变量 2 (b)
     6: iadd            // 整数相加
     7: istore_3        // 存储到变量 3 (c)
     8: getstatic       // 获取 System.out
    11: iload_3         // 加载变量 3 (c)
    12: invokevirtual   // 调用 println
    15: return          // 返回
```

## Class 文件结构

```
┌─────────────────────────────────────────────────────────────┐
│                    Class 文件结构                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │  magic (4字节)      │ 0xCAFEBABE 魔数              │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  minor_version      │ 次版本号                     │  │
│   │  major_version      │ 主版本号 (52=Java 8)         │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  constant_pool      │ 常量池 (字面量、符号引用)    │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  access_flags       │ 访问标志 (public/final等)    │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  this_class         │ 类索引                       │  │
│   │  super_class        │ 父类索引                     │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  interfaces         │ 接口索引集合                 │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  fields             │ 字段表                       │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  methods            │ 方法表                       │  │
│   ├─────────────────────┼──────────────────────────────┤  │
│   │  attributes         │ 属性表                       │  │
│   └─────────────────────┴──────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 常见字节码指令

```
┌─────────────────────────────────────────────────────────────┐
│                    常见字节码指令                            │
├──────────────────┬──────────────────────────────────────────┤
│   类别           │   指令示例                               │
├──────────────────┼──────────────────────────────────────────┤
│   加载/存储      │ iload, istore, aload, astore            │
│   算术运算       │ iadd, isub, imul, idiv                  │
│   类型转换       │ i2l, i2f, l2d                           │
│   对象操作       │ new, getfield, putfield                 │
│   栈操作         │ pop, dup, swap                          │
│   控制转移       │ ifeq, goto, tableswitch                 │
│   方法调用       │ invokevirtual, invokespecial, invokestatic│
│   异常处理       │ athrow                                   │
│   同步           │ monitorenter, monitorexit               │
└──────────────────┴──────────────────────────────────────────┘
```

## 字节码执行

```
┌─────────────────────────────────────────────────────────────┐
│                    字节码执行                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   执行方式:                                                  │
│   1. 解释执行: 逐条解释字节码 (慢)                          │
│   2. JIT 编译: 热点代码编译成机器码 (快)                    │
│   3. 混合模式: 默认模式，解释 + JIT                         │
│                                                             │
│   JVM 参数:                                                  │
│   -Xint        纯解释模式                                   │
│   -Xcomp       纯编译模式                                   │
│   -Xmixed      混合模式 (默认)                              │
│                                                             │
│   热点检测:                                                  │
│   • 方法调用计数器                                          │
│   • 回边计数器 (循环)                                       │
│   • 超过阈值触发 JIT 编译                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 字节码工具

```java
// 1. javap - JDK 自带反编译工具
// javap -c HelloWorld.class      // 查看字节码
// javap -v HelloWorld.class      // 详细信息

// 2. ASM - 字节码操作框架
ClassWriter cw = new ClassWriter(0);
cw.visit(V1_8, ACC_PUBLIC, "Example", null, "java/lang/Object", null);

// 3. Javassist - 字节码操作
CtClass cc = ClassPool.getDefault().get("HelloWorld");
cc.addMethod(CtNewMethod.make("public void hello() {}", cc));

// 4. Byte Buddy - 现代字节码生成库
new ByteBuddy()
    .subclass(Object.class)
    .method(named("toString"))
    .intercept(FixedValue.value("Hello"))
    .make();
```

## 跨语言兼容

```
┌─────────────────────────────────────────────────────────────┐
│                    JVM 语言生态                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   多种语言可以编译成字节码:                                  │
│                                                             │
│   ┌─────────┐                                               │
│   │  Java   │ ──┐                                           │
│   ├─────────┤   │                                           │
│   │ Kotlin  │ ──┤                                           │
│   ├─────────┤   │    ┌──────────┐    ┌─────────┐           │
│   │  Scala  │ ──┼──→ │ 字节码   │ ──→│   JVM   │           │
│   ├─────────┤   │    │ .class   │    │  运行   │           │
│   │ Groovy  │ ──┤    └──────────┘    └─────────┘           │
│   ├─────────┤   │                                           │
│   │ Clojure │ ──┘                                           │
│   └─────────┘                                               │
│                                                             │
│   好处: 跨语言互操作、共享 JVM 生态                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 面试回答

### 30秒版本

> 字节码是 Java 源码编译后的**中间代码**，存储在 .class 文件中，以 **0xCAFEBABE** 开头。JVM 通过**解释执行**或 **JIT 编译**执行字节码。好处是**跨平台**（一次编译，到处运行），Kotlin、Scala 等语言也可编译成字节码在 JVM 运行。

### 1分钟版本

> **定义**：Java 编译后的中间代码
>
> **流程**：.java → javac → .class → JVM → 执行
>
> **Class 文件结构**：
> - 魔数：0xCAFEBABE
> - 版本号、常量池、访问标志
> - 类/父类/接口索引
> - 字段表、方法表、属性表
>
> **执行方式**：
> - 解释执行：逐条解释
> - JIT 编译：热点代码编译成机器码
> - 混合模式：默认
>
> **好处**：
> - 跨平台
> - 多语言兼容（Kotlin、Scala）

---

*关联文档：[classloader.md](classloader.md) | [jvm-intro.md](../02-jvm/jvm-intro.md)*
