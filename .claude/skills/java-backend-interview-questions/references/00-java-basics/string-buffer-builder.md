# Java 中 String、StringBuffer 和 StringBuilder 的区别

## 核心区别

```
┌─────────────────────────────────────────────────────────────┐
│            String vs StringBuffer vs StringBuilder           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                       String                         │  │
│   │   • 不可变 (Immutable)                               │  │
│   │   • 每次修改创建新对象                               │  │
│   │   • 线程安全（因为不可变）                           │  │
│   │   • 适合：字符串常量、少量操作                       │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                    StringBuffer                      │  │
│   │   • 可变 (Mutable)                                   │  │
│   │   • 线程安全（synchronized）                         │  │
│   │   • 适合：多线程字符串拼接                           │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐  │
│   │                   StringBuilder                      │  │
│   │   • 可变 (Mutable)                                   │  │
│   │   • 非线程安全（无锁）                               │  │
│   │   • 性能最高                                         │  │
│   │   • 适合：单线程字符串拼接                           │  │
│   └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 详细对比

```
┌─────────────────────────────────────────────────────────────┐
│                    详细对比表                                │
├──────────────────┬──────────┬───────────────┬───────────────┤
│   特性           │  String  │  StringBuffer │  StringBuilder│
├──────────────────┼──────────┼───────────────┼───────────────┤
│   可变性         │  不可变  │     可变      │     可变      │
│   线程安全       │    是    │      是       │      否       │
│   同步机制       │    无    │  synchronized │      无       │
│   性能           │    低    │      中       │      高       │
│   适用场景       │ 常量/少量│   多线程拼接  │  单线程拼接   │
│   引入版本       │  JDK 1.0 │   JDK 1.0     │   JDK 1.5     │
└──────────────────┴──────────┴───────────────┴───────────────┘
```

## String 不可变性

```java
String s1 = "Hello";
String s2 = s1.concat(" World");  // 创建新对象

System.out.println(s1);  // "Hello" - 未改变
System.out.println(s2);  // "Hello World" - 新对象
```

```
┌─────────────────────────────────────────────────────────────┐
│                    String 不可变原理                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   public final class String {                               │
│       private final char[] value;  // Java 8               │
│       // 或 private final byte[] value;  // Java 9+        │
│   }                                                         │
│                                                             │
│   不可变的好处:                                              │
│   1. 线程安全 - 不需要同步                                  │
│   2. 字符串常量池 - 可以共享                                │
│   3. 哈希缓存 - hashCode 只计算一次                         │
│   4. 安全性 - 作为参数不会被修改                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 性能对比

```java
// 字符串拼接性能测试

// ❌ 差 - 每次都创建新对象
String result = "";
for (int i = 0; i < 10000; i++) {
    result += i;  // 每次创建新 String 对象
}

// ✅ 好 - 使用 StringBuilder
StringBuilder sb = new StringBuilder();
for (int i = 0; i < 10000; i++) {
    sb.append(i);  // 在原有对象上修改
}
String result = sb.toString();

// StringBuffer - 多线程安全但略慢
StringBuffer sbf = new StringBuffer();
for (int i = 0; i < 10000; i++) {
    sbf.append(i);  // 线程安全
}
```

```
┌─────────────────────────────────────────────────────────────┐
│                    性能对比 (10000次拼接)                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   String (+)      : ~300ms   ████████████████████████████  │
│   StringBuffer    : ~2ms     █                              │
│   StringBuilder   : ~1ms     █                              │
│                                                             │
│   StringBuilder 比 StringBuffer 快约 10-15%                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 常用方法

```java
StringBuilder sb = new StringBuilder();

// 追加
sb.append("Hello");
sb.append(" ").append("World");  // 链式调用

// 插入
sb.insert(5, ",");  // "Hello, World"

// 删除
sb.delete(5, 6);    // "Hello World"

// 反转
sb.reverse();       // "dlroW olleH"

// 替换
sb.replace(0, 5, "Hi");

// 转字符串
String result = sb.toString();

// 容量
sb.capacity();         // 当前容量
sb.ensureCapacity(100); // 确保至少100
```

## 使用建议

```
┌─────────────────────────────────────────────────────────────┐
│                    使用场景建议                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   使用 String:                                               │
│   • 字符串不需要修改                                        │
│   • 少量拼接操作                                            │
│   • 作为 Map 的 key                                         │
│                                                             │
│   使用 StringBuilder:                                        │
│   • 单线程环境                                              │
│   • 大量字符串拼接                                          │
│   • 循环中的字符串操作                                      │
│                                                             │
│   使用 StringBuffer:                                         │
│   • 多线程环境                                              │
│   • 需要线程安全的字符串操作                                │
│   • 实际场景较少，优先考虑 StringBuilder                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 编译器优化

```java
// 编译器会自动优化字符串拼接
String s = "a" + "b" + "c";
// 编译后: String s = "abc";

// 循环中的拼接，编译器优化有限
String s = "";
for (int i = 0; i < 10; i++) {
    s += i;  // 仍然会创建多个对象
}
// 手动使用 StringBuilder 更好
```

## 面试回答

### 30秒版本

> **String** 不可变，每次修改创建新对象，适合常量和少量操作。**StringBuilder** 可变，非线程安全，性能最高，适合**单线程**字符串拼接。**StringBuffer** 可变，**线程安全**（synchronized），适合多线程。循环拼接字符串时应使用 StringBuilder 而非 String +，避免创建大量临时对象。

### 1分钟版本

> **String**：
> - 不可变（final char[]/byte[]）
> - 线程安全（因为不可变）
> - 修改会创建新对象
> - 可用于字符串常量池
>
> **StringBuilder**：
> - 可变
> - 非线程安全
> - 性能最高
> - **推荐单线程使用**
>
> **StringBuffer**：
> - 可变
> - 线程安全（synchronized）
> - 性能略低于 StringBuilder
> - 多线程使用
>
> **使用建议**：
> - 少量操作：String
> - 大量拼接/循环：StringBuilder
> - 多线程拼接：StringBuffer（实际少见）
>
> **编译器优化**：
> - 常量拼接会优化
> - 循环拼接优化有限，手动用 StringBuilder

---

*关联文档：[stringbuilder-implementation.md](stringbuilder-implementation.md) | [java-immutable.md](java-immutable.md)*
