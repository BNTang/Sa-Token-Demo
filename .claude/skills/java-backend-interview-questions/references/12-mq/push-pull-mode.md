# 消息队列推拉模式

> 分类: 消息队列 | 难度: ⭐⭐⭐ | 频率: 中频

---

## 一、推模式 vs 拉模式

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          推模式 vs 拉模式                                         │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  推模式 (Push):                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Broker 主动推送消息给 Consumer                                             │ │
│  │                                                                             │ │
│  │  Broker ────→ Consumer                                                      │ │
│  │         有消息就推                                                          │ │
│  │                                                                             │ │
│  │  特点:                                                                      │ │
│  │  • 实时性高，有消息立即推送                                                 │ │
│  │  • Broker 控制推送速率                                                      │ │
│  │  • Consumer 被动接收                                                        │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  拉模式 (Pull):                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Consumer 主动从 Broker 拉取消息                                            │ │
│  │                                                                             │ │
│  │  Consumer ────→ Broker                                                      │ │
│  │           定期拉取                                                          │ │
│  │                                                                             │ │
│  │  特点:                                                                      │ │
│  │  • Consumer 控制消费速率                                                    │ │
│  │  • 可能有延迟（取决于拉取间隔）                                             │ │
│  │  • Consumer 主动控制                                                        │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、优缺点对比

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          推拉模式优缺点                                           │
├─────────────────┬───────────────────────────────────────────────────────────────┤
│                 │  推模式 (Push)                  拉模式 (Pull)                  │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│  实时性          │  ✅ 高，有消息立即推送         ❌ 低，取决于拉取间隔           │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│  消费速率控制    │  ❌ Broker 控制，可能压垮       ✅ Consumer 自己控制           │
│                 │     消费者                                                    │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│  资源消耗        │  ❌ Broker 维护每个 Consumer   ✅ Broker 无状态，只需响应请求  │
│                 │     的推送状态                                                │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│  消息堆积处理    │  ❌ 可能压垮 Consumer          ✅ Consumer 按自身能力消费      │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│  空轮询          │  ✅ 无空轮询                   ❌ 没消息也要定期拉取           │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│  批量消费        │  ❌ 通常单条推送               ✅ 可以批量拉取                 │
├─────────────────┼───────────────────────────────────────────────────────────────┤
│  实现复杂度      │  复杂，需维护连接状态          简单，无状态                   │
└─────────────────┴───────────────────────────────────────────────────────────────┘
```

---

## 三、主流 MQ 的实现方式

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          主流 MQ 实现                                             │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Kafka: 拉模式                                                                   │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  • Consumer 主动 poll() 拉取消息                                            │ │
│  │  • 使用长轮询 (long polling) 减少空轮询                                     │ │
│  │  • 可以批量拉取，高吞吐                                                     │ │
│  │  • Consumer 自己管理 offset                                                 │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  RocketMQ: 拉模式 (但封装成推的体验)                                             │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  底层实现:                                                                  │ │
│  │  • PullConsumer: 纯拉模式                                                   │ │
│  │  • PushConsumer: 长轮询封装，体验像推                                       │ │
│  │                                                                             │ │
│  │  长轮询原理:                                                                │ │
│  │  • Consumer 发起拉取请求                                                    │ │
│  │  • 如果没消息，Broker hold 住请求                                           │ │
│  │  • 有消息或超时才返回                                                       │ │
│  │  • 兼顾实时性和效率                                                         │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  RabbitMQ: 推模式为主                                                            │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  • basicConsume: 推模式，Broker 主动推送                                    │ │
│  │  • basicGet: 拉模式，Consumer 主动获取                                      │ │
│  │  • 支持 prefetch 限流，避免压垮消费者                                       │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、长轮询原理

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          长轮询 (Long Polling)                                    │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  短轮询 (效率低):                                                                │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Consumer ──→ 有消息吗? ──→ Broker (没有) ──→ 立即返回空                    │ │
│  │  Consumer ──→ 有消息吗? ──→ Broker (没有) ──→ 立即返回空                    │ │
│  │  Consumer ──→ 有消息吗? ──→ Broker (有)   ──→ 返回消息                      │ │
│  │                                                                             │ │
│  │  问题: 大量空请求，浪费资源                                                 │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  长轮询 (兼顾实时和效率):                                                        │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  Consumer ──→ 有消息吗? ──→ Broker                                          │ │
│  │                              ↓                                              │ │
│  │                        没有消息                                              │ │
│  │                              ↓                                              │ │
│  │                   Hold 住请求，等待...                                       │ │
│  │                              ↓                                              │ │
│  │              ┌───────────────┴───────────────┐                               │ │
│  │              ↓                               ↓                               │ │
│  │        有新消息到达                      超时 (如30秒)                        │ │
│  │              ↓                               ↓                               │ │
│  │        立即返回消息                     返回空，重新请求                      │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  优点:                                                                           │
│  • 有消息时实时返回 (接近推的实时性)                                             │
│  • 没消息时不会空轮询 (拉的效率)                                                 │
│  • Consumer 控制消费速率                                                         │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、面试回答

### 30秒版本

> **推模式**：Broker 主动推送，实时性高，但可能压垮消费者。
> **拉模式**：Consumer 主动拉取，自控速率，但可能有延迟。
>
> **主流 MQ 实现**：
> - Kafka：拉模式 + 长轮询
> - RocketMQ：拉模式，封装成推的体验
> - RabbitMQ：推模式为主
>
> **长轮询**：拉请求时如果没消息，Broker hold 住，有消息或超时才返回，兼顾实时性和效率。

### 1分钟版本

> **推模式（Push）**：
> - Broker 主动推送消息给 Consumer
> - 优点：实时性高
> - 缺点：可能压垮消费者，Broker 需维护连接状态
> - 代表：RabbitMQ
>
> **拉模式（Pull）**：
> - Consumer 主动从 Broker 拉取消息
> - 优点：Consumer 自控消费速率，可批量拉取
> - 缺点：可能有延迟，空轮询浪费资源
> - 代表：Kafka
>
> **长轮询（Long Polling）**：
> - 结合推拉优点
> - Consumer 发起请求，没消息时 Broker hold 住
> - 有消息或超时才返回
> - 兼顾实时性和效率
> - RocketMQ PushConsumer 就是长轮询实现
>
> **如何选择**：
> - 实时性要求高：推模式
> - 吞吐量要求高：拉模式
> - 兼顾实时和效率：长轮询
