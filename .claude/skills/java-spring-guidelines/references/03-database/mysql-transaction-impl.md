# MySQL äº‹åŠ¡å®ç°åŸç†

> Java/Spring Boot ç¼–ç è§„èŒƒ - MySQL äº‹åŠ¡åº•å±‚å®ç°æœºåˆ¶è¯¦è§£
> redo logã€undo logã€MVCCã€é”æœºåˆ¶ã€äºŒé˜¶æ®µæäº¤

---

## MySQL äº‹åŠ¡å®ç°æœºåˆ¶æ¦‚è§ˆ

**äº‹åŠ¡å®ç°çš„æ ¸å¿ƒç»„ä»¶ï¼š**

| ç»„ä»¶ | ä½œç”¨ | ä¿è¯ç‰¹æ€§ |
|------|------|---------|
| **redo log** | é‡åšæ—¥å¿—ï¼Œè®°å½•æ•°æ®é¡µä¿®æ”¹ | æŒä¹…æ€§ï¼ˆDï¼‰ |
| **undo log** | å›æ»šæ—¥å¿—ï¼Œè®°å½•ä¿®æ”¹å‰æ•°æ® | åŸå­æ€§ï¼ˆAï¼‰ã€ä¸€è‡´æ€§ï¼ˆCï¼‰ |
| **MVCC** | å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ | éš”ç¦»æ€§ï¼ˆIï¼‰ |
| **é”æœºåˆ¶** | è¡Œé”ã€è¡¨é”ã€é—´éš™é” | éš”ç¦»æ€§ï¼ˆIï¼‰ |
| **binlog** | äºŒè¿›åˆ¶æ—¥å¿—ï¼Œè®°å½•SQLè¯­å¥ | æŒä¹…æ€§ï¼ˆDï¼‰ã€ä¸»ä»å¤åˆ¶ |

---

## redo logï¼ˆé‡åšæ—¥å¿—ï¼‰

### ä»€ä¹ˆæ˜¯ redo logï¼Ÿ

**redo logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼š**

> InnoDB å­˜å‚¨å¼•æ“ç‰¹æœ‰çš„æ—¥å¿—ï¼Œç”¨äºä¿è¯äº‹åŠ¡çš„**æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ã€‚è®°å½•æ•°æ®é¡µçš„**ç‰©ç†ä¿®æ”¹**ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦ redo logï¼Ÿ**

```
é—®é¢˜ï¼šç›´æ¥ä¿®æ”¹æ•°æ®é¡µæ•ˆç‡ä½

1. æ•°æ®é¡µï¼ˆ16KBï¼‰åœ¨ç£ç›˜ä¸Šæ˜¯éšæœºåˆ†å¸ƒçš„
2. ä¿®æ”¹ä¸€æ¡è®°å½•éœ€è¦è¯»å–æ•´ä¸ªæ•°æ®é¡µåˆ°å†…å­˜
3. ä¿®æ”¹åå†åˆ·æ–°åˆ°ç£ç›˜ï¼ˆéšæœºIOï¼Œæ…¢ï¼‰

è§£å†³ï¼šå…ˆå†™ redo logï¼ˆé¡ºåºIOï¼Œå¿«ï¼‰

1. äº‹åŠ¡æäº¤æ—¶ï¼Œå…ˆå†™ redo logï¼ˆé¡ºåºIOï¼‰
2. åå°å¼‚æ­¥åˆ·æ–°æ•°æ®é¡µåˆ°ç£ç›˜ï¼ˆæ‰¹é‡åˆ·æ–°ï¼‰
3. å³ä½¿æ•°æ®åº“å®•æœºï¼Œé‡å¯åé€šè¿‡ redo log æ¢å¤
```

### redo log å·¥ä½œåŸç†

**WALï¼ˆWrite-Ahead Loggingï¼‰æœºåˆ¶ï¼š**

```
äº‹åŠ¡æ‰§è¡Œæµç¨‹ï¼š

1. äº‹åŠ¡ä¿®æ”¹æ•°æ®ï¼ˆå†…å­˜ä¸­çš„ Buffer Poolï¼‰
2. å†™å…¥ redo log buffer
3. äº‹åŠ¡æäº¤æ—¶ï¼Œredo log buffer åˆ·ç›˜ï¼ˆé¡ºåºIOï¼‰
4. å¼‚æ­¥åˆ·æ–° Buffer Pool åˆ°ç£ç›˜

å´©æºƒæ¢å¤ï¼š
- MySQL å®•æœºåï¼Œå†…å­˜ä¸­çš„ä¿®æ”¹ä¸¢å¤±
- é‡å¯æ—¶è¯»å– redo logï¼Œé‡åšæœªæŒä¹…åŒ–çš„ä¿®æ”¹
- ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§
```

**ç¤ºä¾‹ï¼š**

```sql
-- T1: å¼€å§‹äº‹åŠ¡
START TRANSACTION;

-- T2: ä¿®æ”¹æ•°æ®ï¼ˆåœ¨å†…å­˜ä¸­ï¼‰
UPDATE account SET balance = balance - 100 WHERE id = 1;

-- T3: å†™å…¥ redo log buffer
redo log buffer: [id=1, balance: 1000 â†’ 900]

-- T4: æäº¤äº‹åŠ¡
COMMIT;

-- T5: redo log buffer åˆ·ç›˜ï¼ˆæŒä¹…åŒ–ï¼‰
redo log file: [id=1, balance: 1000 â†’ 900] âœ… æŒä¹…åŒ–æˆåŠŸ

-- T6: åå°å¼‚æ­¥åˆ·æ–°æ•°æ®é¡µåˆ°ç£ç›˜
ï¼ˆå¯èƒ½åœ¨å‡ ç§’ç”šè‡³å‡ åˆ†é’Ÿåæ‰§è¡Œï¼‰
```

### redo log ç»“æ„

```
redo log æ˜¯å¾ªç¯å†™å…¥çš„ï¼š

ib_logfile0 â†â”€â”
ib_logfile1   â”‚ å¾ªç¯å†™å…¥
     â†“        â”‚
 write pos â”€â”€â”€â”˜  ï¼ˆå½“å‰å†™å…¥ä½ç½®ï¼‰
 checkpoint      ï¼ˆå·²åˆ·ç›˜æ•°æ®é¡µä½ç½®ï¼‰

å½“ write pos è¿½ä¸Š checkpoint æ—¶ï¼Œéœ€è¦ç­‰å¾…æ•°æ®é¡µåˆ·ç›˜
```

---

## undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰

### ä»€ä¹ˆæ˜¯ undo logï¼Ÿ

**undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ï¼š**

> è®°å½•æ•°æ®ä¿®æ”¹å‰çš„å€¼ï¼Œç”¨äºä¿è¯äº‹åŠ¡çš„**åŸå­æ€§ï¼ˆAtomicityï¼‰**å’Œå®ç° **MVCC**ã€‚

**undo log çš„ä½œç”¨ï¼š**

1. **äº‹åŠ¡å›æ»š**ï¼šROLLBACK æ—¶æ¢å¤åˆ°ä¿®æ”¹å‰çš„çŠ¶æ€
2. **MVCC è¯»å–**ï¼šæä¾›å†å²ç‰ˆæœ¬æ•°æ®ï¼Œå®ç°å¿«ç…§è¯»

### undo log å·¥ä½œåŸç†

**ç¤ºä¾‹ï¼šUPDATE æ“ä½œ**

```sql
-- åŸå§‹æ•°æ®
id=1, name='Alice', age=25

-- T1: å¼€å§‹äº‹åŠ¡
START TRANSACTION;

-- T2: ä¿®æ”¹æ•°æ®
UPDATE user SET age = 30 WHERE id = 1;

-- T3: å†™å…¥ undo logï¼ˆè®°å½•æ—§å€¼ï¼‰
undo log: [id=1, age: 25]  â† ä¿å­˜æ—§å€¼

-- T4: ä¿®æ”¹å†…å­˜ä¸­çš„æ•°æ®
Buffer Pool: [id=1, name='Alice', age=30]

-- T5: äº‹åŠ¡å›æ»š
ROLLBACK;

-- T6: è¯»å– undo logï¼Œæ¢å¤æ—§å€¼
Buffer Pool: [id=1, name='Alice', age=25]  â† æ¢å¤æˆåŠŸ
```

### undo log ä¸ MVCC

**MVCC é€šè¿‡ undo log å®ç°å¤šç‰ˆæœ¬ï¼š**

```sql
-- æ•°æ®ç»“æ„ï¼ˆç®€åŒ–ï¼‰
CREATE TABLE user (
    id bigint,
    name varchar(50),
    age int,
    -- éšè—å­—æ®µ
    DB_TRX_ID bigint,      -- äº‹åŠ¡ID
    DB_ROLL_PTR bigint     -- undo log æŒ‡é’ˆ
);

-- ç‰ˆæœ¬é“¾
å½“å‰ç‰ˆæœ¬ï¼š[id=1, age=30, TRX_ID=102]
    â†“ (DB_ROLL_PTR)
undo logï¼š[id=1, age=25, TRX_ID=101]
    â†“ (DB_ROLL_PTR)
undo logï¼š[id=1, age=20, TRX_ID=100]

-- ä¸åŒäº‹åŠ¡è¯»å–ä¸åŒç‰ˆæœ¬
äº‹åŠ¡ Aï¼ˆTRX_ID=100ï¼‰ï¼šè¯»å– age=20
äº‹åŠ¡ Bï¼ˆTRX_ID=101ï¼‰ï¼šè¯»å– age=25
äº‹åŠ¡ Cï¼ˆTRX_ID=102ï¼‰ï¼šè¯»å– age=30
```

---

## äºŒé˜¶æ®µæäº¤ï¼ˆ2PCï¼‰

### ä»€ä¹ˆæ˜¯äºŒé˜¶æ®µæäº¤ï¼Ÿ

**MySQL çš„äºŒé˜¶æ®µæäº¤ï¼š**

> åè°ƒ **redo log**ï¼ˆInnoDBï¼‰å’Œ **binlog**ï¼ˆServer å±‚ï¼‰çš„ä¸€è‡´æ€§ï¼Œç¡®ä¿ä¸»ä»å¤åˆ¶çš„æ•°æ®ä¸€è‡´ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦äºŒé˜¶æ®µæäº¤ï¼Ÿ**

```
é—®é¢˜ï¼šredo log å’Œ binlog æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ—¥å¿—

åœºæ™¯1ï¼šå…ˆå†™ redo logï¼Œåå†™ binlog
- redo log å†™å…¥æˆåŠŸ
- binlog å†™å…¥å¤±è´¥ï¼ˆå®•æœºï¼‰
- ä¸»åº“é€šè¿‡ redo log æ¢å¤ï¼ˆæ•°æ®å·²ä¿®æ”¹ï¼‰
- ä»åº“é€šè¿‡ binlog å¤åˆ¶ï¼ˆæ•°æ®æœªä¿®æ”¹ï¼‰
â†’ ä¸»ä»ä¸ä¸€è‡´ï¼

åœºæ™¯2ï¼šå…ˆå†™ binlogï¼Œåå†™ redo log
- binlog å†™å…¥æˆåŠŸ
- redo log å†™å…¥å¤±è´¥ï¼ˆå®•æœºï¼‰
- ä¸»åº“æœªæ¢å¤ï¼ˆæ•°æ®æœªä¿®æ”¹ï¼‰
- ä»åº“é€šè¿‡ binlog å¤åˆ¶ï¼ˆæ•°æ®å·²ä¿®æ”¹ï¼‰
â†’ ä¸»ä»ä¸ä¸€è‡´ï¼

è§£å†³ï¼šäºŒé˜¶æ®µæäº¤ï¼Œä¿è¯ redo log å’Œ binlog ä¸€è‡´
```

### äºŒé˜¶æ®µæäº¤æµç¨‹

```
é˜¶æ®µ1ï¼šPrepare é˜¶æ®µ
1. å†™å…¥ redo logï¼ˆçŠ¶æ€ï¼šprepareï¼‰
2. å†™å…¥ binlog
3. redo log å’Œ binlog éƒ½æˆåŠŸ

é˜¶æ®µ2ï¼šCommit é˜¶æ®µ
1. ä¿®æ”¹ redo log çŠ¶æ€ä¸º commit
2. äº‹åŠ¡æäº¤æˆåŠŸ

å´©æºƒæ¢å¤ï¼š
- å¦‚æœ redo log å¤„äº prepare çŠ¶æ€ï¼Œä¸” binlog å·²å†™å…¥
  â†’ æäº¤äº‹åŠ¡ï¼ˆä¿è¯ä¸»ä»ä¸€è‡´ï¼‰
- å¦‚æœ redo log å¤„äº prepare çŠ¶æ€ï¼Œä½† binlog æœªå†™å…¥
  â†’ å›æ»šäº‹åŠ¡
```

**ç¤ºä¾‹æµç¨‹å›¾ï¼š**

```
UPDATE account SET balance = 900 WHERE id = 1;

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  1. å†™å…¥ redo log (prepare)        â”‚
   â”‚     redo log: [id=1, balance=900]  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  2. å†™å…¥ binlog                     â”‚
   â”‚     binlog: UPDATE account ...     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  3. redo log çŠ¶æ€æ”¹ä¸º commit       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
             äº‹åŠ¡æäº¤æˆåŠŸ
```

---

## MySQL é”æœºåˆ¶

### é”ç±»å‹æ¦‚è§ˆ

| é”ç±»å‹ | ç²’åº¦ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|------|------|---------|
| **è¡¨é”** | è¡¨çº§ | é”å®šæ•´å¼ è¡¨ | MyISAMã€DDL è¯­å¥ |
| **è¡Œé”** | è¡Œçº§ | é”å®šå•è¡Œè®°å½• | InnoDB é»˜è®¤ |
| **é—´éš™é”** | èŒƒå›´ | é”å®šç´¢å¼•åŒºé—´ | é˜²æ­¢å¹»è¯» |
| **Next-Key Lock** | è¡Œ+é—´éš™ | è¡Œé”+é—´éš™é” | REPEATABLE_READ é»˜è®¤ |
| **æ„å‘é”** | è¡¨çº§ | è¡¨ç¤ºäº‹åŠ¡å°†è¦åŠ é” | æå‡åŠ è¡¨é”æ•ˆç‡ |

### è¡Œé”ï¼ˆRecord Lockï¼‰

**è¡Œé”ï¼š**é”å®šç´¢å¼•è®°å½•ï¼Œç²’åº¦æœ€å°ï¼Œå¹¶å‘åº¦æœ€é«˜ã€‚

```sql
-- ç¤ºä¾‹ï¼šé”å®š id=1 çš„è®°å½•
START TRANSACTION;
SELECT * FROM user WHERE id = 1 FOR UPDATE;  -- åŠ è¡Œé”
-- å…¶ä»–äº‹åŠ¡æ— æ³•ä¿®æ”¹ id=1 çš„è®°å½•ï¼Œä½†å¯ä»¥ä¿®æ”¹å…¶ä»–è®°å½•
UPDATE user SET age = 30 WHERE id = 1;
COMMIT;
```

**è¡Œé”çš„å‰æï¼šå¿…é¡»é€šè¿‡ç´¢å¼•æŸ¥è¯¢**

```sql
-- âœ… èµ°ä¸»é”®ç´¢å¼•ï¼ŒåŠ è¡Œé”
SELECT * FROM user WHERE id = 1 FOR UPDATE;

-- âœ… èµ°å”¯ä¸€ç´¢å¼•ï¼ŒåŠ è¡Œé”
SELECT * FROM user WHERE username = 'alice' FOR UPDATE;

-- âŒ ä¸èµ°ç´¢å¼•ï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼Œé€€åŒ–ä¸ºè¡¨é”ï¼
SELECT * FROM user WHERE age = 25 FOR UPDATE;
```

### é—´éš™é”ï¼ˆGap Lockï¼‰

**é—´éš™é”ï¼š**é”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„"é—´éš™"ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥æ•°æ®ï¼ˆé˜²æ­¢å¹»è¯»ï¼‰ã€‚

```sql
-- å‡è®¾è¡¨ä¸­æœ‰ id: 1, 5, 10

-- äº‹åŠ¡ A
START TRANSACTION;
SELECT * FROM user WHERE id BETWEEN 5 AND 10 FOR UPDATE;

-- é—´éš™é”é”å®šçš„èŒƒå›´ï¼š
-- (1, 5]  â† é—´éš™é”
-- [5, 5]  â† è¡Œé”
-- (5, 10) â† é—´éš™é”
-- [10, 10]â† è¡Œé”
-- (10, âˆ) â† é—´éš™é”

-- äº‹åŠ¡ Bï¼ˆé˜»å¡ï¼‰
INSERT INTO user (id, name) VALUES (7, 'Bob');  -- è¢«é˜»å¡
INSERT INTO user (id, name) VALUES (11, 'Charlie');  -- è¢«é˜»å¡

-- äº‹åŠ¡ A
COMMIT;

-- äº‹åŠ¡ B è§£é™¤é˜»å¡
```

### Next-Key Lock

**Next-Key Lock = Record Lock + Gap Lock**

> MySQL REPEATABLE_READ éš”ç¦»çº§åˆ«ä¸‹çš„é»˜è®¤é”æœºåˆ¶ï¼Œé˜²æ­¢å¹»è¯»ã€‚

```sql
-- Next-Key Lock é”å®šèŒƒå›´

è®°å½•ï¼šid = 1, 5, 10, 15

SELECT * FROM user WHERE id >= 5 AND id <= 10 FOR UPDATE;

é”å®šèŒƒå›´ï¼š
(1, 5]   â† Next-Key Lockï¼ˆé—´éš™é” + è¡Œé”ï¼‰
(5, 10]  â† Next-Key Lockï¼ˆé—´éš™é” + è¡Œé”ï¼‰

é˜»å¡æ“ä½œï¼š
- INSERT id=3, 6, 9 ï¼ˆé—´éš™é”é˜»å¡ï¼‰
- UPDATE id=5, 10   ï¼ˆè¡Œé”é˜»å¡ï¼‰
```

### è¡¨é”

**è¡¨é”ï¼š**é”å®šæ•´å¼ è¡¨ï¼Œç²’åº¦æœ€å¤§ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚

```sql
-- æ‰‹åŠ¨åŠ è¡¨é”
LOCK TABLES user READ;   -- è¯»é”ï¼ˆå…±äº«é”ï¼‰
LOCK TABLES user WRITE;  -- å†™é”ï¼ˆæ’ä»–é”ï¼‰

-- é‡Šæ”¾è¡¨é”
UNLOCK TABLES;

-- DDL è¯­å¥è‡ªåŠ¨åŠ è¡¨é”
ALTER TABLE user ADD COLUMN email varchar(100);
```

### æ„å‘é”ï¼ˆIntention Lockï¼‰

**æ„å‘é”ï¼š**è¡¨çº§é”ï¼Œè¡¨ç¤ºäº‹åŠ¡æ‰“ç®—åœ¨è¡¨ä¸­çš„è¡ŒåŠ é”ã€‚

| é”ç±»å‹ | è¯´æ˜ |
|--------|------|
| **æ„å‘å…±äº«é”ï¼ˆISï¼‰** | äº‹åŠ¡æ‰“ç®—ç»™æŸäº›è¡ŒåŠ å…±äº«é” |
| **æ„å‘æ’ä»–é”ï¼ˆIXï¼‰** | äº‹åŠ¡æ‰“ç®—ç»™æŸäº›è¡ŒåŠ æ’ä»–é” |

**ä½œç”¨ï¼šæå‡åŠ è¡¨é”çš„æ•ˆç‡**

```
åœºæ™¯ï¼šäº‹åŠ¡ A æƒ³åŠ è¡¨é”

ä¸ä½¿ç”¨æ„å‘é”ï¼š
1. éå†æ‰€æœ‰è¡Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¡Œé”
2. æ•ˆç‡ä½

ä½¿ç”¨æ„å‘é”ï¼š
1. æ£€æŸ¥æ„å‘é”ï¼ˆè¡¨çº§ï¼‰
2. å¦‚æœæœ‰ IX é”ï¼Œè¯´æ˜æœ‰è¡Œé”ï¼Œæ— æ³•åŠ è¡¨é”
3. æ•ˆç‡é«˜
```

---

## é•¿äº‹åŠ¡é—®é¢˜

### é•¿äº‹åŠ¡çš„å±å®³

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|------|------|------|
| **é”ç­‰å¾…** | é•¿æ—¶é—´æŒæœ‰é” | å…¶ä»–äº‹åŠ¡é˜»å¡ |
| **undo log è†¨èƒ€** | å¤§é‡å†å²ç‰ˆæœ¬æ— æ³•æ¸…ç† | ç£ç›˜å ç”¨å¢åŠ  |
| **å›æ»šæ—¶é—´é•¿** | å¤§é‡æ•°æ®éœ€è¦å›æ»š | å½±å“å¯ç”¨æ€§ |
| **ä¸»ä»å»¶è¿Ÿ** | binlog ç§¯å‹ | ä»åº“å»¶è¿Ÿå¢åŠ  |

**ç¤ºä¾‹ï¼šundo log è†¨èƒ€**

```sql
-- äº‹åŠ¡ Aï¼ˆé•¿äº‹åŠ¡ï¼‰
START TRANSACTION;
SELECT * FROM user WHERE id = 1;  -- å¼€å§‹äº‹åŠ¡

-- äº‹åŠ¡ Bï¼ˆæ­£å¸¸ä¸šåŠ¡ï¼‰
UPDATE user SET age = 25 WHERE id = 1;  -- åˆ›å»ºæ–°ç‰ˆæœ¬
UPDATE user SET age = 26 WHERE id = 1;  -- åˆ›å»ºæ–°ç‰ˆæœ¬
UPDATE user SET age = 27 WHERE id = 1;  -- åˆ›å»ºæ–°ç‰ˆæœ¬
...ï¼ˆæ‰§è¡Œ1000æ¬¡UPDATEï¼‰

-- ç‰ˆæœ¬é“¾
å½“å‰ç‰ˆæœ¬ï¼šage=1027
  â†“
undo logï¼šage=1026
  â†“
undo logï¼šage=1025
  â†“
...ï¼ˆ1000ä¸ªç‰ˆæœ¬ï¼Œæ— æ³•æ¸…ç†ï¼Œå› ä¸ºäº‹åŠ¡Aè¿˜åœ¨ï¼‰
  â†“
undo logï¼šage=25

-- äº‹åŠ¡ A æäº¤ï¼ˆ10åˆ†é’Ÿåï¼‰
COMMIT;

-- é—®é¢˜ï¼šundo log è†¨èƒ€ï¼Œå ç”¨å¤§é‡ç£ç›˜ç©ºé—´
```

### å¦‚ä½•é¿å…é•¿äº‹åŠ¡ï¼Ÿ

```java
// âŒ åä¾‹ - é•¿äº‹åŠ¡
@Transactional(rollbackFor = Exception.class)
public void processBatchOrders(List<Long> orderIds) {
    for (Long orderId : orderIds) {  // å¤„ç†1000ä¸ªè®¢å•
        Order order = orderMapper.selectById(orderId);
        processOrder(order);  // å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆè€—æ—¶ï¼‰
        orderMapper.updateById(order);
    }
    // äº‹åŠ¡æŒç»­å‡ åˆ†é’Ÿç”šè‡³å‡ å°æ—¶
}

// âœ… æ­£ä¾‹ - æ‹†åˆ†äº‹åŠ¡
public void processBatchOrders(List<Long> orderIds) {
    for (Long orderId : orderIds) {
        processSingleOrder(orderId);  // æ¯ä¸ªè®¢å•ç‹¬ç«‹äº‹åŠ¡
    }
}

@Transactional(rollbackFor = Exception.class)
public void processSingleOrder(Long orderId) {
    Order order = orderMapper.selectById(orderId);
    processOrder(order);
    orderMapper.updateById(order);
    // äº‹åŠ¡æŒç»­å‡ æ¯«ç§’
}
```

---

## MVCC å®ç°ç»†èŠ‚

### Read View

**Read Viewï¼ˆè¯»è§†å›¾ï¼‰ï¼š**äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆçš„æ•°æ®å¿«ç…§ï¼Œå†³å®šèƒ½çœ‹åˆ°å“ªäº›ç‰ˆæœ¬çš„æ•°æ®ã€‚

**Read View å­—æ®µï¼š**

| å­—æ®µ | è¯´æ˜ |
|------|------|
| **m_ids** | å½“å‰æ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨ |
| **min_trx_id** | æœ€å°æ´»è·ƒäº‹åŠ¡ID |
| **max_trx_id** | ä¸‹ä¸€ä¸ªå°†è¦åˆ†é…çš„äº‹åŠ¡ID |
| **creator_trx_id** | åˆ›å»ºè¯¥ Read View çš„äº‹åŠ¡ID |

**å¯è§æ€§åˆ¤æ–­ï¼š**

```
è®°å½•çš„äº‹åŠ¡IDï¼ˆDB_TRX_IDï¼‰åˆ¤æ–­ï¼š

1. DB_TRX_ID < min_trx_id
   â†’ è¯¥ç‰ˆæœ¬åœ¨ Read View ç”Ÿæˆå‰å·²æäº¤ï¼Œå¯è§

2. DB_TRX_ID >= max_trx_id
   â†’ è¯¥ç‰ˆæœ¬åœ¨ Read View ç”Ÿæˆåæäº¤ï¼Œä¸å¯è§

3. min_trx_id <= DB_TRX_ID < max_trx_id
   â†’ å¦‚æœ DB_TRX_ID åœ¨ m_ids ä¸­ï¼ˆæœªæäº¤ï¼‰ï¼Œä¸å¯è§
   â†’ å¦‚æœ DB_TRX_ID ä¸åœ¨ m_ids ä¸­ï¼ˆå·²æäº¤ï¼‰ï¼Œå¯è§
```

### READ COMMITTED vs REPEATABLE READ

```sql
-- READ COMMITTEDï¼šæ¯æ¬¡ SELECT ç”Ÿæˆæ–°çš„ Read View
START TRANSACTION;
SELECT * FROM user WHERE id = 1;  -- Read View 1
-- å…¶ä»–äº‹åŠ¡ä¿®æ”¹å¹¶æäº¤
SELECT * FROM user WHERE id = 1;  -- Read View 2ï¼ˆçœ‹åˆ°æ–°æ•°æ®ï¼‰

-- REPEATABLE READï¼šäº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆ Read Viewï¼Œåç»­ä¸å˜
START TRANSACTION;
SELECT * FROM user WHERE id = 1;  -- Read View 1
-- å…¶ä»–äº‹åŠ¡ä¿®æ”¹å¹¶æäº¤
SELECT * FROM user WHERE id = 1;  -- Read View 1ï¼ˆçœ‹åˆ°æ—§æ•°æ®ï¼‰
```

---

## æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|--------|------|--------|
| âœ… ç†è§£ redo log ä½œç”¨ | ä¿è¯æŒä¹…æ€§ | ğŸ”´ å¿…é¡» |
| âœ… ç†è§£ undo log ä½œç”¨ | ä¿è¯åŸå­æ€§ã€å®ç° MVCC | ğŸ”´ å¿…é¡» |
| âœ… ç†è§£äºŒé˜¶æ®µæäº¤ | ä¿è¯ä¸»ä»ä¸€è‡´ | ğŸŸ¡ æ¨è |
| âœ… ç†è§£è¡Œé”ä¸é—´éš™é” | é˜²æ­¢å¹»è¯» | ğŸ”´ å¿…é¡» |
| âœ… é¿å…é•¿äº‹åŠ¡ | é˜²æ­¢é”ç­‰å¾…ã€undo log è†¨èƒ€ | ğŸ”´ å¿…é¡» |
| âœ… ç†è§£ MVCC åŸç† | å®ç°é«˜å¹¶å‘è¯»å†™ | ğŸŸ¡ æ¨è |
| âœ… æŸ¥è¯¢å¿…é¡»èµ°ç´¢å¼• | é¿å…è¡Œé”é€€åŒ–ä¸ºè¡¨é” | ğŸ”´ å¿…é¡» |

---

## å‚è€ƒèµ„æ–™

- MySQL å®˜æ–¹æ–‡æ¡£ - InnoDB Locking
- ã€ŠMySQL æŠ€æœ¯å†…å¹•ï¼šInnoDB å­˜å‚¨å¼•æ“ã€‹
- ã€Šé«˜æ€§èƒ½ MySQLã€‹
